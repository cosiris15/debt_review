"""
LLM Configuration and Prompt Templates

Configures DeepSeek (OpenAI-compatible) as the LLM backend.
Supports dynamic knowledge loading from the centralized knowledge management system.
"""

from langchain_openai import ChatOpenAI
from langchain_core.messages import SystemMessage, HumanMessage
from typing import Dict, Any, Optional, List
import logging

from app.core.config import settings
from app.knowledge import get_knowledge_manager

logger = logging.getLogger(__name__)


def get_llm() -> ChatOpenAI:
    """
    Get configured LLM instance.

    Uses DeepSeek API with OpenAI-compatible interface.
    """
    return ChatOpenAI(
        model=settings.DEEPSEEK_MODEL,
        openai_api_key=settings.DEEPSEEK_API_KEY,
        openai_api_base=settings.DEEPSEEK_BASE_URL,
        temperature=0.1,  # Low temperature for consistent output
        max_tokens=8000,  # Enough for detailed reports
    )


# ============== Dynamic System Prompt Builder ==============

async def build_system_prompt(
    stage: str,
    bankruptcy_date: str,
    token_budget: int = 4000,
    include_advanced: bool = False
) -> str:
    """
    Dynamically build system prompt by loading knowledge from KnowledgeManager.

    Args:
        stage: Workflow stage (fact_check, analysis, report)
        bankruptcy_date: Bankruptcy filing date
        token_budget: Maximum tokens for knowledge content
        include_advanced: Include legal_standards (advanced knowledge)

    Returns:
        Complete system prompt with dynamic knowledge
    """
    km = get_knowledge_manager()

    # Load knowledge for this stage
    knowledge_items = await km.get_knowledge_for_stage(
        stage=stage,
        token_budget=token_budget,
        include_advanced=include_advanced
    )

    # Format knowledge content
    knowledge_content = km.format_for_prompt(knowledge_items, format_type='full')

    # Build base prompt
    base_prompt = f"""你是一位专业的破产债权审查专家。你的任务是协助审查债权人提交的债权申报材料。

关键日期：
- 破产受理日期：{bankruptcy_date}
- 停止计息日期：破产受理日前一日

注意事项：
- 严格基于材料内容进行分析，不得编造信息
- 金额计算必须精确，使用四舍五入
- 日期格式统一使用 YYYY-MM-DD

=== 审查知识库 ===

{knowledge_content}

=== 工作阶段 ===

"""

    return base_prompt


async def get_fact_check_system(bankruptcy_date: str) -> str:
    """Get system prompt for fact-check stage with dynamic knowledge."""
    base = await build_system_prompt(
        stage="fact_check",
        bankruptcy_date=bankruptcy_date,
        token_budget=3000,
        include_advanced=False
    )

    stage_specific = """你当前的任务是【事实核查】阶段。

工作内容：
1. 提取债权申报书中的基本信息（债权人、债务人、申报金额）
2. 整理证据材料清单
3. 建立基本法律关系（借款、货款、担保等）
4. 梳理时间线

输出格式要求：
- 使用中文数字标题（一、二、三...）
- 不使用 Markdown 标题语法（## ）
- 金额使用逗号分隔（如：1,234,567.89元）
"""
    return base + stage_specific


async def get_analysis_system(bankruptcy_date: str) -> str:
    """Get system prompt for analysis stage with dynamic knowledge."""
    base = await build_system_prompt(
        stage="analysis",
        bankruptcy_date=bankruptcy_date,
        token_budget=4000,
        include_advanced=True  # Include legal standards for analysis
    )

    stage_specific = """你当前的任务是【债权分析】阶段。

工作内容：
1. 分析各项债权金额（本金、利息、违约金等）
2. 验证计算过程
3. 确定诉讼时效状态
4. 给出确认/暂缓/不予确认的建议

分析原则：
- 利息计算必须使用计算器工具，禁止手动计算
- 适用就低原则和就无原则
- 长期借款使用5年期LPR，短期借款使用1年期LPR

【重要】利息计算请求格式：
当需要计算利息时，请在报告中使用以下格式标记计算请求，系统将自动调用计算器执行：

【利息计算】本金: 金额, 起始日: YYYY-MM-DD, 类型: lpr/simple/delay, 倍数: 1.0

支持的计算类型：
- lpr: LPR浮动利率计算（需指定倍数，如1.0、1.3、1.5）
- simple: 固定利率计算（需指定利率，如: 利率: 4.35）
- delay: 迟延履行利息（自动使用1.75倍LPR）
- penalty: 罚息计算（需指定利率，上限24%）

示例：
【利息计算】本金: 1000000, 起始日: 2023-01-15, 类型: lpr, 倍数: 1.3
【利息计算】本金: 500000, 起始日: 2022-06-01, 类型: simple, 利率: 6.0

输出格式要求：
- 使用中文数字标题（一、二、三...）
- 包含详细的计算过程说明
- 明确列出确认金额和不予确认金额
"""
    return base + stage_specific


async def get_report_system(bankruptcy_date: str) -> str:
    """Get system prompt for report stage with dynamic knowledge."""
    base = await build_system_prompt(
        stage="report",
        bankruptcy_date=bankruptcy_date,
        token_budget=2000,
        include_advanced=False
    )

    stage_specific = """你当前的任务是【报告整理】阶段。

工作内容：
1. 整合事实核查报告和债权分析报告
2. 生成标准化的审查意见表
3. 确保格式合规

格式要求（零容忍）：
- 不使用 Markdown 标题语法（## ）- 使用中文数字（一、二、三）
- 不使用 bullet 列表（- ）- 使用完整句子
- 不使用加粗语法（** ）
- 报告应读起来像正式法律文书
"""
    return base + stage_specific


# ============== Legacy Static Prompts (for backward compatibility) ==============

SYSTEM_PROMPT_BASE = """你是一位专业的破产债权审查专家。你的任务是协助审查债权人提交的债权申报材料。

核心原则：
1. 就低原则：当计算结果 > 申报金额时，以申报金额为准
2. 就无原则：债权人未申报的项目不予确认
3. 证据层级：法律文书 > 双方确认文件 > 合同 > 单方证据

关键日期：
- 破产受理日期：{bankruptcy_date}
- 停止计息日期：破产受理日前一日

注意事项：
- 严格基于材料内容进行分析，不得编造信息
- 金额计算必须精确，使用四舍五入
- 日期格式统一使用 YYYY-MM-DD
"""


FACT_CHECK_SYSTEM = SYSTEM_PROMPT_BASE + """

你当前的任务是【事实核查】阶段。

工作内容：
1. 提取债权申报书中的基本信息（债权人、债务人、申报金额）
2. 整理证据材料清单
3. 建立基本法律关系（借款、货款、担保等）
4. 梳理时间线

输出格式要求：
- 使用中文数字标题（一、二、三...）
- 不使用 Markdown 标题语法（## ）
- 金额使用逗号分隔（如：1,234,567.89元）
"""


ANALYSIS_SYSTEM = SYSTEM_PROMPT_BASE + """

你当前的任务是【债权分析】阶段。

工作内容：
1. 分析各项债权金额（本金、利息、违约金等）
2. 验证计算过程
3. 确定诉讼时效状态
4. 给出确认/暂缓/不予确认的建议

分析原则：
- 利息计算必须使用计算器工具，禁止手动计算
- 适用就低原则和就无原则
- 长期借款使用5年期LPR，短期借款使用1年期LPR

【重要】利息计算请求格式：
当需要计算利息时，请在报告中使用以下格式标记计算请求，系统将自动调用计算器执行：

【利息计算】本金: 金额, 起始日: YYYY-MM-DD, 类型: lpr/simple/delay, 倍数: 1.0

支持的计算类型：
- lpr: LPR浮动利率计算（需指定倍数，如1.0、1.3、1.5）
- simple: 固定利率计算（需指定利率，如: 利率: 4.35）
- delay: 迟延履行利息（自动使用1.75倍LPR）
- penalty: 罚息计算（需指定利率，上限24%）

示例：
【利息计算】本金: 1000000, 起始日: 2023-01-15, 类型: lpr, 倍数: 1.3
【利息计算】本金: 500000, 起始日: 2022-06-01, 类型: simple, 利率: 6.0

输出格式要求：
- 使用中文数字标题（一、二、三...）
- 包含详细的计算过程说明
- 明确列出确认金额和不予确认金额
"""


REPORT_SYSTEM = SYSTEM_PROMPT_BASE + """

你当前的任务是【报告整理】阶段。

工作内容：
1. 整合事实核查报告和债权分析报告
2. 生成标准化的审查意见表
3. 确保格式合规

格式要求（零容忍）：
- 不使用 Markdown 标题语法（## ）- 使用中文数字（一、二、三）
- 不使用 bullet 列表（- ）- 使用完整句子
- 不使用加粗语法（** ）
- 报告应读起来像正式法律文书
"""


# ============== Prompt Creators ==============

async def create_fact_check_prompt_async(
    creditor_name: str,
    materials_path: str,
    bankruptcy_date: str,
    debtor_name: str,
    materials_content: str = "",
    use_dynamic_knowledge: bool = True
) -> list:
    """
    Create prompt for fact-checking stage with dynamic knowledge.

    Args:
        creditor_name: Name of the creditor
        materials_path: Path to creditor materials
        bankruptcy_date: Bankruptcy filing date
        debtor_name: Name of the debtor
        materials_content: Actual content of the materials (REQUIRED for proper analysis)
        use_dynamic_knowledge: If True, load knowledge dynamically

    Returns:
        List of messages for LLM invocation
    """
    if use_dynamic_knowledge:
        system = await get_fact_check_system(bankruptcy_date)
    else:
        system = FACT_CHECK_SYSTEM.format(bankruptcy_date=bankruptcy_date)

    # 构建包含材料内容的 human prompt - 详细版本
    if materials_content:
        human = f"""请对以下债权人的申报材料进行【事实核查】，生成完整的事实核查报告。

=== 基本信息 ===
债权人名称：{creditor_name}
债务人名称：{debtor_name}
破产受理日期：{bankruptcy_date}
停止计息日期：{bankruptcy_date} 前一日

=== 债权申报材料内容 ===

{materials_content}

=== 材料内容结束 ===

=== 输出要求（必须严格遵守） ===

请生成完整的《{creditor_name}事实核查报告》，必须包含以下全部章节：

# {creditor_name}事实核查报告

## 一、申报情况

### 1.1 债权人基本信息
（从材料中提取以下信息，缺失项标注[债权人未填写]）
- 债权人全称：
- 企业类型：
- 注册地址：
- 法定代表人：
- 职务：
- 统一社会信用代码：
- 联系信息：

### 1.2 申报债权构成（严格照抄）
⚠️ 必须严格按照债权人在申报材料中的实际填写内容完全照抄，不得修改或概括

申报债权总额：[从材料提取]元

构成明细（按债权人实际填写内容照抄）：
- 本金（求偿权）：[金额]元
- 利息金额：[金额]元
  - 起止时间：[从材料提取]
  - 计算基数：[从材料提取]
  - 利率：[从材料提取]
  - 计算依据：[从材料提取]
- 其他损失：[从材料提取各项]

【分笔债权本金明细-关键信息】
⚠️ 如果存在多份债权申报表或多笔独立债权，必须分别记录每笔债权的本金：
- 第一笔债权本金：[从第一份申报表提取]元（债权性质：[有财产担保/普通债权]）
- 第二笔债权本金：[从第二份申报表提取]元（债权性质：[有财产担保/普通债权]）
- ...

提示：多笔债权的识别标志：
1. 存在多份债权申报表
2. 材料分为"有财产担保债权"和"普通债权"两份文件
3. 债权人明确标注"申报两笔债权"
4. 债务人在不同债权中有不同法律地位（主债务人 vs 保证人）

### 1.3 债权性质分类（严格照抄）
按债权人实际勾选/填写内容照抄

### 1.4 担保情况（严格照抄）
- 有财产担保或优先权：[从材料提取，未填写标注"债权人未填写"]
- 担保标的物：[从材料提取]
- 担保物价值：[从材料提取]

### 1.5 法律程序情况（严格照抄）
- 是否经法院（仲裁机构）裁决：[是/否]
- 执行情况：[案号、法院、标的等]

## 二、形式性文件核查

请根据材料内容，完成以下核查表：

| 文件类型 | 齐 | 缺 | 无需 | 备注 |
|---------|----|----|------|------|
| 债权申报材料目录 | | | | |
| 债权申报表 | | | | |
| 债权申报书 | | | | |
| 营业执照/身份证件复印件 | | | | |
| 法定代表人身份证明书原件 | | | | |
| 法定代表人身份证件复印件 | | | | |
| 授权委托书 | | | | |
| 代理人身份证明复印件 | | | | |
| 律师证及所函 | | | | |
| 送达地址及银行账户确认书 | | | | |
| 债权诚信申报承诺函 | | | | |
| 境外债权人材料 | | | | |

## 三、债权发生情况查明（核心内容）

⚠️ 这是报告的核心部分，必须详细完整。时间线必须按时间顺序包含所有关键事件。

### 时间线事件类型清单（必须全部核查并记录）

1. **合同签订类事件**：合同签订日期、合同编号、双方当事人
2. **履行类事件**：付款日期及金额、交付日期、验收日期
3. **违约类事件**：逾期开始日期、违约通知日期
4. **诉讼类事件**：
   - 起诉日期（立案日期）
   - 财产保全申请日期及保全措施
   - 开庭审理日期
   - 判决/调解书作出日期
   - 判决生效日期（如材料载明）
5. **执行类事件**：
   - 执行申请日期
   - 账户冻结/财产查封日期
   - 执行终结/终本日期
6. **破产类事件**：破产受理日期、债权申报日期

| 序号 | 日期 | 债权发生情况 |
|------|------|-------------|
| 1. | [日期] | 根据[证据名称]（证据第X页），[详细描述事件]。【如为合同，需包含9项核心条款：1.标的物 2.合同价款 3.履行期限 4.交付与验收 5.付款方式（完整原文） 6.违约责任 7.发票要求 8.争议解决 9.其他关键约定】 |
| 2. | [日期] | 根据[证据名称]（证据第X页），[详细描述]。【如为法律文书（判决书/调解书），必须完整摘录"判决如下："或"达成如下协议："的全部内容，逐字摘录，不得概括】 |
| ... | ... | ... |

**法律文书摘录要求（必须严格遵守）**：
- 判决书：必须完整摘录"判决如下："部分的全部内容，包括各项判决主文和诉讼费用负担
- 调解书：必须完整摘录"达成如下协议："部分的全部内容
- 裁定书：必须完整摘录"裁定如下："部分的全部内容，并摘录裁定理由
- 执行裁定书：必须摘录执行标的、执行措施、终结原因
- 使用引号标注摘录内容，保持原文标点和格式

**特别注意**：
- 不要遗漏财产保全告知书、账户冻结通知书等程序性文书
- 执行过程中的每个重要节点都要记录（立案、查封、冻结、终本等）

## 四、债权基础法律关系识别

**债权基础法律关系识别结果：**
- 独立债权关系数量：[X]个
- 一级分类：[合同类/法律文书类/其他]
- 二级分类：[具体类型，如：买卖合同纠纷/借款合同纠纷/建设工程合同纠纷等]
- 识别清单：
  1. [关系1：具体描述]
  2. [关系2：如有]

**法律关系地位识别：**
- 债权人法律地位：[描述债权人在法律关系中的地位]
- 债务人法律地位：[描述债务人在法律关系中的地位]
- 担保人：[如有]
- 法律关系性质：[描述基础法律关系性质]

## 五、证据关系综合分析

### 5.1 最终债权确定
基于本案全部证据材料，最终债权以[具体文件名称]为准，确定债权本金为[X]元，利息按[计算标准]计算（自[起算日期]起至[截止日期]止，计算标准为[具体利率/LPR倍数]），其他费用包括[列明]。

### 5.2 证据效力关系分析
根据证据效力层级原则（生效法律文书 > 双方确认文件 > 合同 > 单方证据），本案中[最高效力证据名称]具有最高法律效力，因为[说明原因]。

该证据确认了：
1. [确认事项1]
2. [确认事项2]
3. [确认事项3]

### 5.3 需要特别关注的事项
1. [事项1：如合同原件缺失等]
2. [事项2：如付款凭证缺失等]
3. [事项3：如利息计算期间需核实等]

### 5.4 证据材料完整性评估

**已提供的证据材料：**
1. [证据1名称]（完整/不完整）
2. [证据2名称]（完整/不完整）

**缺失的基础证据材料：**
1. [缺失证据1]
2. [缺失证据2]

**对债权审查的影响：**
[说明缺失证据对债权认定的影响程度]

## 六、向债权分析员的移交说明

### 重点提示：

1. **法律文书效力**：[说明本案最终依据的法律文书]

2. **债权金额确定**：
   - 本金：[金额]元（依据：[来源]）
   - 利息计算标准：[具体标准，如"以XX元为基数，自XXXX年X月X日起至实际清偿之日止，按同期LPR的X倍计付"]
   - 其他费用：[列明各项及依据]

3. **利息计算的关键日期**：
   - 起诉日期/合同签订日期：[日期]
   - 判决作出日期：[日期]
   - 判决生效日期：[日期，如未载明注明]
   - 判决确认利息截止日期：[日期，如判决书载明"截至YYYY年M月D日利息为X元"]
   - 执行立案日期：[日期，如有]
   - 破产受理日期：{bankruptcy_date}
   - 停止计息日期：{bankruptcy_date}前一日

4. **判决确认利息的关键信息（如有）**：
   ⚠️ 判决书通常将利息分为两部分：
   - 判决截止日前已确认利息：[金额]元（截至[日期]）
   - 判决截止日后利息计算：从[日期]起至清偿日按[利率标准]计算

   🔴 银团贷款案件特别注意：
   - 银团总利息（截止判决日）：[金额]元
   - 申报人份额比例：[X]%
   - 申报人份额内截止日前利息：[总利息] × [份额比例] = [金额]元
   - 申报人份额内截止日后利息：需要从判决截止日起至破产受理日按约定利率继续计算

5. **迟延履行利息计算要点**：
   - 债权人申报迟延履行利息[金额]元
   - 起算时点：[判决生效后X日届满之次日]
   - 终止时点：破产受理日前一日
   - 需核实申报金额是否准确

6. **最高额担保限额（如有）**：
   ⚠️ 如判决确认保证人在最高额X元范围内承担保证责任：
   - 最高额担保限额：[金额]元
   - 本笔债权计算总额（本金+利息+费用）：[金额]元
   - 是否超过限额：[是/否]
   - 如超过限额：应按最高额封顶确认为[限额金额]元

7. **执行程序情况**：[说明执行进展]

8. **法律关系性质判断**：
   - 基础法律关系：[类型]
   - 无担保/有担保：[说明]
   - 债权性质：[普通债权/优先债权等]

9. **就低原则的适用**：
   - 债权人申报的本金[金额]元与[依据]一致/不一致
   - 如计算结果高于申报金额，以申报金额为准
   - 如计算结果低于申报金额，以计算结果为准

10. **特别注意事项**：
   - [需要分析员特别关注的问题]

11. **证据补充建议**：
   - [如需补充证据的建议]

12. **债权确认建议的初步判断**：
    - 本金[金额]元：[应予确认/待核实]（依据：[来源]）
    - 利息：需计算后确定（计算标准：[标准]）
    - 其他费用[金额]元：[应予确认/待核实]

---
报告生成日期：{bankruptcy_date}
负责人：事实核查员

=== 报告格式强制要求 ===
1. 必须包含上述全部六个章节
2. 金额必须引用材料原文，禁止编造
3. 缺失信息使用标准标记：[债权人未填写]、[证据未记载]、[材料未提供]
4. 法律文书必须逐字摘录判决/调解内容
5. 时间线表格中每个事实必须注明证据来源和页码
6. 移交说明必须包含10个重点提示
"""
    else:
        # 后备方案：没有材料内容时的提示（不应发生）
        human = f"""请对以下债权人的申报材料进行事实核查：

债权人名称：{creditor_name}
债务人名称：{debtor_name}
材料路径：{materials_path}
破产受理日期：{bankruptcy_date}

【警告】未能读取材料内容，请基于已知信息尽可能分析。

请按照以下结构输出事实核查报告：

一、基本信息
（债权人、债务人、联系方式等）

二、申报金额概况
（本金、利息、违约金分项列明）

三、证据材料清单
（按时间顺序列明所有材料）

四、法律关系分析
（识别基础法律关系类型）

五、时间线梳理
（重要事件按时间排列）

六、初步发现
（需要在分析阶段重点关注的问题）
"""

    return [
        SystemMessage(content=system),
        HumanMessage(content=human)
    ]


def create_fact_check_prompt(
    creditor_name: str,
    materials_path: str,
    bankruptcy_date: str,
    debtor_name: str
) -> list:
    """Create prompt for fact-checking stage (legacy sync version)."""

    system = FACT_CHECK_SYSTEM.format(bankruptcy_date=bankruptcy_date)

    human = f"""请对以下债权人的申报材料进行事实核查：

债权人名称：{creditor_name}
债务人名称：{debtor_name}
材料路径：{materials_path}
破产受理日期：{bankruptcy_date}

请按照以下结构输出事实核查报告：

一、基本信息
（债权人、债务人、联系方式等）

二、申报金额概况
（本金、利息、违约金分项列明）

三、证据材料清单
（按时间顺序列明所有材料）

四、法律关系分析
（识别基础法律关系类型）

五、时间线梳理
（重要事件按时间排列）

六、初步发现
（需要在分析阶段重点关注的问题）
"""

    return [
        SystemMessage(content=system),
        HumanMessage(content=human)
    ]


async def create_analysis_prompt_async(
    creditor_name: str,
    fact_check_report: str,
    bankruptcy_date: str,
    interest_stop_date: str,
    declared_amounts: Dict[str, Optional[float]],
    use_dynamic_knowledge: bool = True
) -> list:
    """
    Create prompt for analysis stage with dynamic knowledge.

    Args:
        creditor_name: Name of the creditor
        fact_check_report: Output from fact-checking stage
        bankruptcy_date: Bankruptcy filing date
        interest_stop_date: Date to stop interest calculation
        declared_amounts: Claimed amounts from creditor
        use_dynamic_knowledge: If True, load knowledge dynamically

    Returns:
        List of messages for LLM invocation
    """
    if use_dynamic_knowledge:
        system = await get_analysis_system(bankruptcy_date)
    else:
        system = ANALYSIS_SYSTEM.format(bankruptcy_date=bankruptcy_date)

    amounts_str = ""
    if declared_amounts.get("principal"):
        amounts_str += f"- 本金：{declared_amounts['principal']:,.2f}元\n"
    if declared_amounts.get("interest"):
        amounts_str += f"- 利息：{declared_amounts['interest']:,.2f}元\n"
    if declared_amounts.get("total"):
        amounts_str += f"- 合计：{declared_amounts['total']:,.2f}元\n"

    human = f"""请对以下债权进行详细分析：

债权人名称：{creditor_name}
破产受理日期：{bankruptcy_date}
停止计息日期：{interest_stop_date}

申报金额：
{amounts_str if amounts_str else "（待从材料中提取）"}

事实核查报告：
{fact_check_report}

# ⚠️ 核心审查原则（必须严格遵守）

## 一、确认/暂缓确认判断规则（最重要！）

### 1.1 应当"暂缓确认"的情形

⚠️ **存在以下任一情形时，必须得出"暂缓确认"结论**：

1. **无生效法律文书**：案件未经法院或仲裁机构裁决，仅有合同、起诉状等材料
2. **关键证据缺失**：
   - 合同纠纷：缺乏结算单据、付款记录、发票、对账单
   - 借款纠纷：缺乏借款凭证、转账记录
   - 货款纠纷：缺乏送货单、验收单、付款记录
3. **申报金额与证据不一致**：申报金额与起诉状/合同金额存在重大差异且未说明
4. **附条件债权**：律师费约定"败诉方承担"但案件未判决

### 1.2 可以"确认"的情形

✅ **同时满足以下条件时，可以确认债权**：

1. 有生效法律文书（判决书/调解书/仲裁裁决书），或
2. 有公司章程、股东会决议等法定文件确认的股东出资义务（适用破产法第35条）
3. 证据链完整，无重大缺失
4. 申报金额与证据金额一致或可以合理解释

### 1.3 暂缓确认的处理方式

当决定"暂缓确认"时，报告必须包含：

1. **暂缓确认理由**（逐条列明）
2. **证据补充建议**（需要债权人补充的材料清单）
3. **临时建议确认金额**（如管理人需要基于现有证据进行临时确认，给出可以确认的最低金额）

## 二、就无原则（债权审查核心原则）

🔴 **"就无原则"的含义**：债权审查是对债权人申报债权的审查，而非主动为债权人计算或确认债权。债权人未申报的项目，即使合同有约定，也不予确认。

**适用场景示例**：
- 合同约定违约金，但债权人未在申报表中申报违约金 → 根据就无原则，不予确认
- 合同约定利息，但债权人填写"详见附件"却未提供附件 → 根据就无原则，不予确认
- 版权费、设计费等有合同约定但未明确申报具体金额 → 根据就无原则，不予确认

**报告中必须使用的表述格式**：
"根据就无原则（债权人未申报的项目不予确认），[项目名称]不予确认。"

## 三、就低原则

当计算结果 > 债权人申报金额时，以申报金额为准确认
示例：申报50万，计算80万 → 确认50万

**报告中必须使用的表述格式**：
"根据就低原则，按[申报金额/计算结果]确认[X]元。"

## 四、特殊案件类型的法律依据

### 4.1 股东出资义务案件

**必须引用的法律依据**：
- 《中华人民共和国企业破产法》第三十五条："人民法院受理破产申请后，债务人的出资人尚未完全履行出资义务的，管理人应当要求该出资人缴纳所认缴的出资，而不受出资期限的限制。"
- 《中华人民共和国公司法》关于股东出资义务的规定

**审查要点**：
1. 即使出资期限未届满，破产后出资义务加速到期
2. 如约定违约金但债权人未申报，根据就无原则不予确认
3. 债权性质：普通债权

### 4.2 服务合同/运营管理合同纠纷案件

**审查要点**：
1. 固定报酬、版权费、设计费等需要结算依据
2. 合同约定"败诉方承担律师费"，案件未判决前律师费应暂缓确认
3. 如申报金额与起诉状金额不一致，需特别说明

## 五、证据完整性检查

**必须在报告中逐项核查以下证据**：

| 证据类型 | 是否提供 | 完整性 | 对债权认定的影响 |
|---------|---------|--------|-----------------|
| 生效法律文书 | 是/否 | 完整/部分/无 | [说明] |
| 合同/协议原件 | 是/否 | 完整/部分/无 | [说明] |
| 结算单据/对账单 | 是/否 | 完整/部分/无 | [说明] |
| 付款凭证/银行流水 | 是/否 | 完整/部分/无 | [说明] |
| 发票 | 是/否 | 完整/部分/无 | [说明] |
| 送货单/验收单 | 是/否 | 完整/部分/无 | [说明] |
| 催款记录/往来函件 | 是/否 | 完整/部分/无 | [说明] |

## 六、Calculator 工具强制使用

所有利息/违约金计算必须使用 Calculator 工具，严禁手工计算

# 报告输出格式（必须严格遵循）

## 一、债权基础法律关系确认

基于事实核查报告，确认：
- 独立债权关系数量：[X]个
- 具体清单：
  1. [关系1：合同名称/案号等标识]
  2. [关系2：合同名称/案号等标识]
- 法律关系性质：[合同类/法律文书类/股东出资/其他]
- **生效法律文书**：[有/无]（如有，列明案号；如无，标注"案件未经法院或仲裁机构裁决"）

## 二、证据完整性检查

（必须包含上述证据核查表格，逐项分析缺失证据对债权认定的影响）

## 三、金额项目拆解分析

### 2.1 金额项目清单

| 序号 | 项目描述 | 申报金额 | 法律性质 | 证据支持情况 | 计算需求 |
|------|----------|----------|----------|--------------|----------|
| 1 | [具体描述] | [金额]元 | 本金/利息/费用 | 有/不足/缺失 | 固定/需计算 |
| 2 | [具体描述] | [金额]元 | 本金/利息/费用 | 有/不足/缺失 | 固定/需计算 |

### 2.2 拆解说明

**债权构成的法律依据分析（每项必须详细说明）：**

1. **[本金项目名称][金额]元**
   - 法律依据：[案号]民事判决书主文第X项
   - 判决原文："[完整摘录判决书中关于该项的原文]"
   - 性质：普通债权
   - 形成原因：[详细说明债权形成的事实经过]

2. **[利息项目名称][金额]元**
   - 法律依据：[案号]民事判决书主文第X项
   - 判决原文："[完整摘录判决书中关于利息计算标准的原文]"
   - 计算期间：[起息日]至[止息日]（破产受理日前一日）
   - 计算标准：[LPR X倍 / 固定利率X% / 其他]
   - 性质：普通债权

3. **[费用项目]（如案件受理费、财产保全费等）**
   - 法律依据：[案号]民事判决书主文
   - 判决原文："[完整摘录]"
   - 性质：普通债权

4. **迟延履行利息[金额]元**
   - 法律依据：[案号]民事判决书主文第X段后
   - 判决原文："如果未按本判决指定的期间履行给付金钱义务，应当依照《中华人民共和国民事诉讼法》第二百六十条之规定，加倍支付迟延履行期间的债务利息"
   - 计算基数：[本金金额]元
   - 计算期间：判决生效后履行期届满次日至破产受理日前一日
   - 计算标准：日利率万分之1.75（加倍部分）
   - 性质：劣后债权（根据《最高人民法院关于适用〈中华人民共和国企业破产法〉若干问题的规定（二）》第二十八条）

## 三、履行期限判断

### 3.1 判决生效日期推定规则（重要）

⚠️ **如果证据材料未明确载明判决生效日期，必须采用以下保守推定方法**：

1. **一审判决**：
   - 判决作出日 + 送达时间（假定当日送达）+ 15天上诉期 = 生效日
   - 示例：判决作出日2023年6月12日 → 推定生效日2023年6月27日

2. **二审判决/终审判决**：作出之日即生效

3. **调解书**：双方签收之日生效，如未明确载明，采用调解书作出日

4. **履行期限届满日**：判决生效日 + 履行期限（如"10日内"则+10天）

5. **迟延履行利息起算日**：履行期限届满日次日

**说明**：如债权人后续补充送达回证显示实际生效日期不同，应根据实际日期重新计算迟延履行利息起算日及金额。

### 3.2 履行期限判断表

| 项目 | 履行期限 | 判决生效日(推定) | 履行期限届满日 | 迟延起算日 | 破产受理日 |
|------|----------|------------------|----------------|------------|------------|
| [项目名称] | [判决生效后X日] | [YYYY-MM-DD] | [YYYY-MM-DD] | [YYYY-MM-DD] | {bankruptcy_date} |

### 3.3 起息日确定
- 合同利息起息日：合同约定的起息日/判决确定的起息日
- 迟延履行利息起息日：履行期限届满日次日
- 止息日 = {interest_stop_date}（破产受理日前一日）

## 四、利息计算过程

### 4.1 利率类型识别与参数选择

**（一）利息损失计算**

🔴 **利率类型识别**：
- 法律文书表述："[摘录判决书中关于利息计算标准的原文]"
- 识别类型：[LPR浮动利率 / 固定利率 / 合同约定利率]
- 场景判断：[司法裁判 / 合同约定]

🔴 **参数选择依据**：
- LPR期限选择：[1年期 / 5年期以上]
- 选择理由：[说明选择依据，如：本案为买卖合同纠纷，债权性质为货款返还，非长期借款或房贷，适用1年期LPR]
- 基准天数：[365天/360天]
- 依据：[司法裁判场景使用365天（民法规定）/ 金融借款使用360天（行业惯例）]

**（二）迟延履行利息计算**

🔴 **利率类型识别**：
- 法律文书表述："应当依照《中华人民共和国民事诉讼法》第二百六十条之规定，加倍支付迟延履行期间的债务利息"
- 识别类型：日利率（固定）
- 场景判断：司法裁判（迟延履行）

🔴 **参数选择依据**：
- 日利率：万分之1.75（0.0175%）
- 选择理由：《民事诉讼法》第260条规定的加倍部分债务利息标准
- 基准天数：不适用（日利率直接计算）
- 依据：最高人民法院司法解释

### 4.2 计算参数格式

**固定金额类项目**：
（X）[项目名称]：[确定金额]元；

**借贷类合同利息（固定利率）**：
（X）[项目名称]：以[计算基数]元为计算基数，自[起息日]起至[止息日]止，按[年利率]%的年利率计算（基准天数[360/365]天），计算可得共[]元；

**借贷类合同利息（LPR浮动利率）**：
（X）[项目名称]：以[计算基数]元为计算基数，自[起息日]起至[止息日]止，按[LPR期限类型]LPR的[倍数]倍计算（基准天数[360/365]天），计算可得共[]元；

**迟延履行期间债务利息**：
（X）迟延履行期间的加倍部分债务利息：以[计算基数]元为计算基数，自[起息日]（履行期限届满日次日）至[止息日]（破产受理日前一日），以日利率万分之1.75为利率，计算可得共[]元；

### 4.2 计算标记（系统将自动识别并执行计算程序）

⚠️ **重要**：所有金额计算都必须使用以下标记格式输出，系统将自动调用计算程序执行，LLM不要自行计算结果！

**1. 利息计算标记**：

【利息计算】本金: [金额], 起始日: YYYY-MM-DD, 类型: [lpr/simple/delay/compound/penalty], 倍数: [如适用], LPR期限: [1y/5y如适用], 年利率: [如适用]

示例：
- LPR计算：【利息计算】本金: 7610000, 起始日: 2023-04-25, 类型: lpr, 倍数: 1.5, LPR期限: 1y
- 迟延履行利息：【利息计算】本金: 7610000, 起始日: 2023-07-03, 类型: delay
- 固定利率：【利息计算】本金: 1000000, 起始日: 2023-01-01, 类型: simple, 年利率: 6.0

**2. 份额比例计算标记（银团贷款必须使用）**：

【份额计算】总额: [银团总金额], 份额: [比例]%, 描述: [说明]

示例（银团贷款利息按份额分配）：
- 【份额计算】总额: 247674737.97, 份额: 13.95%, 描述: 判决确认银团截止2018年5月15日利息
- 【份额计算】总额: 1302547819.63, 份额: 13.95%, 描述: 银团总本金按份额计算

**3. 判决确认金额标记（直接使用已确认金额）**：

【确认金额】金额: [判决确认的金额], 来源: [案号], 描述: [说明]

示例：
- 【确认金额】金额: 15251650.28, 来源: (2018)鄂72民初1270号, 描述: 判决确认的违约金
- 【确认金额】金额: 765821.46, 来源: (2018)鄂72民初1270号, 描述: 判决确认的补偿金

**4. 最高额限额封顶检查标记（保证人最高额担保必须使用）**：

【最高额检查】计算总额: [本金+利息+费用], 最高额: [担保限额], 描述: [说明]

示例：
- 【最高额检查】计算总额: 153321209.81, 最高额: 150000000, 描述: 江苏熔盛重工在最高额1.5亿元范围内承担保证责任

### 4.3 计算结果汇总表

| 计算基数 | 起息日 | 止息日 | 计算天数 | 计算结果 | 备注 |
|----------|--------|--------|----------|----------|------|
| [金额]元 | [日期] | [日期] | [X]天 | [金额]元 | [说明] |
| **合计** | | | | **[总额]元** | |

**与申报金额对比**：
- 申报金额：[X]元
- 计算结果：[X]元
- 按"就低原则"：确认[X]元（取较低值）

## 五、诉讼时效分析

### 5.1 时效判断
- 起算时点：[日期及依据]
- 适用时效期间：[2年/3年]
- 中断/中止情况：[有/无，具体说明]
- 最终届满日：[日期]
- 债权申报日：[日期]
- 时效结论：**未超过/已超过诉讼时效**

### 5.2 详细说理
（完整的诉讼时效分析过程）

## 六、执行时效分析
（仅对基于生效法律文书的债权适用）

### 6.1 执行时效判断
- 执行依据：[（案号）判决书/调解书/仲裁裁决书]
- 履行期限：[判决生效之日起X日内]
- 判决生效日：[YYYY-MM-DD]（推定）
- 履行期限届满日：[YYYY-MM-DD]
- 时效起算：[YYYY-MM-DD]（履行期限届满次日）
- 执行申请时间：[YYYY-MM-DD]（在执行时效期间内/外）
- 中断事由：[有/无]
  - 如有：[债权人于XXXX年XX月XX日申请执行，执行时效中断]
- 执行程序终结：[YYYY-MM-DD]（终结本次执行程序/终结执行）
- 破产申报时间：[YYYY-MM-DD]（在执行时效期间内/外）
- 最终届满：[YYYY-MM-DD]（从履行期限届满日起算2年）
- 分析结论：**[未超过/已超过]执行时效**

### 6.2 详细说理

根据《中华人民共和国民事诉讼法》第二百三十九条规定，申请执行的期间为二年。申请执行时效的中止、中断，适用法律有关诉讼时效中止、中断的规定。

本案中：
1. **执行时效起算时点**：判决确定的履行期限届满之日（[日期]）次日即[日期]
2. **执行时效期间**：2年（至[日期]）
3. **中断事由**：[债权人于XXXX年XX月XX日向法院申请执行，执行时效中断 / 无中断事由]
4. **执行程序终结**：[日期]，法院作出[案号]执行裁定书，裁定"[终结本次执行程序/终结执行]"。[裁定理由]，该裁定[并非终结执行，仅为终结本次执行程序，不影响执行时效 / 为终结执行]
5. **破产程序中申报债权**：债权人于[日期]向管理人申报债权，[视为继续主张权利，执行时效再次中断 / 已超过执行时效]
6. **结论**：[债权人在执行时效期间内申请执行并在破产程序中申报债权，执行时效未届满 / 执行时效已届满]

**特别说明**：
- 执行裁定书明确载明"申请执行人发现被执行人有可供执行财产的，可以再次申请执行"，债务人仍负有继续履行义务
- 破产程序中债权申报视为权利主张，执行时效持续中断
- 本债权在破产程序中申报，[符合/不符合]执行时效要求

## 七、审查确认情况

### 7.1 申报与确认对比表

| 项目 | 申报金额 | 确认金额 | 性质 | 确认说明 |
|------|----------|----------|------|----------|
| 本金 | [金额]元 | [金额]元 | 普通/优先/劣后债权 | [说明] |
| 利息 | [金额]元 | [金额]元 | 普通/劣后债权 | [说明] |
| 费用 | [金额]元 | [金额]元 | 普通债权 | [说明] |
| **合计** | **[总额]元** | **[总额]元** | | |

### 7.2 债权性质确认
- 优先债权：[金额]元（如有担保物权等）
- 普通债权：[金额]元
- 劣后债权：[金额]元（迟延履行利息等破产受理后产生的）

## 八、审查结论

### 8.1 审查结论类型判断

⚠️ **请根据以下条件判断审查结论类型**：

**（一）如存在以下任一情形，结论为"暂缓确认"**：
- 无生效法律文书（判决书/调解书/仲裁裁决书），且不属于股东出资类债权
- 关键证据缺失（结算单据、付款记录、对账单等）
- 申报金额与证据金额存在重大不一致且未说明
- 附条件债权条件未满足（如"败诉方承担律师费"但案件未判决）

**（二）如满足以下条件，结论为"确认"**：
- 有生效法律文书确认债权，或
- 股东出资类债权，有公司章程/股东会决议确认
- 证据链完整
- 金额可核实

### 8.2 审查结论

**【确认】模板（适用于有生效法律文书或股东出资类债权）**：

经审查：
- 申报债权总额：[金额]元
- 确认债权总额：[金额]元
  - 优先债权：[金额]元
  - 普通债权：[金额]元
  - 劣后债权：[金额]元

**【暂缓确认】模板（适用于无生效法律文书的合同纠纷案件）**：

经审查，建议**暂缓确认**。

**暂缓确认理由**：
1. [理由1：如"案件未经法院或仲裁机构裁决，仅有民事起诉状，无判决书、调解书或裁定书"]
2. [理由2：如"关键证据缺失，债权人未提供付款记录、结算单据、对账单等"]
3. [理由3：如"申报金额与起诉状金额不一致，差额未明确说明"]
4. [理由4：如"律师费确认条件未满足，合同约定败诉方承担但案件未判决"]

**证据补充建议**：
要求债权人补充提供以下材料：
1. [材料1：如"法院生效裁判文书"]
2. [材料2：如"已付款项的付款记录"]
3. [材料3：如"双方确认的结算单据或对账单"]
4. [材料4：如"申报金额与起诉状金额差额的构成说明"]
5. [材料5：如"发票开具记录"]

**临时建议确认金额**：
如管理人认为有必要基于现有证据进行临时确认，建议确认金额为：
- [项目1]：[金额]元（依据：[来源，如"起诉状主张金额"]）
- [项目2]：[金额]元（依据：[来源]）
- 其他项目：0元（根据就无原则不予确认）
- **临时建议确认总额**：[金额]元（普通债权）

⚠️ 特别说明：此临时确认金额仅基于现有证据，缺乏充分证据支持，最终确认金额应以法院生效裁判文书或债权人补充完整证据后的审查结果为准。

---

**【股东出资类债权确认】模板**：

经审查：
- 申报债权总额：[金额]元
- 确认债权总额：[金额]元
  - 优先债权：0元
  - 普通债权：[金额]元
  - 劣后债权：0元

根据《中华人民共和国企业破产法》第三十五条规定："人民法院受理破产申请后，债务人的出资人尚未完全履行出资义务的，管理人应当要求该出资人缴纳所认缴的出资，而不受出资期限的限制。"

本案债务人作为股东尚有[金额]元出资义务未履行，管理人有权要求其缴纳。虽然公司章程/增资协议约定了违约金，但债权人未申报违约金，根据就无原则（债权人未申报的项目不予确认），违约金不予确认。

---

### 8.3 确认明细（仅"确认"类结论需要）

1. **[本金项目]**：申报[X]元，确认[X]元（[普通债权]）
   - 依据：[案号]民事判决书主文第X项
   - 说明：[与申报一致，全额确认 / 按计算结果确认]

2. **[利息项目]**：申报[X]元，确认[X]元（[普通债权]）
   - 依据：[案号]民事判决书主文第X项
   - 计算期间：[起息日]至[止息日]（[X]天）
   - 计算标准：[LPR X倍 / 固定利率X%]
   - 说明：经calculator工具验算，计算结果[X]元[低于/高于]申报金额[X]元，按[计算结果/申报金额]确认

3. **[费用项目]**：申报[X]元，确认[X]元（[普通债权]）
   - 依据：[案号]民事判决书主文
   - 说明：与申报一致，全额确认

4. **[迟延履行利息]**：申报[X]元，确认[X]元（[劣后债权]）
   - 依据：《民事诉讼法》第260条及判决书主文
   - 计算基数：[X]元
   - 计算期间：[起息日]至[止息日]（[X]天）
   - 计算标准：日利率万分之1.75
   - 说明：经calculator工具验算，计算结果[X]元[低于/高于]申报金额[X]元，按[计算结果/申报金额]确认（就低原则）；性质为劣后债权

### 确认结果汇总

- **确认债权总额**：[X]元
  - **优先债权**：[X]元
  - **普通债权**：[X]元
  - **劣后债权**：[X]元

### 调整说明

申报总额与确认总额差额：[申报额] - [确认额] = [差额]元

差额原因：[利息损失/迟延履行利息]经计算验证后调[增/减][X]元（申报[X]元，确认[X]元）

### 特别说明

1. **关于利息损失的计算差异**：债权人申报利息[X]元，经calculator工具按判决确定的标准（[计算标准]）重新计算，[起息日]至[止息日]期间利息为[X]元，两者相差[X]元。根据就低原则，按[计算结果/申报金额]确认[X]元。

2. **关于迟延履行利息的计算差异**：债权人申报迟延履行利息[X]元，经calculator工具按法定标准（日利率万分之1.75）重新计算，[起息日]至[止息日]期间迟延履行利息为[X]元，计算结果[高于/低于]申报金额[X]元。根据就低原则，按[申报金额/计算结果]确认[X]元。

3. **关于判决生效日期的说明**：由于债权人未提供判决书送达回证，本报告采用保守推定判决生效日期为[推定日期]（判决作出后15日）。如后续补充送达回证显示实际生效日期不同，应根据实际日期重新计算迟延履行利息起算日及金额。

4. **关于执行时效的说明**：本债权基于生效判决，债权人在执行时效期间内申请执行并在破产程序中申报债权，执行时效未届满。执行程序虽已终结本次执行，但不影响债权的存在和破产程序中的申报。

5. **关于劣后债权的依据**：根据《最高人民法院关于适用〈中华人民共和国企业破产法〉若干问题的规定（二）》第二十八条规定："债务人欠缴款项产生的滞纳金，包括债务人未履行生效法律文书应当加倍支付的迟延履行期间的债务利息，债权人作为破产债权申报的，人民法院应予受理。上述债权，应当在破产债权中劣后于普通债权顺序清偿。"因此，迟延履行期间的加倍部分债务利息应确认为劣后债权。

---

# ⚠️ 禁止事项

1. **禁止手工计算**：所有利息计算必须使用【利息计算】标记，由系统自动执行
2. **禁止推测参数**：如LPR期限不明确，标记为"[参数缺失,无法计算]"
3. **禁止估算**：不得使用"约"、"大概"等模糊表述
4. **禁止添加未申报项**：就无原则 - 未申报则不予确认
5. **禁止虚构数据**：所有数据必须有证据支持
"""

    return [
        SystemMessage(content=system),
        HumanMessage(content=human)
    ]


def create_analysis_prompt(
    creditor_name: str,
    fact_check_report: str,
    bankruptcy_date: str,
    interest_stop_date: str,
    declared_amounts: Dict[str, Optional[float]]
) -> list:
    """Create prompt for analysis stage (legacy sync version)."""

    system = ANALYSIS_SYSTEM.format(bankruptcy_date=bankruptcy_date)

    amounts_str = ""
    if declared_amounts.get("principal"):
        amounts_str += f"- 本金：{declared_amounts['principal']:,.2f}元\n"
    if declared_amounts.get("interest"):
        amounts_str += f"- 利息：{declared_amounts['interest']:,.2f}元\n"
    if declared_amounts.get("total"):
        amounts_str += f"- 合计：{declared_amounts['total']:,.2f}元\n"

    human = f"""请对以下债权进行详细分析：

债权人名称：{creditor_name}
破产受理日期：{bankruptcy_date}
停止计息日期：{interest_stop_date}

申报金额：
{amounts_str if amounts_str else "（待从材料中提取）"}

事实核查报告：
{fact_check_report}

# ⚠️ 核心审查原则（必须严格遵守）

## 一、确认/暂缓确认判断规则（最重要！）

### 1.1 应当"暂缓确认"的情形

⚠️ **存在以下任一情形时，必须得出"暂缓确认"结论**：

1. **无生效法律文书**：案件未经法院或仲裁机构裁决，仅有合同、起诉状等材料
2. **关键证据缺失**：
   - 合同纠纷：缺乏结算单据、付款记录、发票、对账单
   - 借款纠纷：缺乏借款凭证、转账记录
   - 货款纠纷：缺乏送货单、验收单、付款记录
3. **申报金额与证据不一致**：申报金额与起诉状/合同金额存在重大差异且未说明
4. **附条件债权**：律师费约定"败诉方承担"但案件未判决

### 1.2 可以"确认"的情形

✅ **同时满足以下条件时，可以确认债权**：

1. 有生效法律文书（判决书/调解书/仲裁裁决书），或
2. 有公司章程、股东会决议等法定文件确认的股东出资义务（适用破产法第35条）
3. 证据链完整，无重大缺失
4. 申报金额与证据金额一致或可以合理解释

### 1.3 暂缓确认的处理方式

当决定"暂缓确认"时，报告必须包含：

1. **暂缓确认理由**（逐条列明）
2. **证据补充建议**（需要债权人补充的材料清单）
3. **临时建议确认金额**（如管理人需要基于现有证据进行临时确认，给出可以确认的最低金额）

## 二、就无原则（债权审查核心原则）

🔴 **"就无原则"的含义**：债权审查是对债权人申报债权的审查，而非主动为债权人计算或确认债权。债权人未申报的项目，即使合同有约定，也不予确认。

**适用场景示例**：
- 合同约定违约金，但债权人未在申报表中申报违约金 → 根据就无原则，不予确认
- 合同约定利息，但债权人填写"详见附件"却未提供附件 → 根据就无原则，不予确认
- 版权费、设计费等有合同约定但未明确申报具体金额 → 根据就无原则，不予确认

**报告中必须使用的表述格式**：
"根据就无原则（债权人未申报的项目不予确认），[项目名称]不予确认。"

## 三、就低原则

当计算结果 > 债权人申报金额时，以申报金额为准确认
示例：申报50万，计算80万 → 确认50万

**报告中必须使用的表述格式**：
"根据就低原则，按[申报金额/计算结果]确认[X]元。"

## 四、特殊案件类型的法律依据

### 4.1 股东出资义务案件

**必须引用的法律依据**：
- 《中华人民共和国企业破产法》第三十五条："人民法院受理破产申请后，债务人的出资人尚未完全履行出资义务的，管理人应当要求该出资人缴纳所认缴的出资，而不受出资期限的限制。"
- 《中华人民共和国公司法》关于股东出资义务的规定

**审查要点**：
1. 即使出资期限未届满，破产后出资义务加速到期
2. 如约定违约金但债权人未申报，根据就无原则不予确认
3. 债权性质：普通债权

### 4.2 服务合同/运营管理合同纠纷案件

**审查要点**：
1. 固定报酬、版权费、设计费等需要结算依据
2. 合同约定"败诉方承担律师费"，案件未判决前律师费应暂缓确认
3. 如申报金额与起诉状金额不一致，需特别说明

## 五、证据完整性检查

**必须在报告中逐项核查以下证据**：

| 证据类型 | 是否提供 | 完整性 | 对债权认定的影响 |
|---------|---------|--------|-----------------|
| 生效法律文书 | 是/否 | 完整/部分/无 | [说明] |
| 合同/协议原件 | 是/否 | 完整/部分/无 | [说明] |
| 结算单据/对账单 | 是/否 | 完整/部分/无 | [说明] |
| 付款凭证/银行流水 | 是/否 | 完整/部分/无 | [说明] |
| 发票 | 是/否 | 完整/部分/无 | [说明] |
| 送货单/验收单 | 是/否 | 完整/部分/无 | [说明] |
| 催款记录/往来函件 | 是/否 | 完整/部分/无 | [说明] |

## 六、Calculator 工具强制使用

所有利息/违约金计算必须使用 Calculator 工具，严禁手工计算

# 报告输出格式（必须严格遵循）

## 一、债权基础法律关系确认

基于事实核查报告，确认：
- 独立债权关系数量：[X]个
- 具体清单：
  1. [关系1：合同名称/案号等标识]
  2. [关系2：合同名称/案号等标识]
- 法律关系性质：[合同类/法律文书类/股东出资/其他]
- **生效法律文书**：[有/无]（如有，列明案号；如无，标注"案件未经法院或仲裁机构裁决"）

## 二、证据完整性检查

（必须包含上述证据核查表格，逐项分析缺失证据对债权认定的影响）

## 三、金额项目拆解分析

### 2.1 金额项目清单

| 序号 | 项目描述 | 申报金额 | 法律性质 | 证据支持情况 | 计算需求 |
|------|----------|----------|----------|--------------|----------|
| 1 | [具体描述] | [金额]元 | 本金/利息/费用 | 有/不足/缺失 | 固定/需计算 |
| 2 | [具体描述] | [金额]元 | 本金/利息/费用 | 有/不足/缺失 | 固定/需计算 |

### 2.2 拆解说明

**债权构成的法律依据分析（每项必须详细说明）：**

1. **[本金项目名称][金额]元**
   - 法律依据：[案号]民事判决书主文第X项
   - 判决原文："[完整摘录判决书中关于该项的原文]"
   - 性质：普通债权
   - 形成原因：[详细说明债权形成的事实经过]

2. **[利息项目名称][金额]元**
   - 法律依据：[案号]民事判决书主文第X项
   - 判决原文："[完整摘录判决书中关于利息计算标准的原文]"
   - 计算期间：[起息日]至[止息日]（破产受理日前一日）
   - 计算标准：[LPR X倍 / 固定利率X% / 其他]
   - 性质：普通债权

3. **[费用项目]（如案件受理费、财产保全费等）**
   - 法律依据：[案号]民事判决书主文
   - 判决原文："[完整摘录]"
   - 性质：普通债权

4. **迟延履行利息[金额]元**
   - 法律依据：[案号]民事判决书主文第X段后
   - 判决原文："如果未按本判决指定的期间履行给付金钱义务，应当依照《中华人民共和国民事诉讼法》第二百六十条之规定，加倍支付迟延履行期间的债务利息"
   - 计算基数：[本金金额]元
   - 计算期间：判决生效后履行期届满次日至破产受理日前一日
   - 计算标准：日利率万分之1.75（加倍部分）
   - 性质：劣后债权（根据《最高人民法院关于适用〈中华人民共和国企业破产法〉若干问题的规定（二）》第二十八条）

## 三、履行期限判断

### 3.1 判决生效日期推定规则（重要）

⚠️ **如果证据材料未明确载明判决生效日期，必须采用以下保守推定方法**：

1. **一审判决**：
   - 判决作出日 + 送达时间（假定当日送达）+ 15天上诉期 = 生效日
   - 示例：判决作出日2023年6月12日 → 推定生效日2023年6月27日

2. **二审判决/终审判决**：作出之日即生效

3. **调解书**：双方签收之日生效，如未明确载明，采用调解书作出日

4. **履行期限届满日**：判决生效日 + 履行期限（如"10日内"则+10天）

5. **迟延履行利息起算日**：履行期限届满日次日

**说明**：如债权人后续补充送达回证显示实际生效日期不同，应根据实际日期重新计算迟延履行利息起算日及金额。

### 3.2 履行期限判断表

| 项目 | 履行期限 | 判决生效日(推定) | 履行期限届满日 | 迟延起算日 | 破产受理日 |
|------|----------|------------------|----------------|------------|------------|
| [项目名称] | [判决生效后X日] | [YYYY-MM-DD] | [YYYY-MM-DD] | [YYYY-MM-DD] | {bankruptcy_date} |

### 3.3 起息日确定
- 合同利息起息日：合同约定的起息日/判决确定的起息日
- 迟延履行利息起息日：履行期限届满日次日
- 止息日 = {interest_stop_date}（破产受理日前一日）

## 四、利息计算过程

### 4.1 利率类型识别与参数选择

**（一）利息损失计算**

🔴 **利率类型识别**：
- 法律文书表述："[摘录判决书中关于利息计算标准的原文]"
- 识别类型：[LPR浮动利率 / 固定利率 / 合同约定利率]
- 场景判断：[司法裁判 / 合同约定]

🔴 **参数选择依据**：
- LPR期限选择：[1年期 / 5年期以上]
- 选择理由：[说明选择依据，如：本案为买卖合同纠纷，债权性质为货款返还，非长期借款或房贷，适用1年期LPR]
- 基准天数：[365天/360天]
- 依据：[司法裁判场景使用365天（民法规定）/ 金融借款使用360天（行业惯例）]

**（二）迟延履行利息计算**

🔴 **利率类型识别**：
- 法律文书表述："应当依照《中华人民共和国民事诉讼法》第二百六十条之规定，加倍支付迟延履行期间的债务利息"
- 识别类型：日利率（固定）
- 场景判断：司法裁判（迟延履行）

🔴 **参数选择依据**：
- 日利率：万分之1.75（0.0175%）
- 选择理由：《民事诉讼法》第260条规定的加倍部分债务利息标准
- 基准天数：不适用（日利率直接计算）
- 依据：最高人民法院司法解释

### 4.2 计算参数格式

**固定金额类项目**：
（X）[项目名称]：[确定金额]元；

**借贷类合同利息（固定利率）**：
（X）[项目名称]：以[计算基数]元为计算基数，自[起息日]起至[止息日]止，按[年利率]%的年利率计算（基准天数[360/365]天），计算可得共[]元；

**借贷类合同利息（LPR浮动利率）**：
（X）[项目名称]：以[计算基数]元为计算基数，自[起息日]起至[止息日]止，按[LPR期限类型]LPR的[倍数]倍计算（基准天数[360/365]天），计算可得共[]元；

**迟延履行期间债务利息**：
（X）迟延履行期间的加倍部分债务利息：以[计算基数]元为计算基数，自[起息日]（履行期限届满日次日）至[止息日]（破产受理日前一日），以日利率万分之1.75为利率，计算可得共[]元；

### 4.2 计算标记（系统将自动识别并执行计算程序）

⚠️ **重要**：所有金额计算都必须使用以下标记格式输出，系统将自动调用计算程序执行，LLM不要自行计算结果！

**1. 利息计算标记**：

【利息计算】本金: [金额], 起始日: YYYY-MM-DD, 类型: [lpr/simple/delay/compound/penalty], 倍数: [如适用], LPR期限: [1y/5y如适用], 年利率: [如适用]

示例：
- LPR计算：【利息计算】本金: 7610000, 起始日: 2023-04-25, 类型: lpr, 倍数: 1.5, LPR期限: 1y
- 迟延履行利息：【利息计算】本金: 7610000, 起始日: 2023-07-03, 类型: delay
- 固定利率：【利息计算】本金: 1000000, 起始日: 2023-01-01, 类型: simple, 年利率: 6.0

**2. 份额比例计算标记（银团贷款必须使用）**：

【份额计算】总额: [银团总金额], 份额: [比例]%, 描述: [说明]

示例（银团贷款利息按份额分配）：
- 【份额计算】总额: 247674737.97, 份额: 13.95%, 描述: 判决确认银团截止2018年5月15日利息
- 【份额计算】总额: 1302547819.63, 份额: 13.95%, 描述: 银团总本金按份额计算

**3. 判决确认金额标记（直接使用已确认金额）**：

【确认金额】金额: [判决确认的金额], 来源: [案号], 描述: [说明]

示例：
- 【确认金额】金额: 15251650.28, 来源: (2018)鄂72民初1270号, 描述: 判决确认的违约金
- 【确认金额】金额: 765821.46, 来源: (2018)鄂72民初1270号, 描述: 判决确认的补偿金

**4. 最高额限额封顶检查标记（保证人最高额担保必须使用）**：

【最高额检查】计算总额: [本金+利息+费用], 最高额: [担保限额], 描述: [说明]

示例：
- 【最高额检查】计算总额: 153321209.81, 最高额: 150000000, 描述: 江苏熔盛重工在最高额1.5亿元范围内承担保证责任

### 4.3 计算结果汇总表

| 计算基数 | 起息日 | 止息日 | 计算天数 | 计算结果 | 备注 |
|----------|--------|--------|----------|----------|------|
| [金额]元 | [日期] | [日期] | [X]天 | [金额]元 | [说明] |
| **合计** | | | | **[总额]元** | |

**与申报金额对比**：
- 申报金额：[X]元
- 计算结果：[X]元
- 按"就低原则"：确认[X]元（取较低值）

## 五、诉讼时效分析

### 5.1 时效判断
- 起算时点：[日期及依据]
- 适用时效期间：[2年/3年]
- 中断/中止情况：[有/无，具体说明]
- 最终届满日：[日期]
- 债权申报日：[日期]
- 时效结论：**未超过/已超过诉讼时效**

### 5.2 详细说理
（完整的诉讼时效分析过程）

## 六、执行时效分析
（仅对基于生效法律文书的债权适用）

### 6.1 执行时效判断
- 执行依据：[（案号）判决书/调解书/仲裁裁决书]
- 履行期限：[判决生效之日起X日内]
- 判决生效日：[YYYY-MM-DD]（推定）
- 履行期限届满日：[YYYY-MM-DD]
- 时效起算：[YYYY-MM-DD]（履行期限届满次日）
- 执行申请时间：[YYYY-MM-DD]（在执行时效期间内/外）
- 中断事由：[有/无]
  - 如有：[债权人于XXXX年XX月XX日申请执行，执行时效中断]
- 执行程序终结：[YYYY-MM-DD]（终结本次执行程序/终结执行）
- 破产申报时间：[YYYY-MM-DD]（在执行时效期间内/外）
- 最终届满：[YYYY-MM-DD]（从履行期限届满日起算2年）
- 分析结论：**[未超过/已超过]执行时效**

### 6.2 详细说理

根据《中华人民共和国民事诉讼法》第二百三十九条规定，申请执行的期间为二年。申请执行时效的中止、中断，适用法律有关诉讼时效中止、中断的规定。

本案中：
1. **执行时效起算时点**：判决确定的履行期限届满之日（[日期]）次日即[日期]
2. **执行时效期间**：2年（至[日期]）
3. **中断事由**：[债权人于XXXX年XX月XX日向法院申请执行，执行时效中断 / 无中断事由]
4. **执行程序终结**：[日期]，法院作出[案号]执行裁定书，裁定"[终结本次执行程序/终结执行]"。[裁定理由]，该裁定[并非终结执行，仅为终结本次执行程序，不影响执行时效 / 为终结执行]
5. **破产程序中申报债权**：债权人于[日期]向管理人申报债权，[视为继续主张权利，执行时效再次中断 / 已超过执行时效]
6. **结论**：[债权人在执行时效期间内申请执行并在破产程序中申报债权，执行时效未届满 / 执行时效已届满]

**特别说明**：
- 执行裁定书明确载明"申请执行人发现被执行人有可供执行财产的，可以再次申请执行"，债务人仍负有继续履行义务
- 破产程序中债权申报视为权利主张，执行时效持续中断
- 本债权在破产程序中申报，[符合/不符合]执行时效要求

## 七、审查确认情况

### 7.1 申报与确认对比表

| 项目 | 申报金额 | 确认金额 | 性质 | 确认说明 |
|------|----------|----------|------|----------|
| 本金 | [金额]元 | [金额]元 | 普通/优先/劣后债权 | [说明] |
| 利息 | [金额]元 | [金额]元 | 普通/劣后债权 | [说明] |
| 费用 | [金额]元 | [金额]元 | 普通债权 | [说明] |
| **合计** | **[总额]元** | **[总额]元** | | |

### 7.2 债权性质确认
- 优先债权：[金额]元（如有担保物权等）
- 普通债权：[金额]元
- 劣后债权：[金额]元（迟延履行利息等破产受理后产生的）

## 八、审查结论

### 8.1 审查结论类型判断

⚠️ **请根据以下条件判断审查结论类型**：

**（一）如存在以下任一情形，结论为"暂缓确认"**：
- 无生效法律文书（判决书/调解书/仲裁裁决书），且不属于股东出资类债权
- 关键证据缺失（结算单据、付款记录、对账单等）
- 申报金额与证据金额存在重大不一致且未说明
- 附条件债权条件未满足（如"败诉方承担律师费"但案件未判决）

**（二）如满足以下条件，结论为"确认"**：
- 有生效法律文书确认债权，或
- 股东出资类债权，有公司章程/股东会决议确认
- 证据链完整
- 金额可核实

### 8.2 审查结论

**【确认】模板（适用于有生效法律文书或股东出资类债权）**：

经审查：
- 申报债权总额：[金额]元
- 确认债权总额：[金额]元
  - 优先债权：[金额]元
  - 普通债权：[金额]元
  - 劣后债权：[金额]元

**【暂缓确认】模板（适用于无生效法律文书的合同纠纷案件）**：

经审查，建议**暂缓确认**。

**暂缓确认理由**：
1. [理由1：如"案件未经法院或仲裁机构裁决，仅有民事起诉状，无判决书、调解书或裁定书"]
2. [理由2：如"关键证据缺失，债权人未提供付款记录、结算单据、对账单等"]
3. [理由3：如"申报金额与起诉状金额不一致，差额未明确说明"]
4. [理由4：如"律师费确认条件未满足，合同约定败诉方承担但案件未判决"]

**证据补充建议**：
要求债权人补充提供以下材料：
1. [材料1：如"法院生效裁判文书"]
2. [材料2：如"已付款项的付款记录"]
3. [材料3：如"双方确认的结算单据或对账单"]
4. [材料4：如"申报金额与起诉状金额差额的构成说明"]
5. [材料5：如"发票开具记录"]

**临时建议确认金额**：
如管理人认为有必要基于现有证据进行临时确认，建议确认金额为：
- [项目1]：[金额]元（依据：[来源，如"起诉状主张金额"]）
- [项目2]：[金额]元（依据：[来源]）
- 其他项目：0元（根据就无原则不予确认）
- **临时建议确认总额**：[金额]元（普通债权）

⚠️ 特别说明：此临时确认金额仅基于现有证据，缺乏充分证据支持，最终确认金额应以法院生效裁判文书或债权人补充完整证据后的审查结果为准。

---

**【股东出资类债权确认】模板**：

经审查：
- 申报债权总额：[金额]元
- 确认债权总额：[金额]元
  - 优先债权：0元
  - 普通债权：[金额]元
  - 劣后债权：0元

根据《中华人民共和国企业破产法》第三十五条规定："人民法院受理破产申请后，债务人的出资人尚未完全履行出资义务的，管理人应当要求该出资人缴纳所认缴的出资，而不受出资期限的限制。"

本案债务人作为股东尚有[金额]元出资义务未履行，管理人有权要求其缴纳。虽然公司章程/增资协议约定了违约金，但债权人未申报违约金，根据就无原则（债权人未申报的项目不予确认），违约金不予确认。

---

### 8.3 确认明细（仅"确认"类结论需要）

1. **[本金项目]**：申报[X]元，确认[X]元（[普通债权]）
   - 依据：[案号]民事判决书主文第X项
   - 说明：[与申报一致，全额确认 / 按计算结果确认]

2. **[利息项目]**：申报[X]元，确认[X]元（[普通债权]）
   - 依据：[案号]民事判决书主文第X项
   - 计算期间：[起息日]至[止息日]（[X]天）
   - 计算标准：[LPR X倍 / 固定利率X%]
   - 说明：经calculator工具验算，计算结果[X]元[低于/高于]申报金额[X]元，按[计算结果/申报金额]确认

3. **[费用项目]**：申报[X]元，确认[X]元（[普通债权]）
   - 依据：[案号]民事判决书主文
   - 说明：与申报一致，全额确认

4. **[迟延履行利息]**：申报[X]元，确认[X]元（[劣后债权]）
   - 依据：《民事诉讼法》第260条及判决书主文
   - 计算基数：[X]元
   - 计算期间：[起息日]至[止息日]（[X]天）
   - 计算标准：日利率万分之1.75
   - 说明：经calculator工具验算，计算结果[X]元[低于/高于]申报金额[X]元，按[计算结果/申报金额]确认（就低原则）；性质为劣后债权

### 确认结果汇总

- **确认债权总额**：[X]元
  - **优先债权**：[X]元
  - **普通债权**：[X]元
  - **劣后债权**：[X]元

### 调整说明

申报总额与确认总额差额：[申报额] - [确认额] = [差额]元

差额原因：[利息损失/迟延履行利息]经计算验证后调[增/减][X]元（申报[X]元，确认[X]元）

### 特别说明

1. **关于利息损失的计算差异**：债权人申报利息[X]元，经calculator工具按判决确定的标准（[计算标准]）重新计算，[起息日]至[止息日]期间利息为[X]元，两者相差[X]元。根据就低原则，按[计算结果/申报金额]确认[X]元。

2. **关于迟延履行利息的计算差异**：债权人申报迟延履行利息[X]元，经calculator工具按法定标准（日利率万分之1.75）重新计算，[起息日]至[止息日]期间迟延履行利息为[X]元，计算结果[高于/低于]申报金额[X]元。根据就低原则，按[申报金额/计算结果]确认[X]元。

3. **关于判决生效日期的说明**：由于债权人未提供判决书送达回证，本报告采用保守推定判决生效日期为[推定日期]（判决作出后15日）。如后续补充送达回证显示实际生效日期不同，应根据实际日期重新计算迟延履行利息起算日及金额。

4. **关于执行时效的说明**：本债权基于生效判决，债权人在执行时效期间内申请执行并在破产程序中申报债权，执行时效未届满。执行程序虽已终结本次执行，但不影响债权的存在和破产程序中的申报。

5. **关于劣后债权的依据**：根据《最高人民法院关于适用〈中华人民共和国企业破产法〉若干问题的规定（二）》第二十八条规定："债务人欠缴款项产生的滞纳金，包括债务人未履行生效法律文书应当加倍支付的迟延履行期间的债务利息，债权人作为破产债权申报的，人民法院应予受理。上述债权，应当在破产债权中劣后于普通债权顺序清偿。"因此，迟延履行期间的加倍部分债务利息应确认为劣后债权。

---

# ⚠️ 禁止事项

1. **禁止手工计算**：所有利息计算必须使用【利息计算】标记，由系统自动执行
2. **禁止推测参数**：如LPR期限不明确，标记为"[参数缺失,无法计算]"
3. **禁止估算**：不得使用"约"、"大概"等模糊表述
4. **禁止添加未申报项**：就无原则 - 未申报则不予确认
5. **禁止虚构数据**：所有数据必须有证据支持
"""

    return [
        SystemMessage(content=system),
        HumanMessage(content=human)
    ]


async def create_report_prompt_async(
    creditor_name: str,
    fact_check_report: str,
    analysis_report: str,
    debtor_name: str,
    bankruptcy_date: str,
    use_dynamic_knowledge: bool = True
) -> list:
    """
    Create prompt for report organization stage with dynamic knowledge.

    Args:
        creditor_name: Name of the creditor
        fact_check_report: Output from fact-checking stage
        analysis_report: Output from analysis stage
        debtor_name: Name of the debtor
        bankruptcy_date: Bankruptcy filing date
        use_dynamic_knowledge: If True, load knowledge dynamically

    Returns:
        List of messages for LLM invocation
    """
    if use_dynamic_knowledge:
        system = await get_report_system(bankruptcy_date)
    else:
        system = REPORT_SYSTEM.format(bankruptcy_date=bankruptcy_date)

    human = f"""请整合以下两份报告，生成标准化的债权审查意见书：

债权人名称：{creditor_name}
债务人名称：{debtor_name}
破产受理日期：{bankruptcy_date}

=== 事实核查报告 ===
{fact_check_report}

=== 债权分析报告 ===
{analysis_report}

【重要提示：多笔债权识别】
请首先分析事实核查报告中的"债权基础法律关系识别"部分：
- 如果"独立债权关系数量"大于1，或者识别出多个法律关系（如：主债务人债权+保证人债权、银团贷款份额债权等），**必须**采用"多笔债权报告结构"
- 如果只有1个独立债权关系，使用"单笔债权报告结构"

【银团贷款特别处理】
如果涉及银团贷款（识别标志：牵头行、代理行、参加行、份额比例等）：
1. 判决原告（通常是牵头行/代理行）代表全体银团成员获得判决
2. 申报人可能只是其中一个银团成员的债权受让人
3. **必须按份额比例计算**：单一成员债权 = 银团总债权 × 份额比例
4. 不能将银团总债权作为单一成员的债权确认
5. **重要**：申报人申报的本金通常已是按份额计算后的金额，应直接使用申报金额

【分笔债权本金提取-关键规则】
当存在多笔独立债权时，每笔债权的本金必须从事实核查报告中对应的申报表提取：
- 第一笔债权（有财产担保）的本金 = 从第一份申报材料/申报表中提取
- 第二笔债权（普通债权）的本金 = 从第二份申报材料/申报表中提取
- 绝不能将总本金全部计入第一笔而第二笔写成0
- 示例：如果总本金3.82亿=第一笔2.65亿+第二笔1.17亿，则：
  * 正确：第一笔本金2.65亿元，第二笔本金1.17亿元
  * 错误：第一笔本金3.82亿元，第二笔本金0元

【银团贷款利息计算-关键规则】
判决书通常将利息分为两部分，银团贷款案件必须按份额比例计算：
1. 判决截止日前已确认利息：判决书明确载明的金额（如"截至2018年5月15日利息为247,674,737.97元"）
2. 判决截止日后利息：从判决截止日起至破产受理日按约定利率继续计算

**银团贷款利息计算公式**：
申报人份额内利息 = (判决确认银团截止日前利息 × 份额比例) + (判决截止日后至破产受理日利息 × 份额比例)

**示例**：
- 判决确认银团截止2018.5.15利息：247,674,737.97元
- 申报人份额比例：13.95%
- 申报人份额内截止日前利息：247,674,737.97 × 13.95% ≈ 34,550,406元
- 加上2018.5.16至破产受理日按约定利率计算的后续利息

【最高额担保限额-关键规则】
当判决确认保证人在最高额X元范围内承担连带保证责任时：
- 保证人仅在该限额范围内承担责任
- 当计算总额（本金+利息+费用）超过最高额时，必须按最高额封顶
- 示例：判决确认保证人在最高额1.5亿元范围内承担保证责任，计算得出本金116,626,878.92元+利息36,694,330.89元=153,321,209.81元（超过1.5亿），应确认普通债权总额=150,000,000.00元（按最高额封顶）

【格式要求（零容忍）】
- 不使用 ## 标题语法，使用中文数字（一、二、三）
- 不使用 - 列表，使用完整句子叙述
- 不使用 ** 加粗语法
- 报告应读起来像正式法律文书，行文连贯专业
- 金额使用逗号分隔（如：7,610,000元）

=== 单笔债权报告结构（仅1个独立债权关系时使用）===

{creditor_name}
债权审查意见

一、债权申报情况

债权人{creditor_name}于[申报日期]向管理人申报债权，申报债权金额共计[总额]元，其中申报本金[X]元、申报利息[X]元、申报[费用项目][X]元、申报迟延履行利息[X]元。债权性质为[普通债权/优先债权]及劣后债权。

二、合同签订情况

根据[判决书/合同]查明，[合同签订日期]，[债权人全称]（购货方/出借方/承包方）与[债务人全称]（供货方/借款方/发包方）签订编号为[合同编号]的《[合同名称]》，约定[核心条款概述]。

三、合同履行情况

（按时间顺序叙述合同履行过程，包括付款情况、交付情况、违约情况等）

四、担保情况

本债权[无担保/有担保]。[如有担保，说明担保人、担保方式、担保范围等]

五、涉诉情况

（完整叙述诉讼/仲裁/执行的全过程）

六、债务人核查情况

债务人对申报的本金[X]元[无异议/有异议]，对债权人申报的利息及其他费用部分，债务人[核查意见]。

七、管理人审查结论

[使用下方模板A/B/C]

=== 多笔债权报告结构（多个独立债权关系时必须使用）===

{creditor_name}
债权审查意见

一、债权申报情况

债权人{creditor_name}于[申报日期]向管理人申报了[N]笔债权，申报债权总额[X]元。其中，申报本金[X]元、申报利息[X]元、...。各笔债权的具体情况如下：第一笔[债权性质][金额]元（本金[X]元），第二笔[债权性质][金额]元（本金[X]元）。

二、债权结构说明

{creditor_name}为[债权人类型，如：资产管理公司]，本次申报债权共[N]笔，涉及[M]份主合同。

第一笔债权系{creditor_name}于[日期]自[原债权人]处受让取得。原债权人[原债权人名称][作为银团成员（份额比例XX%）向/直接向][债务人名称]发放贷款，后因债务人未能清偿到期债务，该笔债权被划入不良资产，并于[日期]转让至{creditor_name}，债权转让于[日期]在[报刊名称]刊登公告通知债务人及担保人。

第二笔债权系{creditor_name}于[日期]自[原债权人]处受让取得。[债权形成过程简述]。

三、债权形成情况

第[序号]-1笔债权

[日期]，[合同当事人]签订[合同名称]（合同编号：XXX），核心约定如下：[银团结构（如适用）]；借款金额；借款期限；利率约定；担保约定...

[如涉及银团贷款]银团结构为[牵头行]作为银团牵头行和代理行，向[借款人]发放借款[总金额]元；各贷款人的贷款承诺额及其比例为：[银行A][金额]元（比例XX%）、[银行B][金额]元（比例XX%）...

[判决情况]...[判决日期]，[法院名称]作出[案号]民事判决书，判决：...该判决已发生法律效力。

[执行情况]...

[债权转让情况]...

第[序号]-2笔债权

[同样的详细描述]

四、担保分析说明

1. 担保覆盖情况

第一笔债权享有以下担保：[抵押人名称]以其名下[抵押物描述]提供抵押担保。[保证人名称]对[债务人名称]负担的债务承担连带保证责任。

第二笔债权的担保情况为：[债务人名称]作为保证人在最高额[X]元范围内承担保证责任。

2. 担保债权认定

根据担保覆盖情况，第一笔债权享有抵押担保及保证担保，确认为有财产担保债权；第二笔债权的主债务人为[主债务人名称]，[债务人名称]仅为保证人，因保证人非债务人本身，确认为普通债权。

五、债务人核查情况

债务人对申报的本金总计[X]元及管理人根据相关证据材料依法核定的其他费用部分无异议。

六、债权初步审查意见

第[序号]-1笔债权

根据债权人提供的基础合同材料及[法院名称]作出的已发生法律效力的[案号]民事判决，[如涉及银团贷款：[牵头行名称]作为银团牵头行和代理行代表全体银团成员获得判决，判决确认[债务人名称]应向[牵头行名称]支付借款本金[银团总本金]元及利息、罚息、复利、违约金等，[原债权人名称]作为银团成员按份额比例[X]%享有债权本金[份额本金]元，]申报人作为[原债权人名称]的债权受让人，通过[日期]资产买卖协议和[日期][报刊名称]公告，合法受让上述债权。

管理人初步审查确认第[序号]-1笔债权为[有财产担保债权/普通债权]，[如有担保物：判决确认债权人对[抵押物描述]享有抵押权，并有权就其拍卖、变卖所得价款优先受偿，]确认[债权类型]总额[X]元，劣后债权总额[X]元。

第[序号]-2笔债权

[同样的审查结论格式]

综上，管理人初步确认[N]笔债权，其中有财产担保债权[M]笔，确认债权总额[X]元；普通债权[P]笔，确认金额[X]元；劣后债权合计[X]元。各笔债权的具体情况如下：

第[序号]-1笔债权：[债权性质]，确认金额[X]元；劣后债权，确认金额[X]元。

第[序号]-2笔债权：[债权性质]，确认金额[X]元；劣后债权，确认金额[X]元。

合计确认债权金额[X]元。

七、汇总确认表

经管理人审查，各笔债权确认情况汇总如下：

第一笔债权：申报本金[X]元，确认本金[X]元；申报利息[X]元，确认利息[X]元；申报违约金[X]元，确认违约金[X]元；申报补偿金[X]元，确认补偿金[X]元；申报诉讼费[X]元，确认诉讼费[X]元；申报律师费[X]元，确认律师费[X]元；申报迟延履行金[X]元，确认迟延履行金[X]元；债权性质为[有财产担保债权/普通债权]（本金、利息、违约金、补偿金、诉讼费、律师费合计[X]元）及劣后债权（迟延履行金[X]元），确认金额合计[X]元。

第二笔债权：申报本金[X]元，确认本金[X]元；申报利息[X]元，确认利息[X]元；申报诉讼费[X]元，确认诉讼费[X]元；申报迟延履行金[X]元，确认迟延履行金[X]元；债权性质为[有财产担保债权/普通债权]（本金、利息、诉讼费合计[X]元）及劣后债权（迟延履行金[X]元），确认金额合计[X]元。

合计确认有财产担保债权[M]笔，确认金额[X]元；确认普通债权[P]笔，确认金额[X]元；确认劣后债权[X]元。确认债权总额[X]元。

八、关联文件

本审查意见表的技术报告及计算文件存放于以下位置：

1. 债权结构概览：工作底稿/{creditor_name}_债权结构概览.md
2. 法律关系图：工作底稿/{creditor_name}_法律关系图.md
3. 事实核查报告：工作底稿/{creditor_name}_事实核查报告.md
4. 债权分析报告：工作底稿/{creditor_name}_债权分析报告.md
5. 利息计算文件：计算文件/{creditor_name}_计算过程.xlsx

=== 管理人审查结论模板选择指南 ===

⚠️ 请根据分析报告的结论类型选择对应模板：

**【模板A：确认】（适用于有生效法律文书的案件）**

管理人认可[法院名称]作出的[案号]民事判决书确定的债权债务关系。经审查债权申报材料及相关证据，[债权确认情况概述]。

管理人使用通用债权计算器工具对利息损失及迟延履行利息进行了重新计算验证：利息损失方面，以[本金]元为基数，自[起息日]起至[止息日]止（破产受理日前一日），按[计算标准]计算，计算结果为[X]元，[高于/低于]申报金额[X]元，根据就低原则按[计算结果/申报金额]确认[X]元。迟延履行利息方面，以[本金]元为基数，自[起息日]（履行期限届满次日）起至[止息日]止，按日利率万分之1.75计算，计算结果为[X]元，[高于/低于]申报金额[X]元，根据就低原则按[计算结果/申报金额]确认[X]元。

经核查，管理人确认{creditor_name}申报的债权，即确认本金[X]元、利息[X]元、[费用项目][X]元、迟延履行利息[X]元，债权金额共计[X]元。其中，本金[X]元、利息[X]元、[费用项目][X]元合计[X]元，性质为普通债权；迟延履行利息[X]元，根据《最高人民法院关于适用〈中华人民共和国企业破产法〉若干问题的规定（二）》第二十八条规定，应确认为劣后债权。申报总额与确认总额差额为[X]元，差额原因为[具体说明]。

**【模板B：确认】（适用于股东出资类债权）**

根据《广林欧卡罗（广西）家居有限公司章程》及《2021年第X次股东会会议纪要》，[债务人名称]作为股东认缴出资[总额]元，其中第一期出资[X]元已履行，第二期出资[X]元按股东会决议应于[具体期限]分期到位。截至破产受理日{bankruptcy_date}，上述出资期限均已届满，[债务人名称]尚未出资，形成未履行出资义务[X]元。

即使股东会决议调整出资期限的法律效力存在争议，根据《中华人民共和国企业破产法》第三十五条规定："人民法院受理破产申请后，债务人的出资人尚未完全履行出资义务的，管理人应当要求该出资人缴纳所认缴的出资，而不受出资期限的限制。"本案债务人作为股东尚有[X]元出资义务未履行，管理人有权要求其缴纳。

虽然公司章程约定了违约金，增资协议约定了利息，但债权人本次申报未包含违约金或利息，仅申报本金[X]元。根据就无原则（债权人未申报的项目不予确认），违约金和利息均不予确认。

经核查，管理人确认{creditor_name}申报的债权，即确认本金[X]元，债权金额共计[X]元。以上债权性质为普通债权。根据《中华人民共和国公司法》及《中华人民共和国企业破产法》第三十五条规定，股东出资义务在破产程序中应当全额缴纳，构成破产财产。本案债权为股东未履行出资义务形成的求偿权，属于公司对股东的请求权，在破产程序中按普通债权顺序清偿。

**【模板C：暂缓确认】（适用于无生效法律文书的合同纠纷案件）**

根据债权申报材料，本案债权未经法院或仲裁机构裁决，无涉诉情况/案件尚在审理中。经审查债权申报材料及相关证据，管理人建议对本债权暂缓确认。

暂缓确认理由如下：

（一）案件未经法院裁判。债权人申报时案件尚未经法院裁判，仅有民事起诉状，无判决书、调解书或裁定书。债权金额及构成以债权人单方主张为准，缺乏司法确认。

（二）关键证据缺失。债权人未提供[具体缺失证据，如：付款记录、结算单据、对账单、发票开具记录]等关键证据，无法核实债权金额的真实性和准确性。

（三）申报金额不一致。债权人在申报表中填写的本金[X]元与民事起诉状中主张的金额[Y]元相差[差额]元，差额构成未明确说明。

（四）[如适用]律师费确认条件未满足。合同约定"败诉方承担胜诉方律师费"，但案件尚未判决，律师费能否确认取决于最终裁判结果。

（五）利息、违约金及其他费用未明确申报。债权人在申报表中填写利息、违约金"详见附件"，但未提供附件；[其他费用项目]未在申报表中明确申报具体金额，且缺乏结算清单等支持性证据。根据就无原则（债权人未申报的项目不予确认），不予确认。

建议债权人补充提供以下证据材料：1.法院生效裁判文书；2.已付款项的付款记录；3.双方确认的结算单据或对账单；4.申报金额差额的构成说明；5.发票开具记录。或待法院生效裁判文书确定债权金额后，再行审查确认。

临时建议确认金额：如管理人认为有必要基于现有证据进行临时确认，建议确认金额为[X]元（以起诉状主张金额为准），其中[项目1][金额]元、[项目2][金额]元，其余项目根据就无原则不予确认。此临时确认金额仅基于债权人起诉状主张，缺乏充分证据支持，最终确认金额应以法院生效裁判文书或债权人补充完整证据后的审查结果为准。

=== 结束 ===

请严格按照上述7章结构生成报告，每章内容必须完整详细。
"""

    return [
        SystemMessage(content=system),
        HumanMessage(content=human)
    ]


def create_report_prompt(
    creditor_name: str,
    fact_check_report: str,
    analysis_report: str,
    debtor_name: str,
    bankruptcy_date: str
) -> list:
    """Create prompt for report organization stage."""

    system = REPORT_SYSTEM.format(bankruptcy_date=bankruptcy_date)

    human = f"""请整合以下两份报告，生成标准化的债权审查意见书：

债权人名称：{creditor_name}
债务人名称：{debtor_name}
破产受理日期：{bankruptcy_date}

=== 事实核查报告 ===
{fact_check_report}

=== 债权分析报告 ===
{analysis_report}

请按照以下格式生成最终审查意见书（必须严格遵循7章结构）：

【格式要求（零容忍）】
- 不使用 ## 标题语法，使用中文数字（一、二、三）
- 不使用 - 列表，使用完整句子叙述
- 不使用 ** 加粗语法
- 报告应读起来像正式法律文书，行文连贯专业
- 金额使用逗号分隔（如：7,610,000元）

=== 报告结构模板 ===

{creditor_name}
债权审查意见

一、债权申报情况

债权人{creditor_name}于[申报日期]向管理人申报债权，申报债权金额共计[总额]元，其中申报本金[X]元、申报利息[X]元、申报[费用项目][X]元、申报迟延履行利息[X]元。债权性质为[普通债权/优先债权]及劣后债权。

二、合同签订情况

根据[判决书/合同]查明，[合同签订日期]，[债权人全称]（购货方/出借方/承包方）与[债务人全称]（供货方/借款方/发包方）签订编号为[合同编号]的《[合同名称]》，约定[核心条款概述]。

三、合同履行情况

（按时间顺序叙述合同履行过程，包括付款情况、交付情况、违约情况等）

1. [日期]，[事件描述]。
2. [日期]，[事件描述]。
...

四、担保情况

本债权[无担保/有担保]。[如有担保，说明担保人、担保方式、担保范围等]

五、涉诉情况

（完整叙述诉讼/仲裁/执行的全过程）

[起诉日期]，[债权人]就与[债务人]之间的[纠纷类型]向[法院名称]提起诉讼，案号为[案号]。[债权人]请求[诉讼请求概述]。

[判决日期]，[法院名称]作出[案号]民事判决书，判决：一、[判决内容概述]；二、[判决内容概述]；[逐项列明]。案件受理费[X]元，由被告负担。该判决已于[生效日期]生效。

[如有执行程序]因[债务人]未履行生效判决确定的义务，[债权人]于[执行申请日期]向[法院名称]申请强制执行，执行案号为[案号]。[执行进展描述]。[执行终结日期]，[法院名称]作出[案号]执行裁定书，裁定[终结原因]。截至目前，[执行回款情况]。

六、债务人核查情况

债务人对申报的本金[X]元[无异议/有异议]，对债权人申报的利息及其他费用部分，债务人[核查意见]。

七、管理人审查结论

⚠️ **请根据分析报告的结论类型选择对应模板**：

**【模板A：确认】（适用于有生效法律文书的案件）**

管理人认可[法院名称]作出的[案号]民事判决书确定的债权债务关系。经审查债权申报材料及相关证据，[债权确认情况概述]。

管理人使用通用债权计算器工具对利息损失及迟延履行利息进行了重新计算验证：利息损失方面，以[本金]元为基数，自[起息日]起至[止息日]止（破产受理日前一日），按[计算标准]计算，计算结果为[X]元，[高于/低于]申报金额[X]元，根据就低原则按[计算结果/申报金额]确认[X]元。迟延履行利息方面，以[本金]元为基数，自[起息日]（履行期限届满次日）起至[止息日]止，按日利率万分之1.75计算，计算结果为[X]元，[高于/低于]申报金额[X]元，根据就低原则按[计算结果/申报金额]确认[X]元。

经核查，管理人确认{creditor_name}申报的债权，即确认本金[X]元、利息[X]元、[费用项目][X]元、迟延履行利息[X]元，债权金额共计[X]元。其中，本金[X]元、利息[X]元、[费用项目][X]元合计[X]元，性质为普通债权；迟延履行利息[X]元，根据《最高人民法院关于适用〈中华人民共和国企业破产法〉若干问题的规定（二）》第二十八条规定，应确认为劣后债权。申报总额与确认总额差额为[X]元，差额原因为[具体说明]。

**【模板B：确认】（适用于股东出资类债权）**

根据《广林欧卡罗（广西）家居有限公司章程》及《2021年第X次股东会会议纪要》，[债务人名称]作为股东认缴出资[总额]元，其中第一期出资[X]元已履行，第二期出资[X]元按股东会决议应于[具体期限]分期到位。截至破产受理日{bankruptcy_date}，上述出资期限均已届满，[债务人名称]尚未出资，形成未履行出资义务[X]元。

即使股东会决议调整出资期限的法律效力存在争议，根据《中华人民共和国企业破产法》第三十五条规定："人民法院受理破产申请后，债务人的出资人尚未完全履行出资义务的，管理人应当要求该出资人缴纳所认缴的出资，而不受出资期限的限制。"本案债务人作为股东尚有[X]元出资义务未履行，管理人有权要求其缴纳。

虽然公司章程约定了违约金，增资协议约定了利息，但债权人本次申报未包含违约金或利息，仅申报本金[X]元。根据就无原则（债权人未申报的项目不予确认），违约金和利息均不予确认。

经核查，管理人确认{creditor_name}申报的债权，即确认本金[X]元，债权金额共计[X]元。以上债权性质为普通债权。根据《中华人民共和国公司法》及《中华人民共和国企业破产法》第三十五条规定，股东出资义务在破产程序中应当全额缴纳，构成破产财产。本案债权为股东未履行出资义务形成的求偿权，属于公司对股东的请求权，在破产程序中按普通债权顺序清偿。

**【模板C：暂缓确认】（适用于无生效法律文书的合同纠纷案件）**

根据债权申报材料，本案债权未经法院或仲裁机构裁决，无涉诉情况/案件尚在审理中。经审查债权申报材料及相关证据，管理人建议对本债权暂缓确认。

暂缓确认理由如下：

（一）案件未经法院裁判。债权人申报时案件尚未经法院裁判，仅有民事起诉状，无判决书、调解书或裁定书。债权金额及构成以债权人单方主张为准，缺乏司法确认。

（二）关键证据缺失。债权人未提供[具体缺失证据，如：付款记录、结算单据、对账单、发票开具记录]等关键证据，无法核实债权金额的真实性和准确性。

（三）申报金额不一致。债权人在申报表中填写的本金[X]元与民事起诉状中主张的金额[Y]元相差[差额]元，差额构成未明确说明。

（四）[如适用]律师费确认条件未满足。合同约定"败诉方承担胜诉方律师费"，但案件尚未判决，律师费能否确认取决于最终裁判结果。

（五）利息、违约金及其他费用未明确申报。债权人在申报表中填写利息、违约金"详见附件"，但未提供附件；[其他费用项目]未在申报表中明确申报具体金额，且缺乏结算清单等支持性证据。根据就无原则（债权人未申报的项目不予确认），不予确认。

建议债权人补充提供以下证据材料：1.法院生效裁判文书；2.已付款项的付款记录；3.双方确认的结算单据或对账单；4.申报金额差额的构成说明；5.发票开具记录。或待法院生效裁判文书确定债权金额后，再行审查确认。

临时建议确认金额：如管理人认为有必要基于现有证据进行临时确认，建议确认金额为[X]元（以起诉状主张金额为准），其中[项目1][金额]元、[项目2][金额]元，其余项目根据就无原则不予确认。此临时确认金额仅基于债权人起诉状主张，缺乏充分证据支持，最终确认金额应以法院生效裁判文书或债权人补充完整证据后的审查结果为准。

=== 结束 ===

请严格按照上述7章结构生成报告，每章内容必须完整详细。
"""

    return [
        SystemMessage(content=system),
        HumanMessage(content=human)
    ]


# ============== Legal Diagram Prompt ==============

async def get_legal_diagram_system(bankruptcy_date: str) -> str:
    """Get system prompt for legal diagram generation stage."""
    base = await build_system_prompt(
        stage="fact_check",  # 复用fact_check的知识库
        bankruptcy_date=bankruptcy_date,
        token_budget=2000,
        include_advanced=False
    )

    stage_specific = """你当前的任务是【法律关系图生成】阶段。

工作内容：
1. 根据事实核查报告，识别债权人、债务人、担保人之间的法律关系
2. 生成Mermaid格式的法律关系图
3. 提供图例说明和关键关系文字说明

生成条件判断：
- 存在担保人（保证人）→ 生成主体关系图
- 存在担保物（抵押/质押）→ 生成主体关系图
- 多笔债权（≥2笔）→ 生成合同关系图
- 存在债权转让 → 生成债权转让链图

Mermaid样式要求：
- 债权人：绿色 fill:#9f9,stroke:#333
- 债务人：红色 fill:#f99,stroke:#333
- 担保人：黄色 fill:#ff9,stroke:#333
- 担保物：蓝色 fill:#9cf,stroke:#333
- 历史主体：灰色 fill:#ccc,stroke:#333

连线规范：
- 实线箭头 --> ：直接法律关系（债权、担保）
- 虚线箭头 -.-> ：关联关系（股权、亲属）
- 实线无箭头 --- ：合同从属关系
"""
    return base + stage_specific


async def create_legal_diagram_prompt_async(
    creditor_name: str,
    fact_check_report: str,
    bankruptcy_date: str,
    debtor_name: str
) -> list:
    """
    Create prompt for legal diagram generation.

    Args:
        creditor_name: Name of the creditor
        fact_check_report: Content of the fact-check report
        bankruptcy_date: Bankruptcy filing date
        debtor_name: Name of the debtor

    Returns:
        List of messages for LLM invocation
    """
    system = await get_legal_diagram_system(bankruptcy_date)

    date_str = bankruptcy_date[:10] if len(bankruptcy_date) >= 10 else bankruptcy_date

    human = f"""请根据以下事实核查报告，生成法律关系图。

## 基本信息
- 债权人名称：{creditor_name}
- 债务人名称：{debtor_name}
- 破产受理日：{bankruptcy_date}

## 事实核查报告内容

{fact_check_report}

## 输出要求

请生成完整的法律关系图Markdown文件，格式如下：

# {creditor_name} 法律关系图

**生成日期**：{date_str}
**数据来源**：事实核查报告

---

## 一、主体关系图

本图展示债权人、债务人、担保人之间的法律关系。

```mermaid
graph TD
    subgraph 债权人
        C[债权人名称]
    end

    subgraph 债务人
        D[债务人名称]
    end

    [根据实际情况填充担保人、担保物等节点和关系]

    style C fill:#9f9,stroke:#333
    style D fill:#f99,stroke:#333
```

---

## 二、合同关系图

[如为多笔债权，展示各笔债权与担保合同的对应关系]
[如为单笔债权，标注：本案为单笔债权，无需合同关系图]

---

## 三、债权转让链图

[如存在债权转让，展示转让链条]
[如无债权转让，标注：本案债权人为原始债权人，无债权转让历史]

---

## 四、图例说明

### 颜色含义

| 颜色 | 含义 |
|------|------|
| 绿色 (#9f9) | 债权人（权利方） |
| 红色 (#f99) | 债务人（主债务人） |
| 黄色 (#ff9) | 担保人（保证人） |
| 蓝色 (#9cf) | 担保物（抵押/质押物） |
| 灰色 (#ccc) | 历史主体（已退出关系） |

### 线型含义

| 线型 | 语法 | 含义 |
|------|------|------|
| 实线箭头 | --> | 直接法律关系（债权、担保） |
| 实线无箭头 | --- | 合同从属关系 |
| 虚线箭头 | -.-> | 关联关系（股权、亲属等） |

---

## 五、关键关系说明

[用文字补充说明图表中难以表达的复杂关系]

### 5.1 担保覆盖范围
[列表说明各担保人/物的担保范围]

### 5.2 关联关系说明
[如有股权、亲属等关联关系，在此说明]

---

请严格按照上述格式生成法律关系图，所有Mermaid代码必须语法正确可渲染。
"""

    return [
        SystemMessage(content=system),
        HumanMessage(content=human)
    ]


def should_generate_legal_diagram(fact_check_report: str) -> bool:
    """
    Analyze fact-check report to determine if legal diagram should be generated.

    Conditions (any one triggers generation):
    - ≥1 guarantor (担保人/保证人)
    - ≥1 collateral (抵押/质押)
    - ≥2 claims (第2笔/第二笔)
    - Debt assignment (受让/转让)

    Args:
        fact_check_report: Content of the fact-check report

    Returns:
        True if legal diagram should be generated
    """
    if not fact_check_report:
        return False

    conditions = [
        "担保人" in fact_check_report or "保证人" in fact_check_report,
        "抵押" in fact_check_report or "质押" in fact_check_report,
        "第2笔" in fact_check_report or "第二笔" in fact_check_report or "多笔" in fact_check_report,
        "受让" in fact_check_report or "债权转让" in fact_check_report,
    ]

    return any(conditions)
