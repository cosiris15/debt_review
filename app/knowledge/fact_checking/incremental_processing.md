# 事实核查增量处理指南

**版本**: v3.0
**适用Agent**: debt-fact-checker
**处理模式**: Incremental / Partial

---

## 目录

1. [增量处理概述](#增量处理概述)
2. [处理模式识别](#处理模式识别)
3. [前轮报告读取](#前轮报告读取)
4. [影响范围识别](#影响范围识别)
5. [增量核查策略](#增量核查策略)
6. [报告合并方法](#报告合并方法)
7. [质量检查点](#质量检查点)

---

## 增量处理概述

### 什么是增量事实核查？

**定义**: 在补充材料场景下，仅对受影响的事实关系进行重新核查，未受影响的部分直接继承前轮结果。

### 为什么需要增量处理？

| 场景 | Full模式 | Incremental模式 | 效率提升 |
|------|----------|-----------------|----------|
| 补充生效判决书 | 完整重审所有材料 | 仅核查判决相关事实 | 60-75% |
| 补充银行流水 | 完整重审所有材料 | 仅核查履行证据部分 | 65-70% |
| 补充担保合同 | 完整重审所有材料 | 仅核查担保关系部分 | 70-75% |

### 三种处理模式对比

| 模式 | 触发条件 | 事实核查范围 | 时间节省 | 风险等级 |
|------|----------|--------------|----------|----------|
| **Full** | CRITICAL字段变更 | 全部重新核查 | 0% | 低 |
| **Incremental** | HIGH/MEDIUM字段变更 | 仅受影响部分 | 60-75% | 中 |
| **Partial** | LOW字段变更 | 极少量更新 | 85%+ | 低 |

---

## 处理模式识别

### Step 1: 读取轮次元数据

**MANDATORY**: 在开始任何工作前，必须读取`.round_metadata.json`确定处理模式。

```bash
# 元数据文件位置
round_N/.round_metadata.json
```

**关键字段**:

```json
{
  "round_number": 2,
  "processing_mode": "incremental",  // ← 核心：处理模式
  "parent_round": 1,
  "fields_updated": [               // ← 核心：变更字段
    "judgment_document",
    "performance_evidence"
  ],
  "affected_stages": [1, 2, 3],     // ← 核心：受影响Stages
  "trigger_reason": "补充生效法律文书和银行流水"
}
```

### Step 2: 模式决策逻辑

```
IF processing_mode == "full":
    → 执行完整事实核查（使用标准工作流）
    → 无需读取前轮报告
    → 生成全新报告

ELSE IF processing_mode == "incremental":
    → 执行增量事实核查
    → 读取前轮报告
    → 识别受影响章节
    → 重新核查受影响部分
    → 合并生成新报告

ELSE IF processing_mode == "partial":
    → 执行最小化更新
    → 读取前轮报告
    → 仅更新特定字段（如联系方式）
    → 快速生成新报告
```

---

## 前轮报告读取

### Step 1: 定位前轮报告

```bash
# 父轮次报告位置
round_{parent_round}/工作底稿/{债权人}_事实核查报告.md
```

**示例**:
```bash
# Round 2的parent_round=1，读取:
round_1/工作底稿/慈溪市东航建筑_事实核查报告.md
```

### Step 2: 报告结构解析

**标准事实核查报告章节结构**:

```markdown
## 一、申报情况
  ### 1.1 债权人基本信息
  ### 1.2 申报债权金额构成

## 二、形式性文件核查
  ### 2.1 债权申报表核查
  ### 2.2 授权文件核查

## 三、债权形成的主要事实
  ### 3.1 合同文件核查
  ### 3.2 履行证据核查
  ### 3.3 法律文书核查

## 四、证据情况汇总
  ### 4.1 已提供证据清单
  ### 4.2 证据完整性评估

## 五、债权发生时间线

## 六、核查结论
```

### Step 3: 提取前轮事实

**提取策略**:
- ✅ 提取申报情况（第一章）完整内容
- ✅ 提取形式性文件核查（第二章）完整内容
- ✅ 提取主要事实（第三章）各节内容
- ✅ 提取时间线（第五章）完整内容
- ⚠️ 注意章节编号和结构一致性

---

## 影响范围识别

### Step 1: 读取影响分析结果

从`.round_metadata.json`读取影响分析结果：

```json
{
  "impact_analysis": {
    "affected_stages": [1, 2, 3],
    "affected_sections": [3, 4, 5, 6],  // ← 事实核查报告受影响章节
    "affected_evidence_types": [
      "法律文书",
      "履行证据"
    ]
  }
}
```

### Step 2: 章节影响映射

**字段变更 → 事实核查报告章节影响映射表**:

| 变更字段 | 受影响章节 | 核查重点 |
|----------|------------|----------|
| `judgment_document` | 三.3 法律文书核查、四、五、六 | 重新核查判决内容、更新证据清单、更新时间线、修正结论 |
| `performance_evidence` | 三.2 履行证据核查、四、五 | 重新核查银行流水、更新证据清单、更新时间线 |
| `guarantee_type` | 三.1 合同文件核查（担保部分）、四、六 | 重新核查担保合同、更新证据清单、修正结论 |
| `creditor_contact` | 一.1 债权人基本信息 | 仅更新联系方式 |

**完整映射**: 参考 `config/impact_mappings.py`

### Step 3: 确定需要重新核查的章节

```python
# 伪代码示例
directly_affected_sections = metadata["impact_analysis"]["affected_sections"]

# 应用章节依赖规则
if 3 in directly_affected_sections:  # 如果第三章（主要事实）受影响
    also_update = [4, 5, 6]  # 证据清单、时间线、结论也需要更新

needs_recheck = set(directly_affected_sections) | set(also_update)
```

---

## 增量核查策略

### 策略A: 章节级增量（Incremental模式）

**适用场景**: HIGH/MEDIUM优先级字段变更

**步骤**:

1. **继承未受影响章节**（直接复制）:
   ```
   IF 第一章（申报情况）未受影响:
       → 从前轮报告复制 "## 一、申报情况" 全部内容

   IF 第二章（形式性文件）未受影响:
       → 从前轮报告复制 "## 二、形式性文件核查" 全部内容
   ```

2. **重新核查受影响章节**（完整重做）:
   ```
   IF 第三章第3节（法律文书核查）受影响:
       → 读取新增判决书.pdf
       → 按照标准格式提取判决内容
       → 生成新的 "### 3.3 法律文书核查" 内容
   ```

3. **自动联动更新**:
   ```
   IF 第三章有任何变更:
       → 自动重新生成 "## 四、证据情况汇总"
       → 自动更新 "## 五、债权发生时间线"（添加新事件）
       → 自动修正 "## 六、核查结论"
   ```

### 策略B: 字段级增量（Partial模式）

**适用场景**: LOW优先级字段变更（如联系方式）

**步骤**:

1. **读取前轮报告**
2. **定位特定字段位置**:
   ```markdown
   # 在前轮报告中定位：
   ### 1.1 债权人基本信息
   - 债权人名称：慈溪市东航建筑
   - 联系人：张三
   - 联系电话：138****0000  ← 仅更新这一行
   ```
3. **替换字段值**
4. **保存新报告**

### 增量核查工作流

```
┌────────────────────────────────────────────────────┐
│ Step 1: 读取前轮报告                                 │
│   round_1/工作底稿/事实核查报告.md                   │
└────────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────────┐
│ Step 2: 识别受影响章节                               │
│   affected_sections = [3, 4, 5, 6]                │
└────────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────────┐
│ Step 3: 分类处理                                     │
│   - 未受影响章节 → 直接复制                          │
│   - 受影响章节 → 重新核查                            │
└────────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────────┐
│ Step 4: 读取新增材料                                 │
│   round_2/输入材料/新增判决书.pdf                    │
└────────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────────┐
│ Step 5: 重新核查受影响章节                            │
│   按照标准格式提取事实                                │
└────────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────────┐
│ Step 6: 合并生成新报告                               │
│   未受影响部分 + 重新核查部分                         │
└────────────────────────────────────────────────────┘
                    ↓
┌────────────────────────────────────────────────────┐
│ Step 7: 保存到round_2/工作底稿/                      │
└────────────────────────────────────────────────────┘
```

---

## 报告合并方法

### 方法1: 章节拼接法（推荐用于Incremental）

```markdown
# 合并伪代码

新报告 = ""

# 第一章：申报情况
IF "申报情况" 未受影响:
    新报告 += 复制(前轮报告["## 一、申报情况"])
ELSE:
    新报告 += 重新核查("## 一、申报情况")

# 第二章：形式性文件核查
IF "形式性文件" 未受影响:
    新报告 += 复制(前轮报告["## 二、形式性文件核查"])
ELSE:
    新报告 += 重新核查("## 二、形式性文件核查")

# 第三章：主要事实（最可能受影响）
IF "主要事实" 受影响:
    新报告 += 重新核查("## 三、债权形成的主要事实")
    # 注意：可能只重新核查3.3小节，其他小节复制
ELSE:
    新报告 += 复制(前轮报告["## 三、债权形成的主要事实"])

# 第四章：证据情况汇总（依赖第三章）
新报告 += 重新生成("## 四、证据情况汇总")  # 总是重新生成

# 第五章：时间线（依赖第三章）
新报告 += 更新时间线("## 五、债权发生时间线")  # 合并前轮+新事件

# 第六章：核查结论（依赖所有章节）
新报告 += 重新生成("## 六、核查结论")  # 总是重新生成
```

### 方法2: 字段替换法（推荐用于Partial）

```python
# 伪代码
前轮报告内容 = read_file("round_1/工作底稿/事实核查报告.md")

# 定位并替换特定字段
if "creditor_contact" in fields_updated:
    前轮报告内容 = 前轮报告内容.replace(
        old="联系电话：138****0000",
        new="联系电话：139****1111"
    )

# 保存新报告
write_file("round_2/工作底稿/事实核查报告_round2.md", 前轮报告内容)
```

### 章节依赖关系

**关键原则**: 如果前置章节有变更，依赖它的后续章节也必须更新。

```
第一章（申报情况）
  ↓ 无依赖
第二章（形式性文件）
  ↓ 无依赖
第三章（主要事实）  ← 最常变更
  ↓ 依赖关系开始
第四章（证据汇总）  ← 依赖第三章
  ↓
第五章（时间线）    ← 依赖第三章
  ↓
第六章（核查结论）  ← 依赖所有前章
```

**实施规则**:
```
IF 第三章有任何变更:
    → 必须更新：第四章、第五章、第六章

IF 第一章或第二章有变更:
    → 仅更新：第六章（结论）

IF 仅第一章有变更（如联系方式）:
    → 可选更新：第六章（通常不需要）
```

---

## 质量检查点

### Checkpoint 1: 模式识别验证

```
□ 已读取 .round_metadata.json
□ 处理模式识别正确（full/incremental/partial）
□ 父轮次号识别正确
□ 变更字段列表完整
```

### Checkpoint 2: 前轮报告读取验证

```
□ 前轮报告路径正确（round_{parent}/工作底稿/...）
□ 前轮报告文件存在
□ 前轮报告内容完整可读
□ 章节结构解析正确
```

### Checkpoint 3: 影响范围识别验证

```
□ 受影响章节识别正确
□ 章节依赖关系应用正确
□ 需要重新核查的章节清单明确
```

### Checkpoint 4: 材料读取验证

```
□ 新增材料文件位置正确（round_2/输入材料/）
□ 新增材料文件存在且可读
□ 区分实际证据文件 vs 证据目录
```

### Checkpoint 5: 增量核查执行验证

```
□ 未受影响章节正确复制（内容一字不差）
□ 受影响章节完整重新核查（不遗漏）
□ 新增事实按照标准格式提取
□ 时间线合并正确（前轮事件+新事件，按时间排序）
```

### Checkpoint 6: 报告合并验证

```
□ 章节顺序正确（一、二、三、四、五、六）
□ 章节编号一致
□ 无重复章节
□ 无遗漏章节
□ 格式符合模板要求
```

### Checkpoint 7: 日期一致性验证（CRITICAL）

```
□ 破产日期与前轮报告一致
□ 停止计息日与前轮报告一致
□ 新增材料的关键日期提取正确
□ 时间线日期格式统一
```

### Checkpoint 8: 最终质量验证

```
□ 报告文件名正确（{债权人}_事实核查报告_round{N}.md）
□ 报告保存位置正确（round_N/工作底稿/）
□ 报告内容完整（包含所有必需章节）
□ 报告格式符合模板标准
□ 无占位符或"TBD"残留
```

---

## 常见错误与防范

### 错误1: 错误地进入增量模式

**症状**: 在Round 1或processing_mode="full"时尝试读取前轮报告。

**原因**: 未正确识别处理模式。

**防范**:
```python
IF round_number == 1 OR processing_mode == "full":
    → 执行标准事实核查工作流
    → 不要尝试读取前轮报告
```

### 错误2: 复制前轮报告时包含了轮次标记

**症状**: 复制的章节内容包含"（Round 1）"或"（第一轮）"等标记。

**原因**: 未清理前轮报告的轮次标识。

**防范**: 复制章节时剥离轮次标记，或在新报告中统一标注当前轮次。

### 错误3: 未更新章节依赖

**症状**: 更新了第三章（主要事实），但第四章（证据汇总）仍然是旧内容。

**原因**: 未理解章节依赖关系。

**防范**: 严格遵守章节依赖规则（见上文"章节依赖关系"）。

### 错误4: 时间线事件重复

**症状**: 合并时间线时，前轮事件和新事件都包含了，但有重复。

**原因**: 未去重。

**防范**:
```python
前轮事件 = extract_timeline(前轮报告)
新事件 = extract_timeline(新材料)

合并事件 = 前轮事件 + 新事件
合并事件 = deduplicate_by_date(合并事件)  # 去重
合并事件 = sort_by_date(合并事件)  # 排序
```

### 错误5: 破产日期不一致

**症状**: 新报告中的破产日期与前轮不同。

**原因**: 未从前轮配置读取日期，或错误地使用了新配置。

**防范**: **始终**从`project_config.ini`或前轮报告读取破产日期，确保全局一致。

---

## 示例场景

### 场景1: 补充生效判决书（Incremental模式）

**变更字段**: `judgment_document`

**影响范围**:
- 受影响章节：三.3、四、五、六
- 未受影响章节：一、二、三.1、三.2

**执行步骤**:

1. 读取前轮报告 `round_1/工作底稿/债权人_事实核查报告.md`
2. 复制未受影响章节：
   - 第一章：申报情况 ✓
   - 第二章：形式性文件核查 ✓
   - 第三章第1节：合同文件核查 ✓
   - 第三章第2节：履行证据核查 ✓
3. 读取新增材料 `round_2/输入材料/判决书.pdf`
4. 重新核查受影响章节：
   - 第三章第3节：法律文书核查 → 完整重做
5. 自动联动更新：
   - 第四章：证据情况汇总 → 添加判决书到清单
   - 第五章：时间线 → 添加判决日期事件
   - 第六章：核查结论 → 修正为"以生效判决为准"
6. 合并生成新报告 `round_2/工作底稿/债权人_事实核查报告_round2.md`

**预期时间节省**: 60-70%（复制了40%内容，重新核查了60%内容，但核查速度更快）

### 场景2: 更新联系方式（Partial模式）

**变更字段**: `creditor_contact`

**影响范围**:
- 受影响章节：一.1
- 未受影响章节：全部其他章节

**执行步骤**:

1. 读取前轮报告 `round_1/工作底稿/债权人_事实核查报告.md`
2. 定位字段位置：`### 1.1 债权人基本信息` → `联系电话：...`
3. 替换字段值：`138****0000` → `139****1111`
4. 保存新报告 `round_2/工作底稿/债权人_事实核查报告_round2.md`

**预期时间节省**: 95%+（仅字符串替换）

---

## 最佳实践

### 1. 始终先读取元数据

```
第一步永远是：读取 .round_metadata.json
目的：确定处理模式、父轮次、变更字段
```

### 2. 保守策略优先

```
IF 不确定某章节是否受影响:
    → 选择重新核查（宁可多做，不可遗漏）
```

### 3. 保持格式一致性

```
复制前轮内容时：
- 保持章节编号一致
- 保持表格格式一致
- 保持日期格式一致
- 不添加新的轮次标识（如"（Round 2）"）
```

### 4. 时间线合并技巧

```python
# 推荐做法
前轮时间线 = [
    {"日期": "2023-01-01", "事件": "签订合同"},
    {"日期": "2023-06-01", "事件": "交付货物"}
]

新时间线 = [
    {"日期": "2024-05-01", "事件": "生效判决"}
]

合并后 = 前轮时间线 + 新时间线
合并后.sort(key=lambda x: x["日期"])  # 按日期排序
```

### 5. 证据清单合并技巧

```markdown
# 前轮证据清单
| 序号 | 证据名称 | 证据类型 | 页码范围 |
|------|----------|----------|----------|
| 1 | 买卖合同 | 合同 | 1-5 |
| 2 | 银行流水 | 履行证据 | 6-10 |

# 新增证据
| 3 | 生效判决书 | 法律文书 | 11-20 |

# 合并后（序号连续）
| 序号 | 证据名称 | 证据类型 | 页码范围 |
|------|----------|----------|----------|
| 1 | 买卖合同 | 合同 | 1-5 |
| 2 | 银行流水 | 履行证据 | 6-10 |
| 3 | 生效判决书 | 法律文书 | 11-20 |
```

---

## 总结

增量事实核查的核心思想：
1. **识别**: 准确识别受影响范围
2. **复用**: 最大化复用前轮成果
3. **聚焦**: 集中精力处理变更部分
4. **合并**: 无缝合并新旧内容
5. **一致**: 保持全局一致性（格式、日期、结论）

**关键成功因素**:
- ✅ 正确读取并理解元数据
- ✅ 准确识别受影响章节
- ✅ 严格遵守章节依赖规则
- ✅ 保持日期全局一致
- ✅ 执行完整质量检查

**效率收益**:
- Incremental模式：60-75%时间节省
- Partial模式：85%+时间节省

---

**文档版本**: v3.0
**最后更新**: 2025-11-12
**相关文档**:
- `MULTI_ROUND_TECHNICAL_DESIGN.md` - 技术设计
- `config/impact_mappings.py` - 影响范围映射表
- `config/field_priorities.py` - 字段优先级分类
