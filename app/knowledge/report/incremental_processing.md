# 报告整理增量处理指南

**版本**: v3.0
**适用Agent**: report-organizer
**处理模式**: Incremental / Partial

---

## 目录

1. [增量整理概述](#增量整理概述)
2. [处理模式识别](#处理模式识别)
3. [前轮报告读取](#前轮报告读取)
4. [章节级别更新](#章节级别更新)
5. [报告合并策略](#报告合并策略)
6. [格式转换处理](#格式转换处理)
7. [质量检查点](#质量检查点)

---

## 增量整理概述

### 什么是增量报告整理？

**定义**: 在补充材料场景下，仅对受影响的报告章节进行重新整理，未受影响的章节直接继承前轮内容。

### 报告章节结构

**标准审查意见表结构**:

```
一、债权人基本信息           ← 对应事实核查第一章
二、债权申报情况             ← 对应事实核查第一章 + 债权分析第一章
三、事实查明与证据认定       ← 对应事实核查第三章
四、债权金额确认意见         ← 对应债权分析第二章
五、综合审查意见             ← 综合两个技术报告
六、备注说明                 ← 补充信息
```

### 增量整理的效率优势

| 场景 | Full模式 | Incremental模式 | 效率提升 |
|------|----------|-----------------|----------|
| 补充生效判决 | 重新整理全部章节 | 仅更新第三、四、五章 | 60-70% |
| 更新联系方式 | 重新整理全部章节 | 仅更新第一章 | 90%+ |
| 补充银行流水 | 重新整理全部章节 | 仅更新第三、四、五章 | 65-75% |

---

## 处理模式识别

### Step 1: 读取轮次元数据

**MANDATORY**: 必须首先读取`.round_metadata.json`。

```json
{
  "round_number": 2,
  "processing_mode": "incremental",
  "parent_round": 1,
  "fields_updated": [
    "judgment_document"
  ],
  "affected_stages": [1, 2, 3],
  "affected_sections": [3, 4, 5],  // ← 关键：受影响的报告章节
  "affected_debt_items": ["ALL"]
}
```

### Step 2: 章节影响识别

**字段变更 → 报告章节影响映射**:

| 变更字段 | 受影响报告章节 | 原因 |
|----------|---------------|------|
| `creditor_contact` | 一 | 债权人基本信息需要更新联系方式 |
| `judgment_document` | 三、四、五 | 证据认定、金额确认、综合意见都需更新 |
| `interest_rate_clause` | 四、五 | 金额确认（利息部分）和综合意见需更新 |
| `bankruptcy_date` | ALL | 破产日期影响所有章节 |

**完整映射**: 参考 `config/impact_mappings.py`

### Step 3: 章节依赖关系

```
第一章（基本信息）
  ↓ 无依赖
第二章（申报情况）
  ↓ 依赖第一章
第三章（事实查明）
  ↓ 依赖第一、二章
第四章（金额确认）
  ↓ 依赖第二、三章
第五章（综合意见）
  ↓ 依赖所有前章（一、二、三、四）
第六章（备注说明）
  ↓ 无依赖
```

**依赖规则应用**:

```python
# 伪代码
directly_affected = metadata["affected_sections"]  # [3, 4]

# 应用依赖规则
if 3 in directly_affected:  # 第三章受影响
    # 依赖第三章的章节也需要更新
    also_update = [4, 5]  # 第四、五章

needs_update = set(directly_affected) | set(also_update)
# 结果: {3, 4, 5}
```

---

## 前轮报告读取

### Step 1: 定位前轮最终报告

```bash
# 前轮最终报告位置
round_{parent}/最终报告/GY2025_{债权人}_债权审查报告_{YYYYMMDD}.md
```

**示例**:
```bash
# Round 2的parent_round=1，读取:
round_1/最终报告/GY2025_慈溪市东航建筑_债权审查报告_20251101.md
```

### Step 2: 前轮技术报告读取

```bash
# 前轮事实核查报告
round_{parent}/工作底稿/{债权人}_事实核查报告.md

# 前轮债权分析报告
round_{parent}/工作底稿/{债权人}_债权分析报告.md
```

**用途**: 用于验证前轮整理是否正确，以及理解章节来源。

### Step 3: 报告结构解析

**标准章节提取**:

```python
# 伪代码
前轮报告内容 = read_file(前轮最终报告路径)

章节内容 = {
    1: extract_chapter(前轮报告内容, "一、债权人基本信息"),
    2: extract_chapter(前轮报告内容, "二、债权申报情况"),
    3: extract_chapter(前轮报告内容, "三、事实查明与证据认定"),
    4: extract_chapter(前轮报告内容, "四、债权金额确认意见"),
    5: extract_chapter(前轮报告内容, "五、综合审查意见"),
    6: extract_chapter(前轮报告内容, "六、备注说明")
}
```

---

## 章节级别更新

### 策略A: 章节级增量（Incremental模式）

**核心原则**: 以章节为单位进行增量处理。

**步骤**:

1. **读取前轮最终报告和本轮技术报告**
   ```
   前轮最终报告: round_1/最终报告/GY2025_xxx.md
   本轮事实核查: round_2/工作底稿/事实核查报告_round2.md
   本轮债权分析: round_2/工作底稿/债权分析报告_round2.md
   ```

2. **识别受影响章节**
   ```
   affected_sections = [3, 4, 5]  # 从元数据读取
   ```

3. **分类处理章节**
   ```python
   FOR EACH chapter IN [1, 2, 3, 4, 5, 6]:
       IF chapter NOT IN affected_sections:
           # 继承前轮
           新报告[chapter] = 前轮报告[chapter]
       ELSE:
           # 重新整理
           新报告[chapter] = reorganize_from_technical_reports(
               fact_report=本轮事实核查,
               analysis_report=本轮债权分析,
               chapter_number=chapter
           )
   ```

4. **应用客户模板格式**
   ```
   对于重新整理的章节，应用标准格式转换：
   - 移除Markdown heading syntax (##)
   - 转换为中文章节标号（一、二、三、）
   - 转换bullet lists为完整句子
   - 移除bold markers (**)
   ```

5. **生成新报告**

### 策略B: 字段级增量（Partial模式）

**适用场景**: LOW优先级字段变更（如联系方式）

**步骤**:

1. **读取前轮最终报告**
2. **定位字段位置**（如第一章中的联系电话）
3. **直接替换字段值**
4. **保存新报告**

**示例**:

```python
# 伪代码 - Partial模式更新联系方式
前轮报告 = read_file("round_1/最终报告/GY2025_xxx.md")

# 定位并替换
前轮报告 = 前轮报告.replace(
    old="联系电话：138****0000",
    new="联系电话：139****1111"
)

# 保存
write_file("round_2/最终报告/GY2025_xxx_round2.md", 前轮报告)
```

### 章节整理来源映射

**报告章节 ← 技术报告章节映射表**:

| 最终报告章节 | 来源（事实核查） | 来源（债权分析） | 整理方式 |
|-------------|-----------------|----------------|---------|
| 一、债权人基本信息 | 一.1 债权人基本信息 | - | 直接提取 |
| 二、债权申报情况 | 一.2 申报金额构成 | 一、债权申报情况分析 | 合并提取 |
| 三、事实查明与证据认定 | 三、债权形成的主要事实 | - | 转换格式提取 |
| 四、债权金额确认意见 | - | 二、债权金额确认分析 | 转换格式提取 |
| 五、综合审查意见 | 六、核查结论 | 六、债权确认结论 | 综合两个结论 |
| 六、备注说明 | （各章节备注） | （各章节备注） | 汇总提取 |

---

## 报告合并策略

### 方法1: 章节拼接法（推荐）

```markdown
# 合并伪代码

新报告 = ""

# 第一章：债权人基本信息
IF 1 NOT IN affected_sections:
    新报告 += 复制(前轮报告["一、债权人基本信息"])
ELSE:
    新报告 += 整理(本轮事实核查["一.1 债权人基本信息"])

# 第二章：债权申报情况
IF 2 NOT IN affected_sections:
    新报告 += 复制(前轮报告["二、债权申报情况"])
ELSE:
    新报告 += 整理(
        本轮事实核查["一.2 申报金额构成"],
        本轮债权分析["一、债权申报情况分析"]
    )

# 第三章：事实查明与证据认定
IF 3 IN affected_sections:  # 最常受影响
    新报告 += 整理(本轮事实核查["三、债权形成的主要事实"])
ELSE:
    新报告 += 复制(前轮报告["三、事实查明与证据认定"])

# 第四章：债权金额确认意见
IF 4 IN affected_sections:
    新报告 += 整理(本轮债权分析["二、债权金额确认分析"])
ELSE:
    新报告 += 复制(前轮报告["四、债权金额确认意见"])

# 第五章：综合审查意见（最依赖前章）
IF any([1, 2, 3, 4]) IN affected_sections:
    # 任何前章受影响，第五章都需要重新整理
    新报告 += 整理(
        本轮事实核查["六、核查结论"],
        本轮债权分析["六、债权确认结论"]
    )
ELSE:
    新报告 += 复制(前轮报告["五、综合审查意见"])

# 第六章：备注说明
新报告 += 整理备注(
    本轮事实核查["各章节备注"],
    本轮债权分析["各章节备注"],
    本轮补充说明
)
```

### 方法2: 段落级精细合并（高级）

**适用场景**: 章节内部分段落受影响，其他段落未受影响。

**示例 - 第三章部分段落更新**:

```markdown
# 前轮第三章结构
三、事实查明与证据认定
  （一）合同关系认定       ← 未受影响
  （二）履行情况认定       ← 未受影响
  （三）生效法律文书认定   ← 受影响（新增判决书）

# 合并策略
新第三章 = ""
新第三章 += 复制(前轮["（一）合同关系认定"])  # 继承
新第三章 += 复制(前轮["（二）履行情况认定"])  # 继承
新第三章 += 整理(本轮事实核查["3.3 法律文书核查"])  # 重新整理
```

### 格式转换注意事项

**CRITICAL**: 整理时必须应用格式转换，移除Markdown语法。

**禁止的格式** (技术报告格式):
```markdown
## 一、申报情况
### 1.1 债权人基本信息
- 债权人名称：xxx
- **联系电话**：138****0000
```

**要求的格式** (最终报告格式):
```
一、债权人基本信息

债权人名称为xxx，联系电话为138****0000...
```

**转换规则**:
- ✅ `##` heading → 中文章节号（一、二、三、）
- ✅ `###` subheading → 中文小标题（（一）、（二）、）或段落句子
- ✅ `- bullet list` → 完整句子
- ✅ `**bold**` → 普通文本
- ✅ 表格 → 保留（但可能需要简化）

---

## 格式转换处理

### 转换规则详解

#### 规则1: 标题转换

**技术报告**:
```markdown
### 3.1 合同文件核查

根据债权人提供的《买卖合同》...
```

**最终报告**:
```
（一）合同关系认定

根据债权人提供的买卖合同...
```

#### 规则2: 列表转换

**技术报告**:
```markdown
债权人申报金额构成如下：
- 本金：100,000元
- 利息：8,000元
- 违约金：15,000元
```

**最终报告**:
```
债权人申报金额包括本金100,000元、利息8,000元、违约金15,000元。
```

#### 规则3: 加粗转换

**技术报告**:
```markdown
最终确认本金：**100,000元**。
```

**最终报告**:
```
最终确认本金100,000元。
```

#### 规则4: 表格简化（可选）

**技术报告**（详细表格）:
```markdown
| 债权项 | 申报金额（元） | 计算金额（元） | 确认金额（元） | 备注 |
|--------|---------------|---------------|---------------|------|
| 本金 | 100,000 | 100,000 | 100,000 | 一致 |
```

**最终报告**（简化表格或文字）:
```
本金申报金额100,000元，经审查与合同约定一致，确认100,000元。
```

### 格式转换工具函数（伪代码）

```python
def convert_to_final_report_format(technical_content: str) -> str:
    """将技术报告格式转换为最终报告格式"""

    # 1. 移除Markdown heading markers
    content = re.sub(r'^##\s+', '', technical_content, flags=re.MULTILINE)
    content = re.sub(r'^###\s+', '', content, flags=re.MULTILINE)

    # 2. 转换章节编号
    content = content.replace("一、", "一、")  # 保持一级标题
    content = content.replace("1.1", "（一）")  # 转换子标题
    content = content.replace("1.2", "（二）")

    # 3. 转换列表为句子
    content = convert_bullet_lists_to_sentences(content)

    # 4. 移除bold markers
    content = re.sub(r'\*\*(.*?)\*\*', r'\1', content)

    # 5. 简化表格（可选）
    content = simplify_tables_if_needed(content)

    return content
```

---

## 质量检查点

### Checkpoint 1: 模式识别验证

```
□ 已读取 .round_metadata.json
□ 处理模式识别正确（full/incremental/partial）
□ 受影响章节清单完整
□ 父轮次号正确
```

### Checkpoint 2: 前轮报告读取验证

```
□ 前轮最终报告路径正确
□ 前轮最终报告文件存在且完整
□ 前轮章节结构解析正确
□ 本轮技术报告存在且可读
```

### Checkpoint 3: 章节处理验证

```
□ 未受影响章节正确复制（内容一字不差）
□ 受影响章节从本轮技术报告重新整理
□ 章节依赖关系应用正确
□ 所有必需章节存在（一至六章）
```

### Checkpoint 4: 格式转换验证（CRITICAL）

```
□ 无Markdown heading syntax (## 或 ###)
□ 无bullet list markers (- 或 *)
□ 无bold markers (**)
□ 章节编号使用中文（一、二、三、）
□ 读起来像正式法律文档（不像技术报告）
```

**格式检查命令** (必须在最终报告上运行):

```bash
# 1. 检查Markdown headings
grep -n "^##" 最终报告.md
# 预期：无输出

# 2. 检查bullet lists
grep -n "^- " 最终报告.md
# 预期：无输出

# 3. 检查bold markers
grep -n "\*\*" 最终报告.md
# 预期：无输出
```

### Checkpoint 5: 内容一致性验证

```
□ 章节顺序正确（一、二、三、四、五、六）
□ 债权人名称一致（各章节）
□ 金额数据一致（与技术报告）
□ 日期一致（破产日期、停止计息日）
```

### Checkpoint 6: 文件管理验证

```
□ 文件名正确: GY2025_{债权人}_债权审查报告_{YYYYMMDD}.md
□ 文件位置正确: round_N/最终报告/
□ 文件清单已生成: 文件清单.md
□ 文件清单内容准确（列出所有生成文件）
```

### Checkpoint 7: 继承标注验证（可选）

```
□ 继承的章节末尾有标注（如需追溯）
□ 标注格式: "> 注：本章节未受影响，内容继承Round {N}。"
□ 标注位置: 章节末尾
```

### Checkpoint 8: 最终质量验证

```
□ 报告完整（包含所有必需章节）
□ 格式符合客户模板要求
□ 无占位符或"TBD"残留
□ 无技术术语或内部标记
□ 读起来专业、正式、连贯
```

---

## 常见错误与防范

### 错误1: 复制前轮报告时包含格式问题

**症状**: 复制的章节包含了Markdown语法或不规范格式。

**原因**: 前轮报告本身可能存在格式问题。

**防范**: 即使复制前轮内容，也要进行格式验证，必要时重新格式化。

### 错误2: 章节编号不连续

**症状**: 第一章、第二章、第四章（缺第三章）。

**原因**: 合并时遗漏了某章节。

**防范**: 使用章节清单检查，确保1-6章全部存在。

### 错误3: 未应用章节依赖规则

**症状**: 第三章重新整理了，但第五章（依赖第三章）仍是旧内容。

**原因**: 未理解章节依赖关系。

**防范**: 严格遵守依赖规则（见"章节依赖关系"部分）。

### 错误4: 格式转换不彻底

**症状**: 最终报告中仍有`##`、`-`、`**`等Markdown标记。

**原因**: 未执行格式转换，或转换不完整。

**防范**: 使用grep命令检查（见Checkpoint 4），确保零容忍。

### 错误5: 金额数据不一致

**症状**: 最终报告中的确认金额与债权分析报告不同。

**原因**: 手动输入错误，或复制时遗漏。

**防范**: 直接从技术报告提取数据，不手动输入；最后交叉验证。

### 错误6: 文件命名错误

**症状**: 文件名不符合标准（如缺少日期、轮次号错误）。

**原因**: 未使用标准命名模板。

**防范**: 严格遵守命名规范: `GY2025_{债权人}_债权审查报告_{YYYYMMDD}.md`

---

## 示例场景

### 场景1: 补充生效判决书（Incremental模式）

**变更字段**: `judgment_document`

**受影响章节**: 三、四、五

**执行步骤**:

1. **读取前轮最终报告**
   ```
   round_1/最终报告/GY2025_慈溪市东航建筑_债权审查报告_20251101.md
   ```

2. **读取本轮技术报告**
   ```
   round_2/工作底稿/事实核查报告_round2.md
   round_2/工作底稿/债权分析报告_round2.md
   ```

3. **识别受影响章节**
   ```
   affected_sections = [3, 4, 5]
   unaffected_sections = [1, 2, 6]
   ```

4. **继承未受影响章节**
   ```markdown
   # 新报告
   一、债权人基本信息
   【从Round 1最终报告完整复制】

   二、债权申报情况
   【从Round 1最终报告完整复制】
   ```

5. **重新整理受影响章节**
   ```markdown
   # 新报告
   三、事实查明与证据认定

   【从Round 2事实核查报告整理】
   根据债权人补充提供的生效判决书（（2024）浙02民初123号）...

   （一）合同关系认定
   【继承Round 1内容，或从Round 2重新提取】

   （二）履行情况认定
   【继承Round 1内容，或从Round 2重新提取】

   （三）生效法律文书认定  ← 新增或更新
   【从Round 2事实核查报告"3.3 法律文书核查"整理】
   生效判决书确认的主要事实如下...判决债务人向债权人支付本金100,000元及利息...

   四、债权金额确认意见
   【从Round 2债权分析报告整理】
   根据生效判决书认定，债权人债权确认如下...

   五、综合审查意见
   【综合Round 2两个技术报告的结论】
   综合本轮审查，债权人提供的生效判决书...最终确认债权总额XXX元。
   ```

6. **应用格式转换**
   ```
   - 移除所有Markdown语法
   - 转换章节编号为中文
   - 转换列表为完整句子
   ```

7. **保存新报告**
   ```
   round_2/最终报告/GY2025_慈溪市东航建筑_债权审查报告_20251112.md
   ```

**预期时间节省**: 65-70%（继承了第一、二、六章，仅重新整理第三、四、五章）

### 场景2: 更新联系方式（Partial模式）

**变更字段**: `creditor_contact`

**受影响章节**: 一

**执行步骤**:

1. **读取前轮最终报告**
   ```python
   前轮报告 = read_file("round_1/最终报告/GY2025_xxx.md")
   ```

2. **定位字段位置**
   ```python
   # 在"一、债权人基本信息"章节中查找
   pattern = r"联系电话[:：]\s*138\*\*\*\*0000"
   ```

3. **替换字段值**
   ```python
   新报告 = re.sub(pattern, "联系电话：139****1111", 前轮报告)
   ```

4. **更新报告日期和文件名**
   ```
   保存为: GY2025_xxx_债权审查报告_20251112.md
   （日期更新为当前日期）
   ```

5. **保存新报告**

**预期时间节省**: 95%+（仅字符串替换）

---

## 最佳实践

### 1. 始终先读取元数据

```
第一步：读取 .round_metadata.json
目的：确定处理模式、受影响章节、父轮次
```

### 2. 保守策略优先

```
IF 不确定某章节是否受影响:
    → 选择重新整理（宁可多做，不可遗漏）
```

### 3. 格式转换零容忍

```
最终报告中绝对不允许出现：
- Markdown heading markers (##, ###)
- Bullet list markers (-, *)
- Bold markers (**)

执行命令检查，确保零违规。
```

### 4. 章节完整性检查

```python
# 推荐做法 - 生成报告后检查
章节清单 = ["一、", "二、", "三、", "四、", "五、", "六、"]

for 章节 in 章节清单:
    assert 章节 in 新报告, f"缺少章节: {章节}"
```

### 5. 金额数据交叉验证

```
最终报告中的确认金额 == 债权分析报告中的确认金额

验证方法：
1. 从债权分析报告提取确认值
2. 从最终报告提取确认值
3. 逐项比对
```

---

## 总结

报告整理增量处理的核心：
1. **章节级增量**: 以章节为单位进行增量整理
2. **依赖关系管理**: 准确识别章节依赖并联动更新
3. **格式转换严格**: 零容忍Markdown语法残留
4. **内容一致性**: 最终报告与技术报告数据完全一致
5. **专业化输出**: 最终报告读起来像正式法律文档

**关键成功因素**:
- ✅ 正确识别受影响章节
- ✅ 理解章节依赖关系
- ✅ 严格执行格式转换
- ✅ 保持数据一致性
- ✅ 完整的质量检查

**效率收益**:
- Incremental模式：60-75%时间节省
- Partial模式：90%+时间节省

---

**文档版本**: v3.0
**最后更新**: 2025-11-12
**相关文档**:
- `incremental_processing_guide.md` (fact-checking, debt-analysis)
- `config/impact_mappings.py` - 影响范围映射表
- `fact_checking_report_template.md` - 事实核查报告模板
- `debt_analysis_report_template.md` - 债权分析报告模板
