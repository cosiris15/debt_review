# 债权分析增量处理指南

**版本**: v3.0
**适用Agent**: debt-claim-analyzer
**处理模式**: Incremental / Partial

---

## 目录

1. [增量分析概述](#增量分析概述)
2. [处理模式识别](#处理模式识别)
3. [前轮报告读取](#前轮报告读取)
4. [债权项级别增量](#债权项级别增量)
5. [利息增量计算](#利息增量计算)
6. [报告合并策略](#报告合并策略)
7. [计算文件管理](#计算文件管理)

---

## 增量分析概述

### 什么是增量债权分析？

**定义**: 在补充材料场景下，仅对受影响的债权项目进行重新分析和计算，未受影响的债权项直接继承前轮结果。

### 债权项级别增量的优势

| 债权项 | Full模式 | Incremental模式 | 节省说明 |
|--------|----------|-----------------|----------|
| 本金 | 重新确认 | 继承前轮（如未受影响） | 无需重新分析合同和履行证据 |
| 利息 | 重新计算 | 继承前轮（如利率未变）| 无需重新运行计算器 |
| 违约金 | 重新计算 | 继承前轮（如约定未变）| 无需重新应用30%上限 |
| 诉讼时效 | 重新判断 | 继承前轮（如时效未变）| 无需重新分析诉讼时效 |

**整体效率**: Incremental模式可节省60-75%分析和计算时间。

---

## 处理模式识别

### Step 1: 读取轮次元数据

**MANDATORY**: 必须首先读取`.round_metadata.json`。

```json
{
  "round_number": 2,
  "processing_mode": "incremental",
  "parent_round": 1,
  "fields_updated": [
    "interest_rate_clause",  // ← 利率约定变更
    "payment_deadline"       // ← 付款期限变更
  ],
  "affected_stages": [2, 3],
  "affected_debt_items": [   // ← 关键：受影响的债权项
    "利息",
    "逾期利息"
  ]
}
```

### Step 2: 识别受影响债权项

**字段变更 → 受影响债权项映射**:

| 变更字段 | 受影响债权项 | 原因 |
|----------|--------------|------|
| `declared_principal` | 本金 | 就低原则可能导致本金确认值变化 |
| `declared_interest` | 利息 | 就低原则可能导致利息确认值变化 |
| `interest_rate_clause` | 利息、复利、逾期利息 | 利率变化需重新计算 |
| `penalty_clause` | 违约金、罚息 | 违约金约定变化需重新计算 |
| `payment_deadline` | 利息、逾期利息 | 起算日变化需重新计算 |
| `statute_of_limitations_status` | ALL | 时效状态变化影响全部债权项 |

**完整映射**: 参考 `config/impact_mappings.py`

### Step 3: 处理模式决策

```
IF processing_mode == "full":
    → 所有债权项重新分析
    → 所有计算重新执行
    → 生成全新报告

ELSE IF processing_mode == "incremental":
    → 仅受影响债权项重新分析
    → 仅受影响债权项重新计算
    → 未受影响债权项继承前轮
    → 合并生成新报告

ELSE IF processing_mode == "partial":
    → 仅更新特定字段（如申报金额）
    → 应用就低原则后确认值可能变化
    → 快速生成新报告
```

---

## 前轮报告读取

### Step 1: 定位前轮报告和计算文件

```bash
# 债权分析报告
round_{parent}/工作底稿/{债权人}_债权分析报告.md

# 计算过程文件
round_{parent}/计算文件/{债权人}_利息计算.xlsx
round_{parent}/计算文件/{债权人}_违约金计算.xlsx
```

### Step 2: 报告结构解析

**标准债权分析报告章节结构**:

```markdown
## 一、债权申报情况分析
  ### 1.1 申报金额构成
  ### 1.2 申报依据审查

## 二、债权金额确认分析
  ### 2.1 本金确认
  ### 2.2 利息确认
  ### 2.3 违约金确认
  ### 2.4 其他债权项确认

## 三、利息计算详细过程
  ### 3.1 利息计算依据
  ### 3.2 利率标准确定
  ### 3.3 计算过程
  ### 3.4 计算结果

## 四、诉讼时效分析
  ### 4.1 诉讼时效起算点
  ### 4.2 时效中断事由
  ### 4.3 时效状态判断

## 五、质量控制检查

## 六、债权确认结论
```

### Step 3: 提取前轮债权项确认值

**提取重点**:

```python
# 伪代码
前轮确认值 = {
    "本金": extract_value(前轮报告, "### 2.1 本金确认"),
    "利息": extract_value(前轮报告, "### 2.2 利息确认"),
    "违约金": extract_value(前轮报告, "### 2.3 违约金确认"),
    "诉讼时效状态": extract_value(前轮报告, "### 4.3 时效状态判断")
}
```

**提取示例**:

```markdown
# 从前轮报告提取
### 2.1 本金确认

经审查，债权人申报本金100,000元...最终确认本金：**100,000元**。
                                    ↑
                                提取这个值
```

---

## 债权项级别增量

### 核心原则：按债权项独立处理

**债权项清单**:
1. 本金
2. 利息
3. 违约金
4. 逾期利息
5. 罚息
6. 复利
7. 担保债权
8. 保证债权

### 策略1: 继承未受影响债权项（Incremental）

```python
# 伪代码
FOR EACH 债权项 IN ["本金", "利息", "违约金", ...]:
    IF 债权项 NOT IN affected_debt_items:
        # 直接继承
        新报告[债权项] = 前轮报告[债权项]
        新确认值[债权项] = 前轮确认值[债权项]

        # 标注继承来源（可选）
        新报告[债权项] += "\\n\\n> 注：本债权项未受本轮补充材料影响，结论继承Round 1。"
```

**示例**:

```markdown
# Round 2报告 - 未受影响债权项（本金）

### 2.1 本金确认

【从Round 1复制完整内容】

经审查，债权人申报本金100,000元，与合同约定金额一致...

最终确认本金：**100,000元**。

> 注：本债权项未受本轮补充材料影响，结论继承Round 1。
```

### 策略2: 重新分析受影响债权项（Incremental）

```python
# 伪代码
FOR EACH 债权项 IN affected_debt_items:
    IF 债权项 == "利息":
        # 重新读取利率约定
        新利率 = extract_rate(补充材料)

        # 重新运行计算器
        新利息 = universal_debt_calculator_cli.py(
            principal=本金确认值,
            rate=新利率,
            start_date=付款期限,
            end_date=停止计息日
        )

        # 生成新的利息确认章节
        新报告["利息"] = generate_interest_section(新利息, 计算过程)

    ELSE IF 债权项 == "违约金":
        # 重新分析违约金约定
        # ...
```

### 债权项依赖关系管理

**关键依赖**:

```
本金
  ↓ 依赖（利息以本金为基数）
利息、复利、逾期利息
  ↓
违约金（可能依赖本金+利息总额）
```

**依赖规则**:

```
IF 本金变更:
    → 所有以本金为基数的债权项（利息、复利）必须重新计算

IF 利息计算方式变更:
    → 复利、逾期利息可能需要重新计算

IF 任何金额债权项变更:
    → 违约金30%上限检查必须重新执行
```

---

## 利息增量计算

### 场景1: 利率约定变更

**触发条件**: `interest_rate_clause`字段变更

**执行步骤**:

1. **继承本金确认值**（如本金未变）
   ```
   本金确认值 = 前轮确认值["本金"] = 100,000元
   ```

2. **读取新利率约定**
   ```
   从补充材料读取新的利率约定：LPR 1年期 × 1.5
   ```

3. **重新运行计算器**
   ```bash
   python universal_debt_calculator_cli.py lpr \
       --principal 100000 \
       --start-date 2023-01-01 \
       --end-date 2024-12-30 \
       --multiplier 1.5 \
       --lpr-term 1y
   ```

4. **生成新的利息确认章节**
   ```markdown
   ### 2.2 利息确认

   根据补充提供的《补充协议》，利率约定调整为...

   使用universal_debt_calculator_cli.py计算：
   - 本金基数：100,000元（继承Round 1确认值）
   - 利率标准：LPR 1年期 × 1.5
   - 计息期间：2023-01-01至2024-12-30
   - 计算结果：8,500元

   最终确认利息：**8,500元**（调整后，原Round 1确认7,200元）
   ```

### 场景2: 付款期限变更

**触发条件**: `payment_deadline`字段变更

**影响**: 利息起算日变化 → 利息金额变化

**执行步骤**:

1. **继承本金和利率**（如未变）
   ```
   本金 = 前轮确认值["本金"] = 100,000元
   利率 = 前轮利率 = 年利率4.35%
   ```

2. **更新起算日**
   ```
   旧起算日: 2023-01-01（Round 1）
   新起算日: 2023-03-01（根据补充合同更正）
   ```

3. **重新计算利息**
   ```bash
   python universal_debt_calculator_cli.py simple \
       --principal 100000 \
       --start-date 2023-03-01 \  # ← 新起算日
       --end-date 2024-12-30 \
       --rate 4.35
   ```

4. **说明调整原因**
   ```markdown
   ### 2.2 利息确认

   根据补充提供的《补充协议》，付款期限更正为2023年3月1日...

   利息重新计算如下：
   - 计息起算日：2023-03-01（更正后，原为2023-01-01）
   - 计息终止日：2024-12-30
   - 实际计息天数：669天（调整后，原为729天）

   最终确认利息：**7,500元**（调整后，原Round 1确认8,200元）
   ```

### 场景3: 申报金额变更但计算逻辑未变

**触发条件**: `declared_interest`字段变更

**应用就低原则**:

```python
# 伪代码
旧申报利息 = 8,000元  # Round 1
计算利息 = 8,200元    # 计算结果（未变）

新申报利息 = 7,500元  # Round 2（债权人主动调低）

# 应用就低原则
新确认利息 = min(计算利息, 新申报利息) = 7,500元
```

**报告说明**:

```markdown
### 2.2 利息确认

经计算，利息金额为8,200元。

债权人在本轮申报中主动调低利息申报金额至7,500元。

根据就低原则，最终确认利息：**7,500元**。
```

### 利息计算文件管理

**前轮计算文件复用**:

```
IF 利息计算参数未变:
    → 继承前轮计算文件：
      cp round_1/计算文件/利息计算.xlsx round_2/计算文件/

ELSE:
    → 重新生成计算文件（通过calculator生成）
```

---

## 报告合并策略

### 方法1: 章节级合并（推荐用于Incremental）

```markdown
# 合并伪代码

新报告 = ""

# 第一章：申报情况分析
IF "申报情况" 未受影响:
    新报告 += 复制(前轮报告["## 一、债权申报情况分析"])
ELSE:
    新报告 += 重新分析("## 一、债权申报情况分析")

# 第二章：金额确认分析（最可能受影响）
新报告 += "## 二、债权金额确认分析\\n"

# 2.1 本金确认
IF "本金" NOT IN affected_debt_items:
    新报告 += 复制(前轮报告["### 2.1 本金确认"])
ELSE:
    新报告 += 重新分析("### 2.1 本金确认")

# 2.2 利息确认
IF "利息" IN affected_debt_items:
    新报告 += 重新计算并分析("### 2.2 利息确认")
ELSE:
    新报告 += 复制(前轮报告["### 2.2 利息确认"])

# 2.3 违约金确认
IF "违约金" IN affected_debt_items:
    新报告 += 重新计算并分析("### 2.3 违约金确认")
ELSE:
    新报告 += 复制(前轮报告["### 2.3 违约金确认"])

# 第三章：利息计算（依赖第二章）
IF "利息" IN affected_debt_items:
    新报告 += 重新生成("## 三、利息计算详细过程")
ELSE:
    新报告 += 复制(前轮报告["## 三、利息计算详细过程"])

# 第四章：诉讼时效
IF "诉讼时效" 受影响:
    新报告 += 重新分析("## 四、诉讼时效分析")
ELSE:
    新报告 += 复制(前轮报告["## 四、诉讼时效分析"])

# 第五章、第六章：总是重新生成
新报告 += 重新生成("## 五、质量控制检查")
新报告 += 重新生成("## 六、债权确认结论")
```

### 方法2: 债权项级合并（精细化）

```python
# 针对第二章的精细化合并

def merge_debt_item_section(item_name, affected_items, prev_report):
    section_key = f"### 2.{item_index} {item_name}确认"

    if item_name NOT IN affected_items:
        # 继承前轮
        content = extract_section(prev_report, section_key)
        content += "\\n\\n> 注：本债权项未受影响，结论继承前轮。"
        return content
    else:
        # 重新分析
        return reanalyze_debt_item(item_name)

# 应用到所有债权项
for item in ["本金", "利息", "违约金", "逾期利息", ...]:
    section = merge_debt_item_section(item, affected_debt_items, prev_report)
    new_report += section
```

### 确认值汇总表合并

**前轮确认值表**:

```markdown
| 债权项 | 申报金额（元） | 确认金额（元） | 备注 |
|--------|---------------|---------------|------|
| 本金 | 100,000 | 100,000 | 与合同一致 |
| 利息 | 8,000 | 7,200 | 按LPR计算，就低原则 |
| 违约金 | 15,000 | 12,000 | 应用30%上限 |
| 合计 | 123,000 | 119,200 | - |
```

**新轮确认值表**（利息变更）:

```markdown
| 债权项 | 申报金额（元） | 确认金额（元） | 备注 | 变更说明 |
|--------|---------------|---------------|------|----------|
| 本金 | 100,000 | 100,000 | 与合同一致 | 未变 |
| 利息 | 8,000 | 8,500 | 按调整后利率计算 | Round 2更新 ⬆ |
| 违约金 | 15,000 | 12,000 | 应用30%上限 | 未变 |
| 合计 | 123,000 | 120,500 | - | Round 2总额调整 |
```

**合并技巧**:
- ✅ 未变债权项：保持前轮值，标注"未变"
- ✅ 变更债权项：更新新值，标注"Round N更新"，可用箭头(⬆⬇)表示增减
- ✅ 合计：重新计算总和

---

## 计算文件管理

### 计算文件继承规则

```
IF 债权项未受影响:
    → 复制前轮计算文件
    cp round_1/计算文件/利息计算.xlsx round_2/计算文件/

ELSE:
    → 重新生成计算文件
    python universal_debt_calculator_cli.py ... --output round_2/计算文件/利息计算_round2.xlsx
```

### 计算文件命名规范

**前轮**:
```
round_1/计算文件/
├── 债权人_利息计算.xlsx
├── 债权人_违约金计算.xlsx
└── 债权人_复利计算.xlsx
```

**新轮**（Incremental模式，仅利息变更）:
```
round_2/计算文件/
├── 债权人_利息计算_round2.xlsx  ← 重新生成
├── 债权人_违约金计算.xlsx       ← 从round_1复制
└── 债权人_复利计算.xlsx         ← 从round_1复制
```

### 无计算情况处理

**如Round 1就没有计算（如债权人未申报利息）**:

```
IF round_1/计算文件/ 为空或只有说明TXT:
    → Round 2也无需计算（除非新增了计算项）

IF Round 2新增计算项（如新申报了利息）:
    → 生成新计算文件，视为全新计算
```

---

## 质量检查点

### Checkpoint 1: 模式识别验证

```
□ 已读取 .round_metadata.json
□ 处理模式识别正确
□ 受影响债权项清单完整
□ 父轮次号正确
```

### Checkpoint 2: 前轮报告读取验证

```
□ 前轮债权分析报告路径正确
□ 前轮报告文件存在且完整
□ 前轮确认值提取正确
□ 前轮计算文件识别正确
```

### Checkpoint 3: 债权项级别处理验证

```
□ 未受影响债权项正确继承（值和内容一致）
□ 受影响债权项完全重新分析（未遗漏）
□ 债权项依赖关系处理正确（如本金变→利息重算）
□ 继承标注清晰（"继承Round N"）
```

### Checkpoint 4: 计算器使用验证（CRITICAL）

```
□ 所有利息计算使用universal_debt_calculator_cli.py
□ 计算命令记录在报告中
□ 计算参数正确（本金、利率、日期）
□ 计算结果文件生成在round_N/计算文件/
```

### Checkpoint 5: 就低原则验证

```
□ 确认值 ≤ 申报值（每个债权项）
□ 如计算值 > 申报值，取申报值并说明就低原则
□ 合计金额正确（各债权项之和）
```

### Checkpoint 6: 日期一致性验证（CRITICAL）

```
□ 破产日期与前轮一致
□ 停止计息日与前轮一致
□ 如计息起算日变更，在报告中明确说明原因
```

### Checkpoint 7: 报告合并质量验证

```
□ 所有债权项章节完整（2.1, 2.2, 2.3, ...）
□ 章节顺序正确
□ 无重复债权项
□ 确认值汇总表正确
□ 最终结论总金额正确
```

### Checkpoint 8: 计算文件管理验证

```
□ 受影响债权项有新计算文件
□ 未受影响债权项计算文件已复制
□ 无计算情况有说明TXT文件
□ 文件命名符合规范
```

---

## 常见错误与防范

### 错误1: 未识别债权项依赖关系

**症状**: 本金确认值变更了，但利息仍使用旧本金计算。

**原因**: 未理解债权项依赖关系。

**防范**:
```python
IF "本金" IN affected_debt_items:
    # 强制将所有以本金为基数的债权项标记为受影响
    affected_debt_items.add("利息")
    affected_debt_items.add("复利")
    affected_debt_items.add("逾期利息")
```

### 错误2: 继承前轮值但未标注

**症状**: 债权项值继承了前轮，但报告中没有说明，导致无法追溯。

**原因**: 未添加继承标注。

**防范**: 所有继承内容末尾添加 `> 注：本债权项未受影响，结论继承Round {N}。`

### 错误3: 确认值汇总表未更新

**症状**: 个别债权项确认值变更了，但汇总表中的合计仍是旧值。

**原因**: 未重新计算合计。

**防范**: 总是重新计算合计金额，不要手动复制。

### 错误4: 计算文件缺失

**症状**: 报告中说重新计算了利息，但计算文件/目录中没有对应的Excel文件。

**原因**: 未使用calculator生成Excel，或忘记输出到正确目录。

**防范**: 所有计算必须通过calculator生成Excel，检查输出路径。

### 错误5: 破产日期不一致

**症状**: 计算时使用了不同的停止计息日。

**原因**: 未从统一配置读取日期。

**防范**: 始终从`project_config.ini`或前轮配置读取破产日期和停止计息日。

---

## 示例场景

### 场景1: 利率约定变更（Incremental模式）

**变更字段**: `interest_rate_clause`

**受影响债权项**: 利息、复利

**执行步骤**:

1. 读取前轮报告和前轮确认值:
   ```
   本金确认: 100,000元
   利息确认: 7,200元（前轮）
   违约金确认: 12,000元
   ```

2. 识别受影响债权项: `["利息", "复利"]`

3. 继承未受影响债权项:
   ```markdown
   ### 2.1 本金确认
   【从Round 1完整复制】
   最终确认本金：**100,000元**。

   > 注：本债权项未受影响，结论继承Round 1。
   ```

4. 重新分析受影响债权项:
   ```markdown
   ### 2.2 利息确认

   根据补充提供的《补充协议》，利率约定调整为LPR 1年期 × 1.5...

   使用universal_debt_calculator_cli.py重新计算：

   ```bash
   python universal_debt_calculator_cli.py lpr \
       --principal 100000 \
       --start-date 2023-01-01 \
       --end-date 2024-12-30 \
       --multiplier 1.5 \
       --lpr-term 1y \
       --output round_2/计算文件/利息计算_round2.xlsx
   ```

   计算结果：8,500元

   最终确认利息：**8,500元**（调整后，原Round 1确认7,200元 ⬆）
   ```

5. 更新确认值汇总表:
   ```markdown
   | 债权项 | 确认金额（元） | 变更说明 |
   |--------|---------------|----------|
   | 本金 | 100,000 | 未变 |
   | 利息 | 8,500 | Round 2更新 ⬆ |
   | 违约金 | 12,000 | 未变 |
   | 合计 | 120,500 | Round 2调整 |
   ```

6. 管理计算文件:
   ```bash
   # 新生成的
   round_2/计算文件/利息计算_round2.xlsx

   # 从Round 1复制的
   round_2/计算文件/违约金计算.xlsx
   ```

**预期时间节省**: 65-70%（继承了本金和违约金分析，仅重新计算利息）

---

## 总结

债权分析增量处理的核心：
1. **债权项级别粒度**: 以债权项为单位进行增量处理
2. **依赖关系管理**: 准确识别债权项之间的依赖关系
3. **计算器强制使用**: 所有计算必须通过universal_debt_calculator_cli.py
4. **就低原则严守**: 每个债权项都应用就低原则
5. **计算文件管理**: 清晰管理新生成vs复制的计算文件

**关键成功因素**:
- ✅ 正确识别受影响债权项
- ✅ 理解债权项依赖关系
- ✅ 强制使用计算器工具
- ✅ 保持日期全局一致
- ✅ 完整的计算文件管理

**效率收益**:
- Incremental模式：60-75%时间节省
- Partial模式：85%+时间节省

---

**文档版本**: v3.0
**最后更新**: 2025-11-12
**相关文档**:
- `incremental_processing_guide.md` (fact-checking)
- `config/impact_mappings.py` - 影响范围映射表
- `universal_debt_calculator_cli.py` - 通用债权计算器
