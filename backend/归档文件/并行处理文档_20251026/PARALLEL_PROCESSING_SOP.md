# 并行处理标准操作流程 (SOP)
# Parallel Processing Standard Operating Procedure

**文档版本**: 1.0
**生效日期**: 2025-10-26
**适用范围**: 债权审查系统阶段内并行处理
**文档性质**: 强制执行标准

---

## SOP 概述

本标准操作流程(SOP)规定了债权审查系统中阶段内并行处理的**强制性操作规范**。所有并行处理必须严格遵守本SOP。

**核心原则**:
- ✅ 阶段内并行（同一阶段，多个债权人） → 允许
- ❌ 跨阶段并行（同一债权人，多个阶段） → 禁止

---

## SOP-001: 并行处理前置条件检查

### 执行时机
在启动任何并行处理之前

### 强制检查项

#### 1.1 批量规模验证
```
□ 债权人数量: 2-15个（推荐范围）
□ 如超过10个: 必须分批处理（每批5-8个）
□ 如只有1个: 不使用并行，直接串行处理
```

#### 1.2 环境初始化状态
```
□ 所有债权人已执行环境初始化
□ 所有 .processing_config.json 文件存在
□ 所有标准目录已创建（工作底稿、最终报告、计算文件、并行处理prompts）
```

**验证命令**:
```bash
# 检查配置文件数量
find 输出/第X批债权 -name ".processing_config.json" | wc -l
# 结果应等于债权人数量
```

#### 1.3 输入材料完整性
```
□ 所有债权人的输入材料文件存在
□ 文件可读且非空
```

**验证命令**:
```bash
# 检查输入材料
for file in 输入/第X批债权/*.md; do
  [ -f "$file" ] && [ -s "$file" ] && echo "✅ $file" || echo "❌ $file"
done
```

#### 1.4 项目配置确认
```
□ project_config.ini 中的破产日期正确
□ 所有债权人应使用相同的破产日期
```

### 不满足前置条件的处理
**立即停止并行处理，先解决前置条件问题**

---

## SOP-002: Prompt 准备标准流程

### 执行时机
每个阶段并行处理前

### 强制要求

#### 2.1 使用标准模板
```
阶段1: 使用 parallel_prompt_templates/stage1_fact_checking_parallel_template.md
阶段2: 使用 parallel_prompt_templates/stage2_debt_analysis_parallel_template.md
阶段3: 使用 parallel_prompt_templates/stage3_report_organization_parallel_template.md
```

#### 2.2 占位符替换检查清单
对每个债权人的prompt：
```
□ [批次号] → 实际批次（如 1）
□ [债权人编号] → 实际编号（如 115）
□ [债权人名称] → 完整名称（从输入文件名提取）
□ [处理日期] → 格式 YYYYMMDD
□ [破产受理日期] → 从 project_config.ini（格式 YYYY-MM-DD）
□ [停止计息日期] → 从 project_config.ini（格式 YYYY-MM-DD）
□ [债务人名称] → 从 project_config.ini
```

#### 2.3 路径验证
所有路径必须：
```
□ 使用绝对路径（以 /root/debt_review_skills 开头）
□ 包含正确的债权人标识（编号-名称）
□ 文件路径对应的文件存在（对于输入和前置报告）
```

#### 2.4 推荐工具使用（自动化）
```bash
# 使用 prompt generator 自动生成（推荐）
python parallel_prompt_generator.py --stage 1 --batch 1 --creditors 115,118,124,134,140

# 工具优势:
# - 自动读取配置文件和破产日期
# - 自动生成正确的绝对路径
# - Prompts 自动保存到各债权人的 并行处理prompts/ 子目录
# - 防止路径错误和格式不一致
```

**Prompts 存储位置**（默认）:
```
输出/第X批债权/[编号]-[债权人名称]/并行处理prompts/
└── stageX_creditor[编号]_[债权人名称]_prompt.txt
```

**重要**: Prompts 作为审计追踪的一部分保留在债权人文件夹中，文件清单中会自动列出。

### 质量门槛
**每个prompt必须完全自包含，可独立使用，不依赖外部上下文**

---

## SOP-003: 并行执行标准流程

### 执行时机
Prompt 准备完成后

### 阶段0: 批量初始化（串行，必须）

**操作**:
```bash
for creditor in [list]; do
  python 债权处理工作流控制器.py [batch] [number] [name]
done
```

**验证**: 所有配置文件和目录创建成功

### 阶段1-3: 并行执行（标准流程）

#### 3.1 Task 调用规范
在**一个消息**中发起所有并行Task：

```
[向Claude Code发送消息]

我要并行处理第[X]批债权的[N]个债权人的[阶段名称]。
请使用[N]个独立的 [agent-type] agent 实例。

[使用 Task 工具 N 次]

Task 1:
  subagent_type: [debt-fact-checker / debt-claim-analyzer / report-organizer]
  description: [简短描述，如 "Fact-check creditor 115"]
  prompt: [债权人1的完整自包含prompt]

Task 2:
  subagent_type: [...]
  description: [...]
  prompt: [债权人2的完整自包含prompt]

...

Task N:
  ...
```

#### 3.2 等待规则
```
□ 等待所有N个Task完成
□ 不允许部分完成就进入下一阶段
□ 监控失败的Task，记录错误信息
```

#### 3.3 结果收集
```
□ 系统返回所有N个agent的结果
□ 识别成功和失败的债权人
□ 记录每个债权人的处理状态
```

### 失败处理标准
```
- 1-2个失败 → 单独重新处理失败者
- 3+个失败 → 停止并行，检查系统性问题
- 全部失败 → 回退到串行模式
```

---

## SOP-004: 质量检查点执行标准

### 执行时机
每个阶段完成后，进入下一阶段前

### 检查清单来源
使用 `PARALLEL_QUALITY_CHECKLIST.md` 的对应检查点

### 强制检查项（三阶段通用）

#### 4.1 文件存在性（100%要求）
```
□ 所有债权人的输出文件已生成
□ 文件位于正确的目录
□ 文件命名符合标准
```

#### 4.2 债权人身份验证（零容忍错误）
```
□ 每个报告中的债权人名称、编号正确
□ 不同债权人的报告内容完全不同
□ 无交叉引用或混淆迹象
```

#### 4.3 日期一致性（零容忍错误）
```
□ 所有报告的破产受理日期一致
□ 所有报告的停止计息日期一致
□ 日期格式正确
```

#### 4.4 独立性验证（抽查）
```
□ 抽查2个债权人
□ 在债权人A的报告中搜索债权人B的特征信息
□ 应无结果（证明独立）
```

### 通过标准
**所有强制检查项必须100%通过**

### 不通过的处理
```
1. 记录所有失败项和失败的债权人
2. 分析失败原因
3. 修复问题
4. 仅重新处理失败的债权人
5. 重新执行质量检查
6. 直到全部通过
```

---

## SOP-005: 错误处理与恢复标准

### 5.1 单个债权人失败

**处理流程**:
```
1. 识别失败的债权人
2. 保留成功的债权人结果（不重新处理）
3. 分析失败原因：
   - 配置错误 → 修复配置，重新初始化
   - 路径错误 → 修正prompt，重新调用
   - 材料问题 → 补充材料，重新调用
   - 上下文污染 → 删除输出，重新初始化，串行处理
4. 单独重新处理失败者
5. 整合到成功批次
```

### 5.2 系统性失败（3+个债权人）

**处理流程**:
```
1. 立即停止并行处理
2. 分析根本原因：
   - Prompt模板问题 → 修正模板
   - 配置问题 → 修正project_config.ini
   - 系统问题 → 报告bug
3. 修复后决定：
   - 问题已解决 → 重新批量并行处理
   - 问题复杂 → 回退到串行模式
```

### 5.3 上下文污染（零容忍）

**识别**:
```bash
# 检测污染
grep "[其他债权人名称]" 输出/第X批债权/[编号]-[债权人名称]/**/*.md
```

**处理流程**（强制）:
```
1. 立即停止所有并行处理
2. 删除污染的债权人所有输出
3. 重新初始化该债权人环境
4. 使用串行模式单独重新处理
5. 深度验证独立性
6. 报告污染原因和预防措施
```

---

## SOP-006: 最终交付标准

### 执行时机
阶段3完成，所有质量检查通过后

### 交付物清单（每个债权人）

#### 6.1 必须文件
```
□ 工作底稿/[债权人名称]_事实核查报告.md
□ 工作底稿/[债权人名称]_债权分析报告.md
□ 最终报告/GY2025_[债权人名称]_债权审查报告_[日期].md
□ 计算文件/[债权人名称]_*.xlsx (或无计算项说明.txt)
□ 文件清单.md
```

#### 6.2 文件位置验证
```bash
# 验证脚本
for dir in 输出/第X批债权/*/; do
  creditor=$(basename "$dir")
  echo "验证 $creditor"

  # 检查五类文件
  ls "$dir/工作底稿/"*事实核查报告.md >/dev/null 2>&1 && echo "  ✅ 事实核查报告" || echo "  ❌ 缺失"
  ls "$dir/工作底稿/"*债权分析报告.md >/dev/null 2>&1 && echo "  ✅ 债权分析报告" || echo "  ❌ 缺失"
  ls "$dir/最终报告/GY2025"*.md >/dev/null 2>&1 && echo "  ✅ 审查意见表" || echo "  ❌ 缺失"
  ls "$dir/计算文件/"* >/dev/null 2>&1 && echo "  ✅ 计算文件" || echo "  ❌ 缺失"
  ls "$dir/文件清单.md" >/dev/null 2>&1 && echo "  ✅ 文件清单" || echo "  ❌ 缺失"
done
```

### 交付前最终检查
```
□ 所有债权人的文件完整
□ 独立性深度验证（抽查3个）通过
□ 日期全局一致性验证通过
□ 客户交付文件（最终报告）格式正确
□ 文件清单准确
```

---

## SOP-007: 记录与归档标准

### 7.1 处理记录（必须保存）

创建批次处理记录文件：
```markdown
# 第[X]批债权并行处理记录

**处理日期**: YYYY-MM-DD
**操作人**: [姓名]
**债权人数量**: [N]
**处理模式**: 阶段内并行

## 债权人清单
1. [编号]-[名称]
2. [编号]-[名称]
...

## 执行记录

### 阶段0: 环境初始化
- 开始时间: HH:MM
- 结束时间: HH:MM
- 状态: 成功/失败
- 问题: [如有]

### 阶段1: 事实核查（并行）
- 开始时间: HH:MM
- 结束时间: HH:MM
- 成功: [N1]个
- 失败: [N2]个
- 失败债权人: [列表]
- 问题与处理: [记录]

### 阶段2: 债权分析（并行）
...

### 阶段3: 报告整理（并行）
...

## 质量验收
- 检查点1: 通过/失败
- 检查点2: 通过/失败
- 检查点3: 通过/失败
- 最终验收: 通过/失败

## 性能数据
- 总耗时: [X]分钟
- 串行预估: [Y]分钟
- 效率提升: [Z]%

## 经验教训
- 成功经验: [总结]
- 遇到问题: [总结]
- 改进建议: [总结]
```

### 7.2 归档要求
```
□ 处理记录保存到项目文档目录
□ 生成的prompt已保存到各债权人的 并行处理prompts/ 子目录（用于审计）
□ 质量检查结果保存
□ 重大问题的分析报告保存
```

---

## SOP 合规检查

### 自我审计清单

使用本SOP处理批量债权人后，审计：

```
□ SOP-001: 前置条件检查 - 已执行
□ SOP-002: Prompt准备 - 使用标准模板
□ SOP-003: 并行执行 - 流程正确
□ SOP-004: 质量检查 - 全部检查点通过
□ SOP-005: 错误处理 - 按规范执行（如发生）
□ SOP-006: 最终交付 - 文件齐全
□ SOP-007: 记录归档 - 完整记录保存
```

### 不合规的后果
- 质量问题无法追溯
- 错误可能扩散
- 无法复现成功经验

---

## SOP 版本与修订

**当前版本**: 1.0
**生效日期**: 2025-10-26
**修订权限**: 需经系统架构师批准
**修订记录**:
- v1.0 (2025-10-26): 初始版本，定义并行处理标准流程

---

## 相关文档

- **技术协议**: `PARALLEL_PROCESSING_PROTOCOL.md`
- **质量检查**: `PARALLEL_QUALITY_CHECKLIST.md`
- **用户手册**: `PARALLEL_PROCESSING_USER_GUIDE.md`
- **快速参考**: `PARALLEL_QUICK_REFERENCE.md`

---

**本SOP为强制执行标准，所有并行处理必须遵守**
