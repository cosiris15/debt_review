#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
å€ºæƒå¤„ç†å·¥ä½œæµæ§åˆ¶å™¨ (Debt Processing Workflow Controller)

è¿™ä¸ªè„šæœ¬ç”¨äºç»Ÿä¸€ç®¡ç†å€ºæƒå®¡æŸ¥çš„å·¥ä½œæµç¨‹ï¼Œç¡®ä¿ï¼š
1. æ ‡å‡†åŒ–çš„ç›®å½•ç»“æ„åˆ›å»º
2. è§„èŒƒåŒ–çš„æ–‡ä»¶è¾“å‡ºè·¯å¾„ç®¡ç†
3. Agenté—´çš„åè°ƒæ‰§è¡Œ
4. è´¨é‡æ§åˆ¶å’ŒéªŒè¯
"""

import os
import sys
import json
import configparser
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional, Tuple

class DebtProcessingController:
    """å€ºæƒå¤„ç†å·¥ä½œæµæ§åˆ¶å™¨"""
    
    def __init__(self, project_root: str = "/root/debt_review_skills"):
        self.project_root = Path(project_root)
        self.output_root = self.project_root / "è¾“å‡º"
        self.config_file = self.project_root / "project_config.ini"
        
        # åŠ è½½é¡¹ç›®é…ç½®
        self.config = self._load_project_config()
        
    def _load_project_config(self) -> configparser.ConfigParser:
        """åŠ è½½é¡¹ç›®é…ç½®æ–‡ä»¶"""
        config = configparser.ConfigParser()
        if self.config_file.exists():
            config.read(self.config_file, encoding='utf-8')
        else:
            print(f"âš ï¸  è­¦å‘Šï¼šé¡¹ç›®é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ {self.config_file}")
        return config
    
    def create_creditor_directory(self, batch_number: str, creditor_number: str, 
                                creditor_name: str) -> Path:
        """åˆ›å»ºå€ºæƒäººæ ‡å‡†ç›®å½•ç»“æ„
        
        Args:
            batch_number: æ‰¹æ¬¡å·ï¼ˆå¦‚ï¼š1ï¼‰
            creditor_number: å€ºæƒäººç¼–å·ï¼ˆå¦‚ï¼š115ï¼‰
            creditor_name: å€ºæƒäººåç§°ï¼ˆå¦‚ï¼šæ…ˆæºªå¸‚ä¸œèˆªå»ºç­‘èµ·é‡æœºæ¢°å®‰è£…é˜Ÿï¼‰
            
        Returns:
            Path: å€ºæƒäººåŸºç¡€ç›®å½•è·¯å¾„
        """
        # æ„å»ºç›®å½•è·¯å¾„
        base_dir = self.output_root / f"ç¬¬{batch_number}æ‰¹å€ºæƒ" / f"{creditor_number}-{creditor_name}"
        
        # åˆ›å»ºæ ‡å‡†å­ç›®å½•
        subdirs = ["å·¥ä½œåº•ç¨¿", "æœ€ç»ˆæŠ¥å‘Š", "è®¡ç®—æ–‡ä»¶", "å¹¶è¡Œå¤„ç†prompts"]
        
        for subdir in subdirs:
            subdir_path = base_dir / subdir
            subdir_path.mkdir(parents=True, exist_ok=True)
            print(f"âœ“ åˆ›å»ºç›®å½•: {subdir_path}")
        
        return base_dir
    
    def generate_processing_config(self, batch_number: str, creditor_number: str,
                                 creditor_name: str) -> Dict:
        """ä¸ºç‰¹å®šå€ºæƒäººç”Ÿæˆå¤„ç†é…ç½®
        
        Args:
            batch_number: æ‰¹æ¬¡å·
            creditor_number: å€ºæƒäººç¼–å·
            creditor_name: å€ºæƒäººåç§°
            
        Returns:
            Dict: å¤„ç†é…ç½®ä¿¡æ¯
        """
        base_path = self.output_root / f"ç¬¬{batch_number}æ‰¹å€ºæƒ" / f"{creditor_number}-{creditor_name}"
        current_date = datetime.now().strftime("%Y%m%d")
        
        config = {
            "creditor_info": {
                "batch_number": batch_number,
                "creditor_number": creditor_number,
                "creditor_name": creditor_name,
                "processing_date": current_date
            },
            "paths": {
                "base_directory": str(base_path),
                "work_papers": str(base_path / "å·¥ä½œåº•ç¨¿"),
                "final_reports": str(base_path / "æœ€ç»ˆæŠ¥å‘Š"),
                "calculation_files": str(base_path / "è®¡ç®—æ–‡ä»¶"),
                "parallel_prompts": str(base_path / "å¹¶è¡Œå¤„ç†prompts")
            },
            "file_templates": {
                "fact_check_report": f"{creditor_name}_äº‹å®æ ¸æŸ¥æŠ¥å‘Š.md",
                "analysis_report": f"{creditor_name}_å€ºæƒåˆ†ææŠ¥å‘Š.md",
                "final_review": f"GY2025_{creditor_name}_å€ºæƒå®¡æŸ¥æŠ¥å‘Š_{current_date}.md",
                "file_inventory": "æ–‡ä»¶æ¸…å•.md"
            },
            "project_config": {
                "bankruptcy_date": self.config.get("å…³é”®æ—¥æœŸ", "ç ´äº§å—ç†æ—¥æœŸ", fallback=""),
                "interest_stop_date": self.config.get("å…³é”®æ—¥æœŸ", "åœæ­¢è®¡æ¯æ—¥æœŸ", fallback=""),
                "debtor_name": self.config.get("é¡¹ç›®åŸºæœ¬ä¿¡æ¯", "å€ºåŠ¡äººåç§°", fallback="")
            }
        }
        
        return config
    
    def save_processing_config(self, config: Dict) -> Path:
        """ä¿å­˜å¤„ç†é…ç½®åˆ°æ–‡ä»¶
        
        Args:
            config: å¤„ç†é…ç½®å­—å…¸
            
        Returns:
            Path: é…ç½®æ–‡ä»¶è·¯å¾„
        """
        base_path = Path(config["paths"]["base_directory"])
        config_file = base_path / ".processing_config.json"
        
        with open(config_file, 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
        
        print(f"âœ“ ä¿å­˜å¤„ç†é…ç½®: {config_file}")
        return config_file
    
    def validate_directory_structure(self, base_path: Path) -> bool:
        """éªŒè¯ç›®å½•ç»“æ„å®Œæ•´æ€§
        
        Args:
            base_path: å€ºæƒäººåŸºç¡€ç›®å½•è·¯å¾„
            
        Returns:
            bool: éªŒè¯ç»“æœ
        """
        required_dirs = ["å·¥ä½œåº•ç¨¿", "æœ€ç»ˆæŠ¥å‘Š", "è®¡ç®—æ–‡ä»¶", "å¹¶è¡Œå¤„ç†prompts"]
        
        for dir_name in required_dirs:
            dir_path = base_path / dir_name
            if not dir_path.exists():
                print(f"âŒ ç¼ºå°‘ç›®å½•: {dir_path}")
                return False
            elif not dir_path.is_dir():
                print(f"âŒ è·¯å¾„ä¸æ˜¯ç›®å½•: {dir_path}")
                return False
        
        print(f"âœ“ ç›®å½•ç»“æ„éªŒè¯é€šè¿‡: {base_path}")
        return True
    
    def check_file_placement(self, config: Dict) -> Dict:
        """æ£€æŸ¥æ–‡ä»¶æ”¾ç½®æƒ…å†µ
        
        Args:
            config: å¤„ç†é…ç½®
            
        Returns:
            Dict: æ£€æŸ¥ç»“æœ
        """
        base_path = Path(config["paths"]["base_directory"])
        creditor_name = config["creditor_info"]["creditor_name"]
        
        check_results = {
            "fact_check_report": False,
            "analysis_report": False,
            "calculation_files": [],
            "final_report": False,
            "file_inventory": False
        }
        
        # æ£€æŸ¥äº‹å®æ ¸æŸ¥æŠ¥å‘Š
        fact_check_path = base_path / "å·¥ä½œåº•ç¨¿" / f"{creditor_name}_äº‹å®æ ¸æŸ¥æŠ¥å‘Š.md"
        check_results["fact_check_report"] = fact_check_path.exists()
        
        # æ£€æŸ¥å€ºæƒåˆ†ææŠ¥å‘Š
        analysis_path = base_path / "å·¥ä½œåº•ç¨¿" / f"{creditor_name}_å€ºæƒåˆ†ææŠ¥å‘Š.md"
        check_results["analysis_report"] = analysis_path.exists()
        
        # æ£€æŸ¥è®¡ç®—æ–‡ä»¶
        calc_dir = base_path / "è®¡ç®—æ–‡ä»¶"
        if calc_dir.exists():
            calc_files = [f for f in calc_dir.iterdir() if f.is_file()]
            check_results["calculation_files"] = [str(f) for f in calc_files]
        
        # æ£€æŸ¥æœ€ç»ˆæŠ¥å‘Š
        current_date = datetime.now().strftime("%Y%m%d")
        final_report_path = base_path / "æœ€ç»ˆæŠ¥å‘Š" / f"GY2025_{creditor_name}_å€ºæƒå®¡æŸ¥æŠ¥å‘Š_{current_date}.md"
        check_results["final_report"] = final_report_path.exists()
        
        # æ£€æŸ¥æ–‡ä»¶æ¸…å•
        inventory_path = base_path / "æ–‡ä»¶æ¸…å•.md"
        check_results["file_inventory"] = inventory_path.exists()
        
        return check_results
    
    def initialize_creditor_processing(self, batch_number: str, creditor_number: str,
                                     creditor_name: str) -> Tuple[Path, Dict]:
        """åˆå§‹åŒ–å€ºæƒäººå¤„ç†ç¯å¢ƒ
        
        Args:
            batch_number: æ‰¹æ¬¡å·
            creditor_number: å€ºæƒäººç¼–å·
            creditor_name: å€ºæƒäººåç§°
            
        Returns:
            Tuple[Path, Dict]: åŸºç¡€ç›®å½•è·¯å¾„å’Œé…ç½®ä¿¡æ¯
        """
        print(f"\nğŸš€ åˆå§‹åŒ–å€ºæƒäººå¤„ç†ç¯å¢ƒ")
        print(f"   æ‰¹æ¬¡: ç¬¬{batch_number}æ‰¹")
        print(f"   ç¼–å·: {creditor_number}")
        print(f"   åç§°: {creditor_name}")
        
        # åˆ›å»ºç›®å½•ç»“æ„
        base_path = self.create_creditor_directory(batch_number, creditor_number, creditor_name)
        
        # ç”Ÿæˆå¤„ç†é…ç½®
        config = self.generate_processing_config(batch_number, creditor_number, creditor_name)
        
        # ä¿å­˜é…ç½®æ–‡ä»¶
        self.save_processing_config(config)
        
        # éªŒè¯ç›®å½•ç»“æ„
        if self.validate_directory_structure(base_path):
            print(f"âœ… å€ºæƒäººå¤„ç†ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ")
        else:
            print(f"âŒ å€ºæƒäººå¤„ç†ç¯å¢ƒåˆå§‹åŒ–å¤±è´¥")
            return None, None
        
        return base_path, config
    
    def print_workflow_summary(self, config: Dict):
        """æ‰“å°å·¥ä½œæµç¨‹æ‘˜è¦
        
        Args:
            config: å¤„ç†é…ç½®
        """
        print(f"\nğŸ“‹ å·¥ä½œæµç¨‹æ‘˜è¦")
        print(f"   åŸºç¡€ç›®å½•: {config['paths']['base_directory']}")
        print(f"   å·¥ä½œåº•ç¨¿: {config['paths']['work_papers']}")
        print(f"   è®¡ç®—æ–‡ä»¶: {config['paths']['calculation_files']}")
        print(f"   æœ€ç»ˆæŠ¥å‘Š: {config['paths']['final_reports']}")
        print(f"\nğŸ“ é¢„æœŸæ–‡ä»¶:")
        print(f"   äº‹å®æ ¸æŸ¥: {config['file_templates']['fact_check_report']}")
        print(f"   å€ºæƒåˆ†æ: {config['file_templates']['analysis_report']}")
        print(f"   å®¡æŸ¥æ„è§: {config['file_templates']['final_review']}")
        print(f"   æ–‡ä»¶æ¸…å•: {config['file_templates']['file_inventory']}")

def main():
    """ä¸»å‡½æ•° - å‘½ä»¤è¡Œæ¥å£"""
    if len(sys.argv) != 4:
        print("ç”¨æ³•: python å€ºæƒå¤„ç†å·¥ä½œæµæ§åˆ¶å™¨.py <æ‰¹æ¬¡å·> <å€ºæƒäººç¼–å·> <å€ºæƒäººåç§°>")
        print("ç¤ºä¾‹: python å€ºæƒå¤„ç†å·¥ä½œæµæ§åˆ¶å™¨.py 1 115 æ…ˆæºªå¸‚ä¸œèˆªå»ºç­‘èµ·é‡æœºæ¢°å®‰è£…é˜Ÿ")
        sys.exit(1)
    
    batch_number = sys.argv[1]
    creditor_number = sys.argv[2]
    creditor_name = sys.argv[3]
    
    controller = DebtProcessingController()
    
    # åˆå§‹åŒ–å¤„ç†ç¯å¢ƒ
    base_path, config = controller.initialize_creditor_processing(
        batch_number, creditor_number, creditor_name
    )
    
    if base_path and config:
        controller.print_workflow_summary(config)
        print(f"\nâœ… ç¯å¢ƒå‡†å¤‡å®Œæˆï¼Œå¯ä»¥å¼€å§‹å€ºæƒå®¡æŸ¥æµç¨‹")
        print(f"   è¯·æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡ŒAgent:")
        print(f"   1. debt-fact-checker (äº‹å®æ ¸æŸ¥å‘˜)")
        print(f"   2. debt-claim-analyzer (å€ºæƒåˆ†æå‘˜)")
        print(f"   3. report-organizer (æŠ¥å‘Šæ•´ç†å‘˜)")
    else:
        print(f"âŒ ç¯å¢ƒåˆå§‹åŒ–å¤±è´¥")
        sys.exit(1)

if __name__ == "__main__":
    main()