# 智能体债权审查协作系统SOP

## 🎯 系统目标
建立专业化、标准化的债权审查协作机制，通过三个专业子智能体（debt-fact-checker、debt-claim-analyzer 和 report-organizer）的分工协作，提高债权审查的准确性、效率和质量，确保交付报告的专业性和一致性。

## 🔄 总体工作流程

### 单笔债权处理流程
```
原始材料 → 事实核查员 → 债权分析员 → 报告整理员 → 审查意见表
    ↓           ↓           ↓           ↓
申报梳理     事实查明     金额分析     内容整合
基础分类     证据梳理     利息计算     模板应用
                        时效判断     文件规范
                        结果输出     最终报告
```

### 批量债权处理流程
**⚠️ 重要：批量处理采用逐笔串行方式，每笔债权独立输出报告**
```
债权1材料 → 事实核查员 → 债权分析员 → 报告整理员 → 债权1审查意见表 ✓
    ↓
债权2材料 → 事实核查员 → 债权分析员 → 报告整理员 → 债权2审查意见表 ✓
    ↓
债权3材料 → 事实核查员 → 债权分析员 → 报告整理员 → 债权3审查意见表 ✓
    ↓
   ...
```

**禁止以下分阶段批量处理方式：**
```
❌ 错误方式：
债权1,2,3...材料 → 事实核查员(批量处理) → 债权分析员(批量处理)
```

### 超长材料处理流程
**⚠️ 重要：当单笔债权证据材料超过系统处理能力时，采用分批处理机制**
```
材料评估 → 分批方案 → 分批处理 → 结果汇总
    ↓          ↓          ↓          ↓
判断数量    按类分组    独立处理    整合输出
确定需求    时间排序    保留关联    完整报告

触发条件：
- 材料总页数超过100页
- 独立证据项超过50个
- 系统提示材料超出处理窗口

具体流程：
1. 评估阶段
   - 统计证据总量（合同X份、发票Y份、银行凭证Z份）
   - 判断是否超过处理能力（>100页或>50个独立证据）
   - 决定处理方式（常规/分批）

2. 分批阶段
   - 按证据类型和关联性分组
   - 每批控制在30-50个证据项
   - 确保关联证据同批处理

3. 处理阶段
   - 批次1：核心合同及直接履约证据
   - 批次2：大量履约凭证（发票、银行记录等）
   - 批次3：法律文书和总结性文件
   - 各批独立处理，生成中间结果

4. 汇总阶段
   - 整合各批次时间轴
   - 统一证据关系分析
   - 生成完整统一的报告（不显示分批痕迹）
```

## 👥 子智能体分工

### 子智能体一：事实核查员（debt-fact-checker）
**核心职责：**
1. **申报信息组织** - 从申报材料中结构化提取核心信息
2. **基础事实关系建立** - 基于证据材料确定基础债权关系类型
3. **生成独立的事实核查报告** - 输出完整的《事实核查报告》，包含所有事实查明内容
4. **超长材料分批处理** - 当证据材料超过处理能力时，系统化分批处理并汇总

**⚠️ 特别强调：债权发生情况必须详细记录**
在填写"债权发生情况"时，必须严格按照《事实核查员工作标准》中"分类查明标准"的格式要求，详细记录合同的所有核心条款（包括但不限于标的物、合同价款、履行期限、交付验收、付款方式、违约责任、发票要求、争议解决等9项内容），并标注对应的合同条款位置。严禁简单概括或省略关键信息。

**详细工作流程：**
1. **材料接收和初审** - 确认债权申报MD文件完整性和基本债权性质
2. **材料量评估** - 判断是否需要分批处理（>100页或>50个独立证据）
3. **申报信息组织** - 提取债权人信息、申报债权信息、申报理由和事实
4. **基础事实建立** - 严格区分证据材料和申报材料，按法律关系性质分类，创建时间线
   - 常规处理：直接处理所有材料
   - 分批处理：按证据类型分批，保持关联性，最后汇总
5. **错误防范复查** - 对照常见错误防范标准进行系统性复查
6. **生成事实核查报告** - 输出独立完整的《事实核查报告》

**输出要求（独立报告）：**
《事实核查报告》必须包含：
- 申报情况表（包含申报金额明细）
- 形式性文件核查情况
- **债权发生情况查明表（时间轴表格，核心内容）**
- 法律关系地位识别
- 基础债权关系类型判断
- 证据关系综合分析
- 向债权分析员的移交说明

### 子智能体二：债权分析员（debt-claim-analyzer）
**核心职责：**
1. **专业金额分析** - 系统拆解和分析各项金额成分
2. **精确利息计算** - 强制使用`universal_debt_calculator_cli.py`工具进行所有计算
3. **专业诉讼时效评估** - 分析每个基础债权关系的时效状况
4. **执行时效分析** - 对基于生效法律文书的债权判断执行时效
5. **错误防范复查** - 对照常见错误防范标准进行系统性复查
6. **生成独立的债权分析报告** - 输出完整的《债权分析报告》，包含所有分析计算内容
7. **质量控制** - 审查事实核查员工作并全面验证自身分析结果

**详细工作流程：**
1. 接收事实核查报告 - 确认事实核查报告完整性
2. 系统金额分析 - 按"逐项拆解"和"实质重于形式"原则分解申报金额
3. 计算参数确定和利息计算 - 检查履行期限（详见project_config.ini配置），确定计算参数，执行精确计算
4. 专业诉讼时效评估 - 确定起算点、中断中止事件、到期日期
5. 执行时效分析 - 对基于生效法律文书的债权分析执行时效
6. 错误防范复查 - 对照「常见错误防范标准」系统检查所有常见错误
7. 生成债权分析报告 - 输出独立完整的《债权分析报告》

**输出要求：**

**A. 《债权分析报告》（Markdown格式）：**
- 债权基础法律关系分析
- 金额项目拆解清单
- 履行期限判断表
- 利息计算过程（含完整命令记录）
- 诉讼时效分析
- 执行时效分析（如适用）
- 审查确认情况（确认金额明细）
- 审查结论

**B. 计算过程文件（独立文件）：**
- **计算过程表格文件**（Excel/CSV格式，包含详细计算步骤，强制要求）
- **无计算项说明文件**（TXT格式，当债权不涉及计算时生成）

### 子智能体三：报告整理员（report-organizer）
**核心职责：**
1. **报告整合** - 将两份独立技术报告整合为统一审查意见表
2. **模板应用** - 应用客户特定报告模板确保符合交付要求
3. **文件组织** - 实施标准化文件命名和目录组织

**详细工作流程：**
1. **报告接收** - 确认收到完整的《事实核查报告》和《债权分析报告》
2. **模板加载** - 读取客户报告模板，理解结构要求
3. **内容重组** - 从两份报告中提取内容，按模板重新组织
4. **报告生成** - 生成最终审查意见表，保持专业格式
5. **文件整理** - 应用标准命名规则，组织文件目录

**输出要求：**
- 审查意见表（按模板格式）
- 标准化文件命名和目录结构
- 完整附件清单

## 📋 协作标准

### 信息传递标准
每个子智能体完成工作后，应针对**每笔债权**输出独立的报告。三份报告共同构成完整的债权审查和交付文档。具体输出要求详见各子智能体的工作职责部分。

**⚠️ 重要提醒：**
- 前两个Agent各自输出独立技术报告，不需要相互整合
- 第三个Agent（报告整理员）负责将两份技术报告整合为审查意见表
- 批量处理时，每笔债权都必须生成三份独立报告
- 禁止汇总多笔债权的处理结果
- 每份报告都应完整、独立、可单独使用

### 质量控制检查点

#### 检查点1：债权事实核查员（debt-fact-checker）完成后

**⚠️ 强制性日期验证检查：**
- [ ] **破产受理日期核对完成**：已从`.processing_config.json`正确读取并记录破产受理日期
- [ ] **停止计息日期确认**：已正确记录停止计息日期（破产受理日前一日）
- [ ] **配置状态正常**：配置文件存在且格式正确
- [ ] **日期记录规范**：报告中明确记录了使用的关键日期

**报告内容质量检查：**
- [ ] 申报情况信息完整准确
- [ ] 基础债权关系清晰识别
- [ ] 债权发生情况按时间顺序完整记录
- [ ] 证据材料与申报材料严格区分
- [ ] 查明情况详细完整没有简化
- [ ] 所有发现均有证据材料支撑
- [ ] 日期、金额、实体名称准确无误

#### 检查点2：债权分析员（debt-claim-analyzer）完成后

**⚠️ 强制性日期验证检查：**
- [ ] **破产受理日期核对完成**：已从`.processing_config.json`正确读取并记录破产受理日期
- [ ] **与前序报告交叉验证**：已与事实核查报告中的日期对比，确认一致性
- [ ] **计算截止日正确应用**：所有利息计算均使用正确的停止计息日期
- [ ] **时效判断日期准确**：诉讼时效和执行时效分析中使用的关键日期正确

**报告质量检查：**
- [ ] 金额项目按"逐项拆解"原则完全分解
- [ ] 履行期限检查准确（特别注意破产受理前一日，详见project_config.ini配置）
- [ ] 计算参数确定完整准确
- [ ] universal_debt_calculator_cli.py工具正确调用并记录命令
- [ ] 诉讼时效分析逻辑清晰，推理详细
- [ ] 执行时效分析完整准确（如适用）
- [ ] 错误防范复查完成
- [ ] 审查意见表格式规范完整
- [ ] 所有数据计算准确无误

**文件完整性检查：**
- [ ] 《债权分析报告》已生成并保存在 `报告/` 目录
- [ ] 计算过程表格文件（Excel/CSV）已生成并保存在 `计算文件/` 目录
- [ ] 计算命令记录文件已生成（包含完整的universal_debt_calculator_cli.py调用记录）
- [ ] 如无计算项，已生成说明文件（TXT格式）并保存在 `计算文件/` 目录
- [ ] 所有文件命名规范且可追溯（包含债权人信息和日期）
- [ ] 目录结构符合标准化要求
- [ ] 质量控制自检清单全部确认

#### 检查点3：报告整理员（report-organizer）完成后

**⚠️ 强制性日期验证检查：**
- [ ] **破产受理日期三重核对完成**：配置文件、事实核查报告、债权分析报告中的日期完全一致
- [ ] **最终报告日期正确**：最终交付报告中的破产受理日期准确无误
- [ ] **计算结果日期一致性验证**：所有利息计算截止日期均为破产受理日前一日
- [ ] **客户交付质量保证**：确保交付给客户的文档不含任何日期错误

**报告整合检查：**
- [ ] 已接收完整的《事实核查报告》和《债权分析报告》
- [ ] 审查意见表模板正确加载和应用
- [ ] 内容提取准确，无遗漏关键信息
- [ ] 格式符合客户要求
- [ ] 专业术语处理得当

**文件规范检查：**
- [ ] 文件命名符合标准化规范
- [ ] 目录结构组织正确
- [ ] 附件清单完整准确
- [ ] 所有引用文件存在且可访问

## ⚠️ 协作要求

### 1. 严格按序执行
- 必须按照 debt-fact-checker → debt-claim-analyzer → report-organizer 的顺序执行
- 前一环节未完成，后续环节不得开始
- 发现前环节问题，立即反馈要求重新处理

### 2. 批量处理规范
- **逐笔串行处理**：批量债权必须逐笔完成完整流程，禁止分阶段批量处理
- **完整性原则**：每笔债权必须完成三个智能体的完整处理流程后，才能开始下一笔债权
- **独立性原则**：每笔债权的处理过程相互独立，避免交叉影响
- **独立输出原则**：每笔债权必须生成独立的技术报告和审查意见表，禁止汇总输出
- **质量优先**：宁可降低处理速度，也要确保每笔债权的处理质量

### 3. Agent工作标准遵循
- debt-fact-checker 必须严格按照其agent定义的工作流程和输出标准执行
- debt-claim-analyzer 必须严格按照其agent定义的工作流程和输出标准执行，特别是错误防范复查环节
- report-organizer 必须严格按照其agent定义的内容重组和文件规范标准执行
- 遇到agent定义未涵盖情况，及时标记并按保守原则处理
- 禁止偏离agent工作标准要求的主观判断

### 4. 工具使用规范
- 所有计算必须使用`universal_debt_calculator_cli.py`工具
- 禁止手工计算或估算
- 计算命令和结果必须完整记录

### 5. 错误防范机制
- **强制复查**：债权分析员必须对照「常见错误防范标准」进行系统复查
- **重点关注**：劣后债权识别、违约金4倍LPR上限、时效中断事由、未决案件费用
- 发现错误立即停止并报告
- 重大分歧提交人工审核
- 建立错误案例库，持续改进标准

## 📁 文件结构

### 核心文件
- **project_config.ini**: 项目配置（破产日期等）
- **智能体债权审查SOP.md**: 总体协作标准
- **.claude/agents/**: Agent定义文件（含三个智能体）
- **工作标准文件**: 事实核查员/债权分析员/报告整理员工作标准
- **审查意见表模板.md**: 审查意见表模板
- **universal_debt_calculator_cli.py**: 利息计算工具

### 标准输出目录
```
输出/第X批债权/债权人N-公司名称/
├── 最终报告/          # 审查意见表和附件
├── 工作底稿/          # 两份技术报告
├── 计算文件/          # Excel/CSV计算表
└── 审查意见表.md      # 最终意见
```

## 🎯 使用指南

### 👤 主控制者职责分工

**⚠️ 明确责任：主控制者（Claude）负责整体流程协调，Agent负责专业技术工作**

#### 主控制者必须执行：
1. **环境准备**：确认agent文件、参考标准文件和工具文件就绪
2. **⚠️ MANDATORY 环境初始化**：为每个债权人运行工作流控制器
3. **Agent协调调用**：按序调用三个专业Agent
4. **质量监控**：验证每个Agent的输出符合规范
5. **流程控制**：确保严格串行处理，禁止并行

#### Agent负责执行：
- **debt-fact-checker**：事实核查和报告生成
- **debt-claim-analyzer**：债权分析和计算
- **report-organizer**：报告整合和文件组织

### 债权处理流程

#### 🚀 第一步：主控制者环境初始化 (MANDATORY)
**主控制者必须为每个债权人执行：**
```bash
python 债权处理工作流控制器.py <批次号> <债权人编号> <债权人名称>
# 示例: python 债权处理工作流控制器.py 1 115 慈溪市东航建筑起重机械安装队
```

**验证初始化完成：**
- ✅ 标准目录结构已创建
- ✅ 配置文件 `.processing_config.json` 存在
- ❌ 如果环境未初始化，禁止调用任何Agent

#### 📋 第二步：逐笔处理 (Agent执行)
**主控制者按序调用：**
1. **@debt-fact-checker** → 生成事实核查报告到 `工作底稿/`
2. **@debt-claim-analyzer** → 生成分析报告到 `工作底稿/`，计算文件到 `计算文件/`
3. **@report-organizer** → 生成审查意见表到 `最终报告/`，创建 `文件清单.md`

#### ✅ 第三步：质量验证 (主控制者执行)
**每个Agent完成后，主控制者验证：**
- 文件存在于正确位置
- 文件命名符合规范  
- 没有文件散落在错误位置

#### 关键参考信息
- **项目配置文件**: `project_config.ini`（包含破产受理日期、停止计息日期等项目特定信息）
- **Agent文件位置**: `.claude/agents/debt-fact-checker.md`、`.claude/agents/debt-claim-analyzer.md` 和 `.claude/agents/report-organizer.md`
- **必需工具**: `universal_debt_calculator_cli.py`
- **工作流控制器**: `债权处理工作流控制器.py`（用于标准化目录管理）
- **注意**: 开始新项目前，请先更新 `project_config.ini` 中的项目特定信息

## ⚠️ 强制性路径管理要求

### 1. 处理前准备
**MANDATORY: 处理每个债权人前必须执行:**
```bash
python 债权处理工作流控制器.py <批次号> <债权人编号> <债权人名称>
# 示例: python 债权处理工作流控制器.py 1 115 慈溪市东航建筑起重机械安装队
```

### 2. 标准目录结构
**MANDATORY: 所有文件必须严格按此结构存放:**
```
输出/第X批债权/[编号]-[债权人名称]/
├── 工作底稿/                # 技术报告
│   ├── {债权人名称}_事实核查报告.md
│   └── {债权人名称}_债权分析报告.md
├── 最终报告/                # 客户交付
│   └── GY2025_{债权人名称}_债权审查报告_{YYYYMMDD}.md
├── 计算文件/                # 计算过程
│   ├── {债权人名称}_{类型}.xlsx
│   └── {债权人名称}_无计算项说明.txt (如适用)
└── 文件清单.md              # 完整清单
```

### 3. Agent执行顺序验证
**MANDATORY: 严格按此顺序执行，每步都需验证:**
1. **debt-fact-checker**: 创建事实核查报告到 `工作底稿/`
2. **debt-claim-analyzer**: 验证事实报告存在，创建分析报告到 `工作底稿/`，计算文件到 `计算文件/`
3. **report-organizer**: 验证前两个报告存在，创建最终报告到 `最终报告/`，生成 `文件清单.md`

### 4. 文件命名强制验证
**MANDATORY: 所有Agent必须验证文件命名:**
- 事实核查报告: `{债权人名称}_事实核查报告.md`
- 债权分析报告: `{债权人名称}_债权分析报告.md`
- 最终审查报告: `GY2025_{债权人名称}_债权审查报告_{YYYYMMDD}.md`
- 计算文件: `{债权人名称}_{计算类型}.xlsx` 或 `{债权人名称}_无计算项说明.txt`

### 异常处理
- **材料缺失**：debt-fact-checker 按照异常处理准则记录缺失项，继续处理可用材料
- **材料超长**：debt-fact-checker 启动分批处理机制，按证据类型和关联性分组处理
- **计算错误**：debt-claim-analyzer 重新确认参数，重新使用 universal_debt_calculator_cli.py 计算
- **Agent工作标准冲突**：标记问题，提交人工审核
- **工具故障**：记录 universal_debt_calculator_cli.py 错误信息，使用备用计算方法
- **目录创建失败**：检查输出路径权限，创建备用目录结构
- **文件保存失败**：检查磁盘空间和文件权限，使用临时目录保存
- **文件完整性问题**：重新生成缺失或损坏的文件，确保输出完整性

### 质量保证
- 每个agent工作完成后进行自检（按各自定义的检查清单）
- debt-claim-analyzer 对技术分析进行质量控制
- report-organizer 对最终审查意见表进行格式和完整性控制
- 建立工作日志，记录关键决策依据和技术挑战
- 文件完整性验证：确保每笔债权的技术报告、审查意见表、计算文件都已正确生成和保存
- 目录结构检查：验证输出目录结构符合标准化要求
- 定期总结经验，优化agent工作标准和协作流程

---

**版本信息：**
- 版本：v3.0
- 更新日期：2025-09-05
- 更新内容：
  - 升级为三智能体系统，新增报告整理员（report-organizer）
  - 分离技术报告与审查意见表的生成流程
  - 更新工作流程和协作标准以支持三智能体协作
  - 调整输出目录结构以区分工作底稿和最终报告
- 基于：双智能体系统基础上扩展，增强报告标准化和客户交付能力
- 适用范围：破产债权审查全流程（三智能体模式）