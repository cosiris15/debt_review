# 并行处理协议 (Parallel Processing Protocol)

**版本**: 1.0
**创建日期**: 2025-10-26
**适用系统**: 债权审查三代理协作系统

---

## 📋 协议概述

本协议定义了债权审查系统中**阶段内并行处理**的标准规范，确保在并行处理多个债权人时：
1. **零上下文污染** - 不同债权人的处理完全隔离
2. **质量一致性** - 与串行处理保持相同质量标准
3. **完整可追溯** - 每个债权人的审计追踪独立完整

---

## 🎯 适用场景

### ✅ 允许并行的场景

**阶段内并行**（Stage-Level Parallelism）：
```
✅ 同一阶段处理多个不同债权人
✅ Example: 5个债权人同时进行事实核查
✅ Example: 3个债权人同时进行债权分析
✅ Example: 8个债权人同时进行报告整理
```

**批量大小建议**：
- **最佳**: 2-5个债权人（单次并行）
- **可接受**: 6-15个债权人（分2-3批，每批5个）
- **需谨慎**: 15+个债权人（分多批，监控资源）

### ❌ 禁止并行的场景

**跨阶段并行**（Cross-Stage Parallelism）：
```
❌ 同一债权人的三阶段同时执行
❌ Example: 债权人A的事实核查、债权分析、报告整理同时进行
❌ 理由: 阶段之间有数据依赖关系，必须顺序执行
```

---

## 🔐 上下文隔离核心原则

### 原则 1: 完全自包含的 Prompt (Self-Contained Prompt)

**定义**: 每个并行 Task 的 prompt 必须包含该债权人的**所有必要信息**，不依赖任何全局状态或隐式上下文。

**必须包含的元素**：

#### 1.1 债权人身份标识（三重标识）
```markdown
## 债权人身份
- 批次号: 1
- 债权人编号: 115
- 债权人名称: 慈溪市东航建筑起重机械安装队
- 处理日期: 20250906
```

**作用**: 明确告知 Agent 正在处理哪个债权人，用于后续验证。

#### 1.2 配置文件路径（绝对路径）
```markdown
## 配置文件
配置文件路径（必须使用此文件，不得猜测或假设）:
/root/debt_review_skills/输出/第1批债权/115-慈溪市东航建筑起重机械安装队/.processing_config.json

要求:
- 必须读取此配置文件获取路径和模板
- 读取后验证债权人身份与上述标识一致
- 如不一致，立即停止并报错
```

**作用**: 强制 Agent 使用正确的配置，避免混淆。

#### 1.3 输入材料路径（绝对路径）
```markdown
## 输入材料
材料文件路径:
/root/debt_review_skills/输入/第1批债权/115.慈溪市东航建筑起重机械安装队.md

要求:
- 必须读取此路径的材料文件
- 不得读取其他债权人的材料
- 读取后验证文件内容对应正确的债权人
```

**作用**: 防止读取错误债权人的材料。

#### 1.4 输出目录路径（绝对路径）
```markdown
## 输出目录
工作底稿目录:
/root/debt_review_skills/输出/第1批债权/115-慈溪市东航建筑起重机械安装队/工作底稿

最终报告目录:
/root/debt_review_skills/输出/第1批债权/115-慈溪市东航建筑起重机械安装队/最终报告

计算文件目录:
/root/debt_review_skills/输出/第1批债权/115-慈溪市东航建筑起重机械安装队/计算文件

要求:
- 所有输出文件必须写入上述对应目录
- 不得写入其他债权人的目录
- 写入前验证目录路径包含正确的债权人标识
```

**作用**: 确保输出文件不会写错位置。

#### 1.5 前置报告路径（阶段2和3需要）
```markdown
## 前置报告（阶段2: 债权分析）
事实核查报告路径:
/root/debt_review_skills/输出/第1批债权/115-慈溪市东航建筑起重机械安装队/工作底稿/慈溪市东航建筑起重机械安装队_事实核查报告.md

要求:
- 必须读取此报告作为分析依据
- 读取后验证报告中的债权人身份
- 如债权人不匹配，立即停止并报错
```

```markdown
## 前置报告（阶段3: 报告整理）
事实核查报告路径:
/root/debt_review_skills/输出/第1批债权/115-慈溪市东航建筑起重机械安装队/工作底稿/慈溪市东航建筑起重机械安装队_事实核查报告.md

债权分析报告路径:
/root/debt_review_skills/输出/第1批债权/115-慈溪市东航建筑起重机械安装队/工作底稿/慈溪市东航建筑起重机械安装队_债权分析报告.md

要求:
- 必须读取这两个报告进行整理
- 读取后验证两个报告的债权人身份一致
- 验证两个报告的破产日期一致
```

**作用**: 防止读取错误债权人的前置报告。

#### 1.6 关键参数（项目配置）
```markdown
## 关键参数
破产受理日期: 2023-05-12
停止计息日期: 2023-05-11
债务人名称: 上海找油信息科技有限公司

要求:
- 在报告中使用这些日期
- 与配置文件中的日期交叉验证
- 如发现不一致，立即停止并报错
```

**作用**: 提供关键参数，便于交叉验证。

### 原则 2: 三重验证机制 (Triple Verification)

每个 Agent 在并行执行时，必须执行三层验证：

#### 验证层 1: 启动时身份验证

**时机**: Agent 开始工作，读取配置文件之后

**验证内容**:
```
□ 读取 .processing_config.json 成功
□ 配置中的债权人信息与 prompt 中的标识一致:
  - batch_number 一致
  - creditor_number 一致
  - creditor_name 一致
□ 如不一致: 立即停止，报告错误，不继续执行
```

**示例验证代码（伪代码）**:
```python
config = read_json(prompt.config_file_path)
assert config['creditor_info']['batch_number'] == prompt.batch_number
assert config['creditor_info']['creditor_number'] == prompt.creditor_number
assert config['creditor_info']['creditor_name'] == prompt.creditor_name
```

#### 验证层 2: 文件操作前路径验证

**时机**: 读取输入材料前、写入输出文件前

**验证内容**:
```
□ 输入材料路径验证:
  - 路径包含正确的批次号
  - 路径包含正确的债权人编号和名称
  - 文件存在且可读

□ 输出路径验证:
  - 输出目录路径包含正确的债权人标识
  - 目录存在且可写
  - 即将使用的文件名包含正确的债权人名称
```

**示例验证**:
```python
# 输入材料路径验证
input_path = "/root/debt_review_skills/输入/第1批债权/115.慈溪市东航建筑起重机械安装队.md"
assert "第1批债权" in input_path
assert "115" in input_path
assert "慈溪市东航建筑起重机械安装队" in input_path

# 输出路径验证
output_dir = "/root/debt_review_skills/输出/第1批债权/115-慈溪市东航建筑起重机械安装队/工作底稿"
assert "115-慈溪市东航建筑起重机械安装队" in output_dir
```

#### 验证层 3: 完成后内容验证

**时机**: Agent 完成工作，主控制器收到结果后

**验证内容**:
```
□ 文件位置验证:
  - 所有输出文件在正确的债权人目录
  - 文件命名符合模板标准
  - 文件包含正确的债权人名称

□ 内容验证:
  - 报告中的债权人名称、编号正确
  - 报告中的破产日期正确
  - 报告内容与该债权人的材料对应

□ 独立性验证:
  - 不同债权人的报告内容完全不同
  - 无交叉引用或内容混淆迹象
```

### 原则 3: 绝对路径强制原则 (Absolute Path Mandatory)

**规则**: 所有文件路径必须使用绝对路径，禁止使用相对路径或隐式路径。

**理由**: 避免 Agent 基于"当前工作目录"或"上下文状态"猜测路径。

**示例**:
```
✅ 正确: /root/debt_review_skills/输出/第1批债权/115-慈溪市东航建筑起重机械安装队/工作底稿
❌ 错误: 工作底稿/
❌ 错误: ../输出/第1批债权/115-慈溪市东航建筑起重机械安装队/工作底稿
❌ 错误: {base_directory}/工作底稿  (除非在 prompt 中明确定义 base_directory)
```

### 原则 4: 无状态执行原则 (Stateless Execution)

**规则**: 每个 Agent 实例不保存任何关于"当前处理的债权人"的状态，所有信息来自 prompt。

**禁止的行为**:
```
❌ Agent 内部变量: current_creditor = "债权人A"
❌ 基于"上一次处理的债权人"推断当前债权人
❌ 从"最近访问的文件路径"推断当前债权人
```

**允许的行为**:
```
✅ 从 prompt 中提取债权人标识
✅ 从 prompt 中指定的配置文件读取信息
✅ 仅处理 prompt 中明确指定的文件
```

---

## 🔄 并行调用标准流程

### 流程概览

```
用户请求: "并行处理第1批债权的5个债权人（115, 118, 124, 134, 140）"
         ↓
┌────────────────────────────────────────────────────────┐
│ 阶段 0: 环境初始化（串行，必须）                        │
│  - 为5个债权人分别初始化环境                            │
│  - 验证所有配置文件创建成功                              │
│  - 时间: ~2分钟                                          │
└────────────────────────────────────────────────────────┘
         ↓
┌────────────────────────────────────────────────────────┐
│ 阶段 1: 事实核查（并行）                                │
│  1. 为5个债权人生成5个完全自包含的 prompt              │
│  2. 在一个消息中发起5个 Task 调用                       │
│  3. 等待所有5个 agent 实例完成                          │
│  4. 收集5个结果                                          │
│  5. 执行批量质量检查                                     │
│  时间: ~5-6分钟（并行执行）                              │
└────────────────────────────────────────────────────────┘
         ↓ 质量检查点 1
┌────────────────────────────────────────────────────────┐
│ 阶段 2: 债权分析（并行）                                │
│  1. 为5个债权人生成5个 prompt（包含前置报告路径）      │
│  2. 在一个消息中发起5个 Task 调用                       │
│  3. 等待所有5个 agent 实例完成                          │
│  4. 收集5个结果                                          │
│  5. 执行批量质量检查                                     │
│  时间: ~8-10分钟（并行执行）                             │
└────────────────────────────────────────────────────────┘
         ↓ 质量检查点 2
┌────────────────────────────────────────────────────────┐
│ 阶段 3: 报告整理（并行）                                │
│  1. 为5个债权人生成5个 prompt（包含两个前置报告路径）  │
│  2. 在一个消息中发起5个 Task 调用                       │
│  3. 等待所有5个 agent 实例完成                          │
│  4. 收集5个结果                                          │
│  5. 执行批量质量检查                                     │
│  时间: ~3-4分钟（并行执行）                              │
└────────────────────────────────────────────────────────┘
         ↓ 最终验证
┌────────────────────────────────────────────────────────┐
│ 完成: 5个债权人的完整审查报告                          │
│  总时间: ~18-22分钟                                      │
│  效率提升: ~75%（相比串行的 80分钟）                    │
└────────────────────────────────────────────────────────┘
```

### 阶段 0: 环境初始化（串行执行）

**目的**: 为每个债权人创建独立的处理环境

**执行方式**: 串行（逐个初始化）

**操作**:
```bash
# 为5个债权人分别初始化
python 债权处理工作流控制器.py 1 115 慈溪市东航建筑起重机械安装队
python 债权处理工作流控制器.py 1 118 徐小勇
python 债权处理工作流控制器.py 1 124 上海合典建材有限公司
python 债权处理工作流控制器.py 1 134 张之华
python 债权处理工作流控制器.py 1 140 浙江龙达实业股份有限公司
```

**验证**:
```
□ 所有5个债权人的 .processing_config.json 文件已创建
□ 所有配置文件内容正确（批次、编号、名称、路径）
□ 所有标准目录已创建（工作底稿、最终报告、计算文件）
```

**时间**: 约2分钟

### 阶段 1-3: 并行调用模式

**调用方式**: 在一个响应消息中发起多个 Task 调用

**示例**（以阶段1事实核查为例）:

```
Assistant: 我将并行处理这5个债权人的事实核查。使用5个独立的 debt-fact-checker agent 实例，每个处理一个债权人。

[使用 Task 工具，发起5个并行调用]

Task 1:
  subagent_type: "debt-fact-checker"
  description: "Fact-check creditor 115"
  prompt: """
    [完整的自包含 prompt，包含债权人115的所有信息]
    - 债权人标识: 批次1, 编号115, 名称慈溪市东航建筑起重机械安装队
    - 配置文件: [绝对路径]
    - 输入材料: [绝对路径]
    - 输出目录: [绝对路径]
    - 关键参数: 破产日期2023-05-12, ...
    - [其他完整指令]
  """

Task 2:
  subagent_type: "debt-fact-checker"
  description: "Fact-check creditor 118"
  prompt: """
    [完整的自包含 prompt，包含债权人118的所有信息]
    ...
  """

Task 3-5: [同样结构，不同债权人]
```

**等待完成**: Claude Code 系统自动并行执行，等待所有5个 task 完成

**收集结果**: 系统返回5个 agent 的执行结果

---

## 📝 Prompt 模板标准结构

### 模板组成部分

每个并行调用的 prompt 必须包含以下标准结构：

```markdown
# 债权人[名称] - [阶段名称]并行处理

## ⚠️ 重要说明：并行处理模式
你正在并行处理模式下工作。本次任务仅处理**债权人[名称]**，不要处理其他债权人。
所有信息都在本 prompt 中提供，不要依赖任何外部上下文或假设。

---

## 第一部分：债权人身份标识

**批次号**: [X]
**债权人编号**: [XXX]
**债权人名称**: [完整名称]
**处理日期**: [YYYYMMDD]

**身份验证要求**:
- 在开始工作前，读取配置文件验证上述信息
- 如配置文件中的信息与上述不一致，立即停止并报告错误
- 在报告中明确记录债权人身份

---

## 第二部分：配置文件路径

**配置文件路径**（必须使用绝对路径）:
```
/root/debt_review_skills/输出/第[X]批债权/[编号]-[债权人名称]/.processing_config.json
```

**使用要求**:
1. 必须读取此配置文件获取路径和文件名模板
2. 读取后验证 creditor_info 与第一部分的标识一致
3. 使用配置中的 paths 进行所有文件操作
4. 使用配置中的 file_templates 命名输出文件

---

## 第三部分：输入材料路径

**材料文件路径**:
```
/root/debt_review_skills/输入/第[X]批债权/[编号].[债权人名称].md
```

**读取要求**:
1. 必须读取此路径的材料文件
2. 不得读取其他债权人的材料
3. 读取后验证文件内容对应正确的债权人

---

## 第四部分：输出目录路径

**工作底稿目录**:
```
/root/debt_review_skills/输出/第[X]批债权/[编号]-[债权人名称]/工作底稿
```

**最终报告目录**:
```
/root/debt_review_skills/输出/第[X]批债权/[编号]-[债权人名称]/最终报告
```

**计算文件目录**:
```
/root/debt_review_skills/输出/第[X]批债权/[编号]-[债权人名称]/计算文件
```

**输出要求**:
1. 所有输出文件必须写入上述对应目录
2. 文件命名使用配置文件中的 file_templates
3. 写入前验证目录路径包含正确的债权人标识
4. 写入后验证文件已成功保存

---

## 第五部分：前置报告路径（阶段2和3需要）

[阶段1不需要此部分]

[阶段2需要]:
**事实核查报告路径**:
```
/root/debt_review_skills/输出/第[X]批债权/[编号]-[债权人名称]/工作底稿/[债权人名称]_事实核查报告.md
```

**读取要求**:
1. 必须读取此报告作为分析依据
2. 读取后验证报告中的债权人身份
3. 验证报告中的破产日期与下述关键参数一致

[阶段3需要]:
**事实核查报告路径**: [同上]
**债权分析报告路径**:
```
/root/debt_review_skills/输出/第[X]批债权/[编号]-[债权人名称]/工作底稿/[债权人名称]_债权分析报告.md
```

**读取要求**:
1. 必须读取这两个报告进行整理
2. 验证两个报告的债权人身份一致
3. 验证两个报告的破产日期一致

---

## 第六部分：关键参数

**破产受理日期**: 2023-05-12
**停止计息日期**: 2023-05-11
**债务人名称**: 上海找油信息科技有限公司

**日期验证要求**:
1. 与配置文件中的 project_config 交叉验证
2. 与前置报告（如有）中的日期交叉验证
3. 如发现任何不一致，立即停止并报告错误
4. 在输出报告中明确记录这些日期

---

## 第七部分：任务指令

[具体的阶段任务要求，参考各 agent 的标准工作流程]

**关键提醒**:
1. 仅处理本 prompt 中指定的债权人[名称]
2. 所有路径使用绝对路径，不要猜测或假设
3. 严格执行三重验证机制
4. 遵循所有质量标准和核心原则
5. 完成后明确报告处理的债权人身份

---

## 第八部分：防污染检查清单

在完成工作前，请自我验证：

□ 启动时验证：
  - 读取的配置文件路径正确
  - 配置中的债权人信息与 prompt 一致

□ 文件操作验证：
  - 读取的输入材料对应正确的债权人
  - 输出文件写入正确的债权人目录
  - 文件命名包含正确的债权人名称

□ 内容验证：
  - 报告中的债权人信息准确
  - 破产日期与 prompt 中的一致
  - 未混入其他债权人的信息

□ 独立性验证：
  - 仅处理了本 prompt 指定的债权人
  - 未访问其他债权人的文件
  - 输出完全独立于其他债权人

如以上任何一项不满足，请立即停止并报告问题。
```

---

## ✅ 质量检查点标准

### 质量检查点 1: 阶段1完成后

**检查维度**: 事实核查报告质量和隔离性

**检查项目**:
```
□ 文件存在性检查：
  - 所有债权人的事实核查报告已生成
  - 文件位于正确的工作底稿目录
  - 文件命名符合标准（包含债权人名称）

□ 债权人身份检查：
  - 每个报告中的债权人名称、编号正确
  - 不同债权人的报告内容完全不同
  - 无交叉引用或混淆迹象

□ 日期一致性检查：
  - 所有报告的破产受理日期一致（2023-05-12）
  - 所有报告的停止计息日期一致（2023-05-11）
  - 日期格式正确

□ 内容质量检查：
  - 每个报告包含完整的事实核查内容
  - 申报情况、证据分析、法律关系识别完整
  - 无明显的内容缺失或错误

□ 独立性验证：
  - 手动抽查: 债权人A的报告不包含债权人B的信息
  - 交叉验证: 不同债权人的合同、金额、日期完全不同
```

**通过标准**: 所有检查项全部通过

**不通过处理**:
- 识别失败的债权人
- 分析失败原因（配置错误、上下文污染、Agent 错误）
- 单独重新处理失败的债权人
- 不影响成功的债权人

### 质量检查点 2: 阶段2完成后

**检查维度**: 债权分析报告和计算文件

**检查项目**:
```
□ 文件存在性检查：
  - 所有债权人的债权分析报告已生成
  - 所有债权人的计算文件已生成（或无计算项说明）
  - 文件位于正确的目录

□ 前置依赖检查：
  - 每个分析报告使用了正确的事实核查报告
  - 分析报告中引用的事实与事实核查报告一致
  - 无跨债权人引用

□ 日期交叉验证：
  - 分析报告与事实核查报告的破产日期一致
  - 利息计算使用了正确的停止计息日期
  - 诉讼时效分析使用了正确的参考日期

□ 计算质量检查：
  - Calculator 工具使用记录完整
  - 计算文件存在且格式正确
  - 就低原则、就无原则正确应用

□ 独立性验证：
  - 不同债权人的金额、利息计算完全独立
  - 无计算参数混淆
```

### 质量检查点 3: 阶段3完成后

**检查维度**: 最终报告和文件组织

**检查项目**:
```
□ 文件存在性检查：
  - 所有债权人的审查意见表已生成
  - 所有债权人的文件清单已生成
  - 文件命名符合标准（GY2025_[债权人]_债权审查报告_[日期].md）

□ 内容整合检查：
  - 审查意见表正确整合了事实核查和债权分析内容
  - 无内容丢失或修改
  - 模板应用正确

□ 三报告一致性验证：
  - 三个报告（事实核查、债权分析、审查意见）的债权人信息一致
  - 三个报告的破产日期一致
  - 三个报告的金额、结论一致

□ 文件清单验证：
  - 文件清单列出了所有工作文件
  - 文件路径和大小准确
  - 无遗漏

□ 交付质量验证：
  - 最终报告符合客户模板要求
  - 专业语言规范
  - 格式正确
```

### 最终验证: 全部完成后

**全局交叉验证**:
```
□ 批量完整性检查：
  - 所有债权人都完成了三个阶段
  - 每个债权人都有完整的文件集（3个报告+计算文件+清单）

□ 目录组织检查：
  - 所有文件在正确的债权人子目录
  - 无文件散落在错误位置
  - 目录结构符合标准

□ 独立性最终验证：
  - 随机抽查2-3个债权人的报告
  - 深度验证内容独立性
  - 确认无任何上下文污染

□ 可交付性验证：
  - 每个债权人的报告都可以独立交付
  - 报告内容完整、准确、专业
  - 符合所有质量标准
```

---

## 🚨 错误隔离与恢复机制

### 隔离原则

**核心**: 一个债权人的失败不影响其他债权人

**实现**:
- 每个 Task 独立执行，独立报告结果
- Agent 实例之间完全隔离，无共享状态
- 文件系统隔离（独立目录）

### 错误类型与处理

#### 类型 1: 配置验证失败

**症状**: Agent 启动时发现配置文件中的债权人信息与 prompt 不一致

**处理**:
```
1. Agent 立即停止，不执行任何业务逻辑
2. Agent 报告错误: "配置验证失败: prompt 指定债权人X，配置文件显示债权人Y"
3. 主控制器标记该债权人为失败
4. 其他债权人继续正常执行
5. 修复配置后单独重新处理该债权人
```

#### 类型 2: 文件路径错误

**症状**: Agent 无法读取输入材料或无法写入输出

**处理**:
```
1. Agent 报告具体的文件路径错误
2. 主控制器验证路径是否正确
3. 如 prompt 错误: 修正 prompt 后重新处理
4. 如环境问题: 重新初始化环境后重新处理
5. 其他债权人不受影响
```

#### 类型 3: 前置报告缺失

**症状**: 阶段2或3的 Agent 无法找到前置报告

**处理**:
```
1. Agent 报告前置报告缺失
2. 主控制器检查前一阶段是否成功
3. 如前一阶段未执行: 先执行前一阶段
4. 如前一阶段失败: 重新执行前一阶段
5. 其他债权人继续或等待
```

#### 类型 4: 日期不一致

**症状**: Agent 发现配置文件、前置报告、prompt 中的破产日期不一致

**处理**:
```
1. Agent 立即停止，不继续执行
2. Agent 详细报告日期不一致的具体情况
3. 主控制器检查 project_config.ini 的权威日期
4. 修正配置或 prompt 后重新处理
5. 该错误可能影响同批次所有债权人，需全面检查
```

### 重试策略

**单个债权人重试**:
```python
# 伪代码
results = parallel_process([creditor_A, B, C, D, E])

for creditor, result in results:
    if result.status == "failed":
        # 分析失败原因
        error_type = analyze_error(result.error)

        # 修复问题
        fix_issue(creditor, error_type)

        # 重新处理（单独调用，不并行）
        retry_result = process_single_creditor(creditor)

        # 更新结果
        results[creditor] = retry_result
```

**批量重试**:
```
如果多个债权人因相同原因失败（如配置模板错误）:
1. 修复根本问题
2. 批量重新处理失败的债权人
3. 成功的债权人不重新处理
```

---

## 📊 性能监控与优化

### 监控指标

**执行时间监控**:
```
- 每个阶段的总耗时
- 每个 Agent 实例的耗时（最快、最慢、平均）
- 与串行模式对比
```

**成功率监控**:
```
- 一次性成功率（首次执行全部成功的比例）
- 重试后成功率
- 失败原因分布
```

**资源使用监控**:
```
- 并发 Agent 数量
- 系统响应时间
- 潜在的资源瓶颈
```

### 性能优化建议

**批量大小优化**:
```
- 2-5个债权人: 最佳性能，推荐
- 6-10个债权人: 良好性能，可接受
- 10+个债权人: 考虑分批，每批5-8个
```

**分批策略**:
```
如有15个债权人:
批次1: 债权人 1-5  (并行处理3个阶段)
批次2: 债权人 6-10 (并行处理3个阶段)
批次3: 债权人 11-15 (并行处理3个阶段)

相比一次性15个并行的优势:
- 降低系统负载
- 更容易监控和调试
- 失败影响范围更小
```

---

## 📚 参考模板和示例

### Prompt 生成工具

**自动化工具**: `parallel_prompt_generator.py`

**功能**: 自动生成符合本协议标准的并行处理 prompts

**使用方法**:
```bash
# 生成 Stage 1 prompts
python parallel_prompt_generator.py --stage 1 --batch 1 --creditors 115,118,124

# 生成 Stage 2 prompts
python parallel_prompt_generator.py --stage 2 --batch 1 --creditors 115,118

# 生成所有阶段的 prompts
python parallel_prompt_generator.py --stage all --batch 1 --creditors 115
```

**输出位置（默认）**:
```
输出/第X批债权/[编号]-[债权人名称]/并行处理prompts/
├── stage1_creditor115_[name]_prompt.txt
├── stage2_creditor115_[name]_prompt.txt
└── stage3_creditor115_[name]_prompt.txt
```

**自定义输出**（可选）:
```bash
# 保存到指定目录（例如，用于审查后再移动到债权人目录）
python parallel_prompt_generator.py --stage 1 --batch 1 --creditors 115,118 --output /tmp/review_prompts
```

**重要说明**:
- Prompts 默认保存到各债权人的 `并行处理prompts/` 子目录
- 作为审计追踪的一部分，prompts 应保留在债权人文件夹中
- Report-organizer agent 会在文件清单中列出这些 prompts
- 这些 prompts 记录了处理时使用的完整任务描述，便于复现和审计

**详细使用指南**: 参见 `CLAUDE.md` 中的工作流执行详细说明部分

---

### 完整的 Prompt 模板示例

详见:
- `parallel_prompt_templates/stage1_fact_checking_parallel_template.md`
- `parallel_prompt_templates/stage2_debt_analysis_parallel_template.md`
- `parallel_prompt_templates/stage3_report_organization_parallel_template.md`

### 质量检查清单

详见:
- `PARALLEL_QUALITY_CHECKLIST.md`

### 用户操作指南

详见:
- `PARALLEL_PROCESSING_USER_GUIDE.md`

---

## 🔄 协议版本历史

**v1.0 (2025-10-26)**:
- 初始版本
- 定义核心隔离原则
- 建立三重验证机制
- 规范并行调用流程
- 制定质量检查标准

---

## ✅ 协议验收标准

使用本协议进行并行处理后，必须满足:

```
□ 零上下文污染: 无任何债权人信息混淆
□ 质量一致性: 与串行处理质量完全相同
□ 完整独立性: 每个债权人的报告可独立交付
□ 审计完整性: 每个债权人有完整的审计追踪
□ 效率提升: 批量处理时间减少 70%+
```

---

**协议制定**: Claude Code Debt Review System
**协议版本**: 1.0
**生效日期**: 2025-10-26
**适用范围**: 所有阶段内并行处理场景
