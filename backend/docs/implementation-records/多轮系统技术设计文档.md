# 多轮交互架构技术设计文档

**版本**: v1.0
**日期**: 2025-11-12
**状态**: 开发中

---

## 1. 轮次隔离目录结构设计

### 1.1 单个债权人的完整目录结构

```
输出/第X批债权/[编号]-[债权人名称]/
├── .processing_config.json           # 项目全局配置（原有）
├── .current_round.json                # 当前轮次指针（新增）
│
├── round_1/                           # 第一轮（基础轮）
│   ├── .round_metadata.json           # 轮次元数据
│   ├── 输入材料/                       # 原始申报材料
│   ├── 工作底稿/                       # 技术报告
│   ├── 计算文件/                       # 计算过程文件
│   └── 最终报告/                       # 客户交付物
│
├── round_2/                           # 第二轮（补充轮）
│   ├── .round_metadata.json           # 轮次元数据
│   ├── .changelog.json                # 变更日志（新增）
│   ├── 输入材料/                       # 补充材料
│   ├── 工作底稿/                       # 增量更新的报告
│   ├── 计算文件/                       # 增量计算文件
│   └── 最终报告/                       # 最新版本报告
│
└── round_N/                           # 第N轮
    └── ...（同round_2结构）
```

### 1.2 向后兼容的迁移路径

**旧格式**（无轮次结构）：
```
输出/第X批债权/[编号]-[债权人名称]/
├── .processing_config.json
├── 工作底稿/
├── 计算文件/
├── 最终报告/
└── 并行处理prompts/
```

**迁移后**（round_1/结构）：
```
输出/第X批债权/[编号]-[债权人名称]/
├── .processing_config.json
├── .current_round.json                # 新增
│
└── round_1/                           # 新增
    ├── .round_metadata.json           # 新增
    ├── 工作底稿/                       # 从旧位置移动
    ├── 计算文件/                       # 从旧位置移动
    ├── 最终报告/                       # 从旧位置移动
    └── 并行处理prompts/               # 从旧位置移动
```

---

## 2. 元数据文件格式定义

### 2.1 `.round_metadata.json` - 轮次元数据

**用途**: 记录单个轮次的处理信息

**位置**: `round_N/.round_metadata.json`

**格式**:
```json
{
  "round_number": 2,
  "created_at": "2025-11-12T14:30:00",
  "status": "completed",
  "processing_mode": "incremental",
  "parent_round": 1,

  "trigger_reason": "补充证据材料",
  "fields_updated": ["judgment_document", "performance_evidence"],

  "processing_summary": {
    "stages_executed": [1, 3],
    "stages_skipped": [2],
    "time_saved_seconds": 420,
    "time_saved_percent": 60
  },

  "agent_execution": {
    "stage1_debt_fact_checker": {
      "executed": true,
      "mode": "incremental",
      "start_time": "2025-11-12T14:32:00",
      "end_time": "2025-11-12T14:38:00",
      "duration_seconds": 360
    },
    "stage2_debt_claim_analyzer": {
      "executed": false,
      "mode": "skipped",
      "reason": "前轮计算结果不受影响，直接复用"
    },
    "stage3_report_organizer": {
      "executed": true,
      "mode": "incremental",
      "start_time": "2025-11-12T14:40:00",
      "end_time": "2025-11-12T14:45:00",
      "duration_seconds": 300
    }
  },

  "quality_checks": {
    "date_consistency": "passed",
    "calculation_integrity": "passed",
    "file_placement": "passed"
  }
}
```

**字段说明**:
- `round_number`: 轮次号（1, 2, 3, ...）
- `status`: 状态（initialized, processing, completed, failed）
- `processing_mode`: 处理模式（full, incremental, partial）
- `parent_round`: 父轮次号（第一轮为null）
- `trigger_reason`: 触发原因（用户友好描述）
- `fields_updated`: 本轮变更的字段列表
- `processing_summary`: 处理摘要（执行/跳过的阶段、节省时间）
- `agent_execution`: 各Agent执行详情
- `quality_checks`: 质量检查结果

---

### 2.2 `.current_round.json` - 当前轮次指针

**用途**: 快速定位当前轮次和最新报告

**位置**: `[债权人根目录]/.current_round.json`

**格式**:
```json
{
  "current_round": 2,
  "total_rounds": 2,
  "latest_report_path": "round_2/最终报告/GY2025_债权人_债权审查报告_20251112_v2.md",
  "last_updated": "2025-11-12T14:45:00"
}
```

**字段说明**:
- `current_round`: 当前轮次号
- `total_rounds`: 总轮次数（与current_round相同）
- `latest_report_path`: 最新最终报告的相对路径
- `last_updated`: 最后更新时间

---

### 2.3 `.changelog.json` - 变更日志

**用途**: 详细记录本轮相对前轮的所有变更

**位置**: `round_N/.changelog.json`（N > 1）

**格式**:
```json
{
  "round_number": 2,
  "parent_round": 1,
  "created_at": "2025-11-12T14:30:00",

  "changes": [
    {
      "field": "judgment_document",
      "category": "证据材料",
      "old_value": null,
      "new_value": {
        "file_name": "（2024）沪01民初123号民事判决书.pdf",
        "judgment_amount": "100万元",
        "judgment_date": "2024-06-15"
      },
      "change_type": "addition",
      "priority": "HIGH",
      "impact": {
        "stages": [1, 2, 3],
        "debt_items": ["本金", "利息"],
        "report_sections": [2, 3, 4]
      },
      "reason": "补充生效法律文书"
    },
    {
      "field": "performance_evidence",
      "category": "证据材料",
      "old_value": ["银行流水（部分）"],
      "new_value": ["银行流水（部分）", "收货签收单", "对账单"],
      "change_type": "modification",
      "priority": "HIGH",
      "impact": {
        "stages": [1, 3],
        "debt_items": ["本金"],
        "report_sections": [2, 3]
      },
      "reason": "补充履行证据"
    }
  ],

  "supplemental_materials": [
    {
      "filename": "（2024）沪01民初123号民事判决书.pdf",
      "type": "生效法律文书",
      "pages": 15,
      "upload_time": "2025-11-12T14:25:00"
    },
    {
      "filename": "收货签收单.pdf",
      "type": "履行证据",
      "pages": 3,
      "upload_time": "2025-11-12T14:26:00"
    }
  ],

  "processing_decision": {
    "mode": "incremental",
    "reason": "HIGH优先级字段变更，不触发完整重审",
    "estimated_time_savings": "60%",
    "user_confirmed": true,
    "confirmed_at": "2025-11-12T14:31:00"
  }
}
```

**字段说明**:
- `changes`: 字段变更列表
  - `field`: 字段名称
  - `category`: 字段类别（用户友好）
  - `old_value`: 旧值
  - `new_value`: 新值
  - `change_type`: 变更类型（addition, modification, deletion）
  - `priority`: 优先级（CRITICAL, HIGH, MEDIUM, LOW）
  - `impact`: 影响范围（stages, debt_items, report_sections）
  - `reason`: 变更原因
- `supplemental_materials`: 补充材料清单
- `processing_decision`: 处理决策记录

---

## 3. 字段优先级分类系统

### 3.1 优先级定义

| 优先级 | 触发模式 | 典型场景 | 节省时间 |
|--------|---------|---------|---------|
| **CRITICAL** | Full（完整重审） | 破产日期变更、法律关系变更 | 0% |
| **HIGH** | Incremental（增量处理） | 补充证据、担保方式变更 | 60-75% |
| **MEDIUM** | Incremental（增量处理） | 金额调整、日期调整 | 70-80% |
| **LOW** | Partial（局部更新） | 联系方式、备注变更 | 85%+ |

### 3.2 字段分类清单

#### CRITICAL字段（5个）

```python
CRITICAL_FIELDS = {
    "bankruptcy_date": {
        "display_name": "破产受理日期",
        "reason": "决定所有法律期限和利息计算终点",
        "impact": "ALL",
        "example": "2024-12-31"
    },
    "interest_stop_date": {
        "display_name": "停止计息日期",
        "reason": "直接影响所有利息计算结果",
        "impact": "ALL",
        "example": "2024-12-30"
    },
    "legal_relationship_type": {
        "display_name": "法律关系类型",
        "reason": "决定适用法律标准和举证责任",
        "impact": "ALL",
        "example": "买卖合同关系|借款合同关系"
    },
    "debt_nature": {
        "display_name": "债权性质",
        "reason": "决定劣后顺位、清偿优先级",
        "impact": "ALL",
        "example": "普通债权|担保债权|职工债权"
    },
    "statute_of_limitations_status": {
        "display_name": "诉讼时效状态",
        "reason": "决定债权是否可获清偿",
        "impact": "ALL",
        "example": "未过时效|已过时效但有中断"
    }
}
```

#### HIGH字段（6个，重点支持补充证据场景）

```python
HIGH_FIELDS = {
    "judgment_document": {
        "display_name": "生效法律文书",
        "reason": "最高证据等级，影响所有认定",
        "impact": "stages: [1, 2, 3], debt_items: ALL",
        "example": "（2024）沪01民初123号民事判决书"
    },
    "performance_evidence": {
        "display_name": "履行证据",
        "reason": "影响金额确认和事实认定",
        "impact": "stages: [1, 2, 3], debt_items: [本金, 利息]",
        "example": "银行流水、发票、签收单"
    },
    "guarantee_type": {
        "display_name": "担保方式",
        "reason": "影响债权性质认定和清偿顺位",
        "impact": "stages: [1, 3], debt_items: [担保债权]",
        "example": "抵押担保|保证担保|质押担保|无担保"
    },
    "collateral_value": {
        "display_name": "担保物价值",
        "reason": "影响债权清偿可能性评估",
        "impact": "stages: [1, 3], debt_items: [担保债权]",
        "example": "500万元（评估价值）"
    },
    "interest_rate_clause": {
        "display_name": "利率约定",
        "reason": "直接影响利息计算",
        "impact": "stages: [2, 3], debt_items: [利息, 复利]",
        "example": "年利率6%|LPR+50BP|未约定"
    },
    "penalty_clause": {
        "display_name": "违约金约定",
        "reason": "影响违约金计算和上限适用",
        "impact": "stages: [2, 3], debt_items: [违约金, 罚息]",
        "example": "每日千分之一|总额30%上限"
    }
}
```

#### MEDIUM字段（5个）

```python
MEDIUM_FIELDS = {
    "contract_signing_date": {
        "display_name": "合同签订日期",
        "reason": "影响诉讼时效起算点",
        "impact": "stages: [2], sections: [3]",
        "example": "2023-06-15"
    },
    "payment_deadline": {
        "display_name": "付款期限",
        "reason": "影响利息起算日",
        "impact": "stages: [2], debt_items: [利息]",
        "example": "2023-12-31"
    },
    "declared_principal": {
        "display_name": "申报本金",
        "reason": "影响就低原则适用",
        "impact": "stages: [2], debt_items: [本金]",
        "example": "100万元"
    },
    "declared_interest": {
        "display_name": "申报利息",
        "reason": "影响就低原则适用",
        "impact": "stages: [2], debt_items: [利息]",
        "example": "5万元"
    },
    "creditor_contact": {
        "display_name": "债权人联系方式",
        "reason": "影响报告抬头和送达信息",
        "impact": "stages: [3], sections: [1]",
        "example": "电话: 13812345678"
    }
}
```

#### LOW字段（3个）

```python
LOW_FIELDS = {
    "project_description": {
        "display_name": "项目描述",
        "reason": "仅影响背景描述",
        "impact": "stages: [3], sections: [1]",
        "example": "建材供应纠纷"
    },
    "notes": {
        "display_name": "备注信息",
        "reason": "不影响法律认定",
        "impact": "stages: [3], sections: [6]",
        "example": "需补充证据"
    },
    "processing_date": {
        "display_name": "处理日期",
        "reason": "自动生成字段",
        "impact": "无影响",
        "example": "20251112"
    }
}
```

---

## 4. 影响分析映射表

### 4.1 IMPACT_MAPPINGS定义

```python
IMPACT_MAPPINGS = {
    # ========== CRITICAL字段影响映射 ==========

    "bankruptcy_date": {
        "stages": [1, 2, 3],
        "debt_items": ["ALL"],
        "report_sections": ["ALL"],
        "reason": "破产日期变更影响所有日期计算和时间节点"
    },

    "interest_stop_date": {
        "stages": [2, 3],
        "debt_items": ["利息", "违约金", "逾期利息", "罚息", "复利"],
        "report_sections": [2, 3, 4],
        "reason": "停止计息日变更影响所有利息类计算结果"
    },

    # ... (其他字段映射详见config/impact_mappings.py)
}
```

### 4.2 债权项目类型定义

```python
DEBT_ITEM_TYPES = [
    "本金",
    "利息",
    "违约金",
    "逾期利息",
    "罚息",
    "复利",
    "担保债权",
    "保证债权",
    "ALL"  # 通配符
]
```

### 4.3 报告章节定义

```python
REPORT_SECTIONS = {
    1: "债权人基本信息",
    2: "债权申报情况",
    3: "事实查明与证据认定",
    4: "债权金额确认意见",
    5: "综合审查意见",
    6: "备注说明",
    "ALL": "所有章节"
}
```

### 4.4 章节依赖关系

```python
CHAPTER_DEPENDENCIES = {
    1: [],  # 债权人基本信息，无依赖
    2: [1],  # 债权申报情况，依赖第1章
    3: [1, 2],  # 事实查明，依赖第1、2章
    4: [2, 3],  # 债权金额确认，依赖第2、3章
    5: [1, 2, 3, 4],  # 综合审查意见，依赖所有前章
    6: []  # 备注说明，无依赖
}
```

---

## 5. 三种处理模式详细定义

### 5.1 Full模式

**触发条件**:
```python
def should_trigger_full_mode(fields_updated: List[str]) -> bool:
    critical_fields = [
        "bankruptcy_date",
        "interest_stop_date",
        "legal_relationship_type",
        "debt_nature",
        "statute_of_limitations_status"
    ]
    return any(field in critical_fields for field in fields_updated)
```

**执行流程**:
1. Stage 1: 完整重新执行事实核查
2. Stage 2: 完整重新计算所有债权项
3. Stage 3: 完整重新生成最终报告
4. 不依赖前轮任何结果

**预计时间**: 100% (12-15分钟)
**节省时间**: 0%

---

### 5.2 Incremental模式

**触发条件**:
```python
def should_trigger_incremental_mode(fields_updated: List[str]) -> bool:
    high_fields = ["judgment_document", "performance_evidence", ...]
    medium_fields = ["contract_signing_date", "declared_principal", ...]

    return (any(field in high_fields + medium_fields for field in fields_updated) and
            not should_trigger_full_mode(fields_updated))
```

**执行流程**:
1. Stage 1:
   - 如果证据材料变更：增量事实核查
   - 如果仅配置变更：跳过
2. Stage 2:
   - 加载前轮计算结果
   - 仅重算受影响债权项
   - 复用不受影响债权项
3. Stage 3:
   - 加载前轮最终报告
   - 仅重新生成受影响章节
   - 复用不受影响章节

**预计时间**: 25-40% (3-6分钟)
**节省时间**: 60-75%

---

### 5.3 Partial模式

**触发条件**:
```python
def should_trigger_partial_mode(fields_updated: List[str]) -> bool:
    low_fields = ["project_description", "notes", "creditor_contact"]
    return all(field in low_fields for field in fields_updated)
```

**执行流程**:
1. Stage 1, 2: 跳过
2. Stage 3: 最小单元更新（仅更新受影响的具体内容）

**预计时间**: 10-20% (1-3分钟)
**节省时间**: 80-90%

---

## 6. 保守策略的影响分析算法

### 6.1 保守策略设计原则

1. **不确定时倾向Full模式**: 如果无法明确判断影响范围，使用Full模式
2. **用户确认机制**: Incremental和Partial模式需要用户确认
3. **CRITICAL字段强制Full**: 无需用户确认，直接执行Full模式
4. **清晰的影响展示**: 向用户展示详细的影响范围和预计节省时间

### 6.2 算法实现

```python
class ImpactAnalyzer:
    def analyze_impact(self, fields_updated: List[str]) -> ImpactAnalysisResult:
        # 1. 确定最高优先级
        highest_priority = self._get_highest_priority(fields_updated)

        # 2. 确定处理模式（保守策略）
        if highest_priority == "CRITICAL":
            processing_mode = ProcessingMode.FULL
            user_confirm_required = False  # CRITICAL强制Full，无需确认
            reasoning = "检测到CRITICAL字段变更，必须完整重审以确保准确性"
        elif highest_priority == "HIGH":
            processing_mode = ProcessingMode.INCREMENTAL
            user_confirm_required = True  # 需要用户确认
            reasoning = "检测到HIGH字段变更，建议增量处理以节省时间"
        elif highest_priority == "MEDIUM":
            processing_mode = ProcessingMode.INCREMENTAL  # 保守：MEDIUM也用Incremental
            user_confirm_required = True
            reasoning = "检测到MEDIUM字段变更，建议增量处理"
        else:  # LOW
            processing_mode = ProcessingMode.PARTIAL
            user_confirm_required = True
            reasoning = "检测到LOW字段变更，仅需局部更新"

        # 3. 计算影响范围
        affected_stages = set()
        affected_debt_items = set()
        affected_sections = set()

        for field in fields_updated:
            mapping = IMPACT_MAPPINGS.get(field)
            if mapping:
                affected_stages.update(mapping.get("stages", []))
                affected_debt_items.update(mapping.get("debt_items", []))
                affected_sections.update(mapping.get("report_sections", []))
            else:
                # 未知字段：保守处理，标记为影响所有
                print(f"⚠️  未知字段 {field}，保守处理为影响所有")
                affected_stages = {1, 2, 3}
                affected_debt_items = {"ALL"}
                affected_sections = {"ALL"}
                processing_mode = ProcessingMode.FULL
                reasoning = f"未知字段 {field}，保守处理为完整重审"
                break

        # 4. 处理通配符
        if "ALL" in affected_debt_items:
            affected_debt_items = set(DEBT_ITEM_TYPES)
            affected_debt_items.discard("ALL")

        if "ALL" in affected_sections:
            affected_sections = set(REPORT_SECTIONS.keys())
            affected_sections.discard("ALL")

        # 5. 计算预计节省时间
        time_savings = self._calculate_time_savings(processing_mode, affected_stages)

        return ImpactAnalysisResult(
            processing_mode=processing_mode,
            affected_stages=sorted(affected_stages),
            affected_debt_items=sorted(affected_debt_items),
            affected_sections=sorted(affected_sections),
            fields_updated=fields_updated,
            highest_priority=highest_priority,
            time_savings_percent=time_savings,
            reasoning=reasoning,
            user_confirm_required=user_confirm_required
        )
```

---

## 7. Agent改造技术要点

### 7.1 debt-fact-checker Agent增量能力

**新增配置字段**:
```json
{
  "incremental_mode": {
    "enabled": true,
    "previous_round": 1,
    "previous_report_path": "round_1/工作底稿/{债权人}_事实核查报告.md",
    "supplemental_materials_path": "round_2/输入材料/",
    "merge_strategy": "append_with_markers"
  }
}
```

**关键实现点**:
1. 加载前轮报告作为基础
2. 仅处理补充材料
3. 标记本轮新增内容（"（第N轮补充）"）
4. 合并前轮+本轮生成完整报告

---

### 7.2 debt-claim-analyzer Agent增量能力

**新增配置字段**:
```json
{
  "incremental_mode": {
    "enabled": true,
    "previous_round": 1,
    "previous_analysis_path": "round_1/工作底稿/{债权人}_债权分析报告.md",
    "previous_calc_files_path": "round_1/计算文件/",
    "affected_debt_items": ["利息", "违约金"],
    "reusable_debt_items": ["本金"]
  }
}
```

**关键实现点**:
1. 识别受影响债权项（从impact_analysis读取）
2. 对于受影响项：重新计算
3. 对于不受影响项：直接复用前轮结果
4. 标记哪些是复用、哪些是重新计算

---

### 7.3 report-organizer Agent增量能力

**新增配置字段**:
```json
{
  "incremental_mode": {
    "enabled": true,
    "previous_round": 1,
    "previous_final_report_path": "round_1/最终报告/GY2025_{债权人}_债权审查报告_*.md",
    "affected_sections": [3, 4, 5],
    "reusable_sections": [1, 2, 6],
    "add_revision_note": true
  }
}
```

**关键实现点**:
1. 解析前轮报告为章节
2. 应用章节依赖算法计算需要更新的章节
3. 仅重新生成受影响章节
4. 复用不受影响章节
5. 添加修订说明

---

## 8. 批量多轮处理优化

### 8.1 批量影响分析

```bash
# 批量分析整个批次的补充材料
python 债权处理工作流控制器.py --analyze-batch 1 \
  --supplemental-dir 输入/第1批债权/补充材料/
```

**实现要点**:
1. 自动识别每个债权人的补充材料
2. 并行执行影响分析
3. 生成批量分析报告
4. 按优先级排序展示

### 8.2 批量执行（Stage级并行）

```bash
# 批量处理第1批的Round 2
python 债权处理工作流控制器.py --process-batch 1 \
  --round 2 --mode auto --parallel
```

**执行流程**:
```
Stage 0 (串行): 初始化所有债权人的Round 2环境
     ↓
Stage 1 (并行): 同时执行所有债权人的事实核查
     ↓ 质量检查点
Stage 2 (并行): 同时执行所有债权人的债权分析
     ↓ 质量检查点
Stage 3 (并行): 同时执行所有债权人的报告整理
     ↓
完成: 批量处理完成报告
```

---

## 9. 质量保证机制

### 9.1 日期一致性强制验证

**验证点**:
1. 每个Agent执行前：验证配置文件的日期
2. 每个Agent执行后：验证输出报告的日期
3. 跨轮次验证：确保所有轮次使用相同的破产日期

**实现**:
```python
def validate_date_consistency(base_path: Path, round_number: int) -> bool:
    # 1. 读取配置日期
    config = read_processing_config(base_path)
    bankruptcy_date = config["bankruptcy_date"]
    interest_stop_date = config["interest_stop_date"]

    # 2. 验证前轮报告日期（如果存在）
    if round_number > 1:
        previous_reports = glob_previous_reports(base_path, round_number - 1)
        for report in previous_reports:
            if not verify_dates_in_report(report, bankruptcy_date):
                raise DateInconsistencyError(f"前轮报告日期不一致: {report}")

    # 3. 验证本轮报告日期
    current_reports = glob_current_reports(base_path, round_number)
    for report in current_reports:
        if not verify_dates_in_report(report, bankruptcy_date):
            raise DateInconsistencyError(f"本轮报告日期不一致: {report}")

    return True
```

### 9.2 计算完整性审计

**验证点**:
1. 所有申报的债权项都有对应的分析
2. 所有需要计算的项目都有计算文件或说明
3. 计算文件与报告中的金额一致

### 9.3 格式合规性检查

**验证点**:
1. 最终报告无Markdown语法（##, -, **）
2. 章节结构完整
3. 文件命名符合标准

---

## 10. 版本历史

| 版本 | 日期 | 作者 | 变更内容 |
|-----|------|------|---------|
| v1.0 | 2025-11-12 | System | 初始版本，定义核心架构和数据结构 |

---

**文档状态**: 开发中
**下一步**: 实现config/field_priorities.py和config/impact_mappings.py
