# 多轮债权处理用户指南

**版本**: v3.0 MVP
**更新日期**: 2025-11-12
**状态**: Week 2 完成 - Full模式已实现

---

## 目录

1. [系统架构概览](#系统架构概览)
2. [快速开始](#快速开始)
3. [完整工作流程](#完整工作流程)
4. [命令行工具使用](#命令行工具使用)
5. [与Claude Code CLI集成](#与claude-code-cli集成)
6. [常见场景示例](#常见场景示例)
7. [故障排查](#故障排查)

---

## 系统架构概览

### 三层架构设计

```
┌─────────────────────────────────────────────────────────────┐
│  层级1: Claude Code CLI (用户交互层)                          │
│  - 用户命令输入                                                │
│  - Task工具调用Agents                                         │
│  - 结果展示和确认                                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  层级2: multi_round_controller.py (协调层)                    │
│  - 轮次结构管理                                                │
│  - 影响分析决策                                                │
│  - Agent调用配置准备                                           │
│  - 元数据跟踪                                                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  层级3: Agents (执行层)                                        │
│  - debt-fact-checker: 事实核查                                │
│  - debt-claim-analyzer: 债权分析                              │
│  - report-organizer: 报告整理                                 │
└─────────────────────────────────────────────────────────────┘
```

### 核心组件

| 组件 | 文件 | 功能 |
|------|------|------|
| **字段优先级系统** | `config/field_priorities.py` | 19个字段分类为CRITICAL/HIGH/MEDIUM/LOW |
| **影响分析映射** | `config/impact_mappings.py` | 字段变更→影响范围映射表 |
| **影响分析器** | `src/impact_analyzer.py` | 智能决策：Full/Incremental/Partial |
| **轮次管理器** | `src/round_manager.py` | 轮次生命周期管理 |
| **迁移工具** | `src/migration_tool.py` | 旧格式→轮次结构自动迁移 |
| **多轮控制器** | `src/multi_round_controller.py` | **核心协调器** |

---

## 快速开始

### 前提条件

```bash
# 1. 确认项目根目录
cd /root/debt_review_skills

# 2. 确认Python环境
python --version  # Python 3.7+

# 3. 确认核心文件存在
ls config/field_priorities.py
ls config/impact_mappings.py
ls src/impact_analyzer.py
ls src/round_manager.py
ls src/multi_round_controller.py
```

### 第一次使用：测试安装

```bash
# 运行自检测试
python src/multi_round_controller.py test

# 预期输出：
# ✓ 测试1: 确保轮次结构（自动迁移）
# ✓ 测试2: 初始化Round 2
# ✓ 测试3: 显示历史
# ✓ 测试4: 回滚到Round 1
```

---

## 完整工作流程

### 场景1: 首次处理（Round 1）

**现有v2.0工作流不变！** 使用原有的`债权处理工作流控制器.py`:

```bash
# Round 1按照v2.0标准流程处理
python 债权处理工作流控制器.py 1 115 债权人名称
# → 初始化环境
# → 调用三个Agents顺序处理
# → 生成最终报告
```

**自动迁移**: 如果债权人目录是旧格式（`工作底稿/`直接在债权人目录下），系统会**自动迁移**到轮次结构（`round_1/工作底稿/`）。

### 场景2: 补充材料处理（Round 2+）

当债权人提供补充证据材料时：

#### Step 1: 准备补充材料配置文件

创建 `supplemental_materials.json`:

```json
{
  "judgment_document": "新增生效判决书.pdf",
  "performance_evidence": "补充银行流水.pdf",
  "notes": "债权人补充提供生效判决书和完整银行流水"
}
```

**字段说明**:
- `judgment_document`: HIGH优先级，生效法律文书（最高证据等级）
- `performance_evidence`: HIGH优先级，履行证据
- `notes`: LOW优先级，备注说明

#### Step 2: 分析影响

```bash
python src/multi_round_controller.py analyze \
    --batch 1 \
    --number 115 \
    --name "债权人名称" \
    --supplemental supplemental_materials.json
```

**输出示例**:

```json
{
  "success": true,
  "impact_analysis": {
    "processing_mode": "incremental",
    "highest_priority": "HIGH",
    "affected_stages": [1, 2, 3],
    "affected_debt_items": ["本金", "利息", "违约金"],
    "affected_sections": [2, 3, 4, 5],
    "time_savings_percent": 65,
    "reasoning": "HIGH优先级字段变更，建议增量处理",
    "user_confirm_required": true
  },
  "recommendation": "建议使用Incremental模式处理（预计节省65%时间）"
}
```

#### Step 3: 初始化新轮次

```bash
python src/multi_round_controller.py init-round \
    --batch 1 \
    --number 115 \
    --name "债权人名称" \
    --round 2
```

**输出**:

```json
{
  "success": true,
  "message": "轮次 2 初始化成功",
  "round_number": 2,
  "round_directory": "输出/第1批债权/115-债权人名称/round_2"
}
```

**目录结构**:

```
115-债权人名称/
├── .current_round.json         # 当前轮次指针
├── round_1/                    # 第一轮（已完成）
│   ├── .round_metadata.json
│   ├── 工作底稿/
│   ├── 最终报告/
│   └── 计算文件/
└── round_2/                    # 第二轮（新建）
    ├── .round_metadata.json
    ├── 输入材料/               # ← 放置补充材料
    ├── 工作底稿/
    ├── 最终报告/
    └── 计算文件/
```

#### Step 4: 放置补充材料

```bash
# 将补充材料复制到round_2/输入材料/
cp 新增生效判决书.pdf 输出/第1批债权/115-债权人名称/round_2/输入材料/
cp 补充银行流水.pdf 输出/第1批债权/115-债权人名称/round_2/输入材料/
```

#### Step 5: 准备Agent调用配置

```bash
python src/multi_round_controller.py process-round \
    --batch 1 \
    --number 115 \
    --name "债权人名称" \
    --round 2 \
    --mode full
```

**输出**:

```json
{
  "success": true,
  "stages_prepared": [
    {
      "stage": 1,
      "agent_call_required": true,
      "agent_config": {
        "subagent_type": "debt-fact-checker",
        "paths": {
          "input_materials": "输出/第1批债权/115-债权人名称/round_2/输入材料",
          "work_papers": "输出/第1批债权/115-债权人名称/round_2/工作底稿"
        },
        "bankruptcy_info": {
          "bankruptcy_date": "2024-12-31",
          "interest_stop_date": "2024-12-30"
        }
      }
    }
  ],
  "message": "所有Stage配置已准备完成，请在Claude Code CLI中调用对应Agents"
}
```

#### Step 6: 在Claude Code CLI中调用Agents

**在Claude Code CLI会话中**（而非Python脚本中）：

```
# Stage 1: 调用事实核查Agent
我需要处理Round 2的事实核查。补充材料位于：
输出/第1批债权/115-债权人名称/round_2/输入材料/

请使用debt-fact-checker Agent处理，配置如下：
- 破产日期：2024-12-31
- 停止计息日：2024-12-30
- 输出报告到：round_2/工作底稿/
```

Claude Code会自动使用Task工具调用debt-fact-checker Agent。

```
# Stage 2: 调用债权分析Agent
事实核查完成后，请使用debt-claim-analyzer Agent进行债权分析。
输入：round_2/工作底稿/事实核查报告_round2.md
输出：round_2/工作底稿/债权分析报告_round2.md, round_2/计算文件/
```

```
# Stage 3: 调用报告整理Agent
债权分析完成后，请使用report-organizer Agent整理最终报告。
输入：round_2/工作底稿/ 中的两个技术报告
输出：round_2/最终报告/GY2025_审查报告_round2_YYYYMMDD.md
```

---

## 命令行工具使用

### 完整命令参考

#### 1. analyze - 分析补充材料影响

```bash
python src/multi_round_controller.py analyze \
    --batch <批次号> \
    --number <债权人编号> \
    --name "<债权人名称>" \
    --supplemental <补充材料配置文件路径>
```

**示例**:
```bash
python src/multi_round_controller.py analyze \
    --batch 1 --number 115 --name "慈溪市东航建筑" \
    --supplemental supplemental.json
```

#### 2. init-round - 初始化新轮次

```bash
python src/multi_round_controller.py init-round \
    --batch <批次号> \
    --number <债权人编号> \
    --name "<债权人名称>" \
    --round <轮次号>
```

**示例**:
```bash
python src/multi_round_controller.py init-round \
    --batch 1 --number 115 --name "慈溪市东航建筑" \
    --round 2
```

#### 3. process-round - 准备轮次处理配置

```bash
python src/multi_round_controller.py process-round \
    --batch <批次号> \
    --number <债权人编号> \
    --name "<债权人名称>" \
    --round <轮次号> \
    --mode <full|incremental|partial>
```

**模式说明**:
- `full`: 完整重审（0%节省，适用CRITICAL字段变更）
- `incremental`: 增量处理（60-75%节省，适用HIGH/MEDIUM字段变更）
- `partial`: 最小更新（85%+节省，适用LOW字段变更）

**示例**:
```bash
python src/multi_round_controller.py process-round \
    --batch 1 --number 115 --name "慈溪市东航建筑" \
    --round 2 --mode full
```

#### 4. show-history - 显示轮次历史

```bash
python src/multi_round_controller.py show-history \
    --batch <批次号> \
    --number <债权人编号> \
    --name "<债权人名称>"
```

**输出示例**:
```json
{
  "success": true,
  "current_round": 2,
  "total_rounds": 2,
  "rounds": [
    {
      "round_number": 1,
      "created_at": "2025-11-01T10:00:00",
      "status": "completed",
      "processing_mode": "full",
      "is_current": false
    },
    {
      "round_number": 2,
      "created_at": "2025-11-12T14:30:00",
      "status": "processing",
      "processing_mode": "incremental",
      "is_current": true
    }
  ]
}
```

#### 5. rollback - 回滚到指定轮次

```bash
python src/multi_round_controller.py rollback \
    --batch <批次号> \
    --number <债权人编号> \
    --name "<债权人名称>" \
    --target-round <目标轮次号>
```

**警告**: ⚠️ 回滚会**永久删除**目标轮次之后的所有轮次！请谨慎使用。

**示例**:
```bash
python src/multi_round_controller.py rollback \
    --batch 1 --number 115 --name "慈溪市东航建筑" \
    --target-round 1
```

#### 6. test - 运行自检测试

```bash
python src/multi_round_controller.py test
```

---

## 与Claude Code CLI集成

### 关键理解

**multi_round_controller.py的职责**:
- ✅ 轮次结构管理（创建、迁移、回滚）
- ✅ 影响分析决策
- ✅ 配置文件生成
- ✅ 元数据跟踪

**multi_round_controller.py不负责**:
- ❌ 实际调用Agents（这是Claude Code CLI通过Task工具完成的）
- ❌ 材料内容分析（这是Agents的工作）
- ❌ 报告生成（这是Agents的工作）

### 集成流程

```
┌──────────────────────────────────────────────────────────┐
│ 用户在Claude Code CLI中输入指令                            │
└──────────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────────┐
│ Claude Code调用multi_round_controller.py准备配置           │
│ $ python src/multi_round_controller.py process-round ... │
└──────────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────────┐
│ multi_round_controller返回Agent调用所需配置                │
│ {                                                         │
│   "agent_config": {                                       │
│     "subagent_type": "debt-fact-checker",                │
│     "paths": {...},                                       │
│     "bankruptcy_info": {...}                             │
│   }                                                       │
│ }                                                         │
└──────────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────────┐
│ Claude Code使用Task工具调用对应Agent                       │
│ Task(                                                     │
│   subagent_type="debt-fact-checker",                     │
│   prompt="使用以下配置处理Round 2事实核查...",             │
│   ...                                                     │
│ )                                                         │
└──────────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────────┐
│ Agent执行任务，生成报告                                     │
│ → round_2/工作底稿/事实核查报告_round2.md                  │
└──────────────────────────────────────────────────────────┘
```

---

## 常见场景示例

### 场景A: 补充生效法律文书（HIGH优先级）

**背景**: 债权人补充提供判决书，原来只有合同和银行流水。

**操作**:

```bash
# 1. 准备补充材料配置
cat > supplemental.json <<EOF
{
  "judgment_document": "（2024）浙02民初123号民事判决书.pdf",
  "notes": "债权人补充提供生效判决书"
}
EOF

# 2. 分析影响
python src/multi_round_controller.py analyze \
    --batch 1 --number 115 --name "债权人名称" \
    --supplemental supplemental.json

# 预期结果：Incremental模式，影响Stage 1+2+3，节省65%时间

# 3. 初始化Round 2
python src/multi_round_controller.py init-round \
    --batch 1 --number 115 --name "债权人名称" --round 2

# 4. 放置补充材料
cp （2024）浙02民初123号民事判决书.pdf \
   输出/第1批债权/115-债权人名称/round_2/输入材料/

# 5. 在Claude Code CLI中调用Agents
# （见"Step 6: 在Claude Code CLI中调用Agents"）
```

### 场景B: 修正破产日期（CRITICAL优先级）

**背景**: 发现破产受理日期错误，需要重新审查。

**操作**:

```bash
# 1. 准备补充材料配置
cat > supplemental.json <<EOF
{
  "bankruptcy_date": "2024-12-30",
  "interest_stop_date": "2024-12-29",
  "notes": "更正破产受理日期（原为2024-12-31）"
}
EOF

# 2. 分析影响
python src/multi_round_controller.py analyze \
    --batch 1 --number 115 --name "债权人名称" \
    --supplemental supplemental.json

# 预期结果：Full模式，影响ALL，0%节省（必须完整重审）

# 3. 初始化Round 2
python src/multi_round_controller.py init-round \
    --batch 1 --number 115 --name "债权人名称" --round 2

# 4. 处理Full模式
python src/multi_round_controller.py process-round \
    --batch 1 --number 115 --name "债权人名称" \
    --round 2 --mode full
```

### 场景C: 更新联系方式（LOW优先级）

**背景**: 债权人联系电话变更。

**操作**:

```bash
# 1. 准备补充材料配置
cat > supplemental.json <<EOF
{
  "creditor_contact": "138****9999",
  "notes": "债权人联系方式变更"
}
EOF

# 2. 分析影响
python src/multi_round_controller.py analyze \
    --batch 1 --number 115 --name "债权人名称" \
    --supplemental supplemental.json

# 预期结果：Partial模式，仅影响报告抬头，节省90%时间

# 3. 初始化Round 2（可选，也可手动编辑Round 1报告）
# （对于仅修改联系方式这类LOW优先级变更，可能不需要新轮次）
```

### 场景D: 回滚错误轮次

**背景**: Round 2处理出错，需要回滚重新开始。

**操作**:

```bash
# 1. 查看历史
python src/multi_round_controller.py show-history \
    --batch 1 --number 115 --name "债权人名称"

# 输出显示：current_round=2, total_rounds=2

# 2. 回滚到Round 1
python src/multi_round_controller.py rollback \
    --batch 1 --number 115 --name "债权人名称" \
    --target-round 1

# 3. 验证回滚
python src/multi_round_controller.py show-history \
    --batch 1 --number 115 --name "债权人名称"

# 输出显示：current_round=1, total_rounds=1

# 4. 重新初始化Round 2
python src/multi_round_controller.py init-round \
    --batch 1 --number 115 --name "债权人名称" --round 2
```

---

## 故障排查

### 问题1: 命令找不到文件

**症状**:
```
FileNotFoundError: [Errno 2] No such file or directory: 'src/impact_analyzer.py'
```

**原因**: 不在项目根目录下执行命令。

**解决**:
```bash
cd /root/debt_review_skills
python src/multi_round_controller.py test
```

### 问题2: 轮次初始化失败

**症状**:
```json
{
  "success": false,
  "message": "轮次 2 已存在"
}
```

**原因**: 尝试初始化已存在的轮次。

**解决**:
```bash
# 选项1: 使用已存在的轮次
# （如果round_2已存在且可用，直接使用）

# 选项2: 删除现有轮次后重新初始化
rm -rf 输出/第1批债权/115-债权人名称/round_2
python src/multi_round_controller.py init-round ...

# 选项3: 初始化更高轮次号
python src/multi_round_controller.py init-round ... --round 3
```

### 问题3: Agent调用配置准备失败

**症状**:
```json
{
  "success": false,
  "message": "前置条件未满足：事实核查报告不存在"
}
```

**原因**: Stage 2依赖Stage 1的输出，但Stage 1尚未完成。

**解决**:
```bash
# 1. 确认Stage 1已完成
ls 输出/第1批债权/115-债权人名称/round_2/工作底稿/
# 应该看到：事实核查报告_round2.md

# 2. 如果Stage 1未完成，先调用debt-fact-checker Agent完成Stage 1
# （在Claude Code CLI中）
```

### 问题4: 破产日期读取错误

**症状**: 生成的配置中破产日期是默认值 "2024-12-31"。

**原因**: `project_config.ini` 文件不存在或格式错误。

**解决**:
```bash
# 1. 检查project_config.ini
cat project_config.ini

# 2. 确认格式正确
# [project]
# bankruptcy_date = 2024-12-31
# interest_stop_date = 2024-12-30

# 3. 如果文件不存在，创建它
cat > project_config.ini <<EOF
[project]
bankruptcy_date = 2024-12-31
interest_stop_date = 2024-12-30
project_name = XX公司破产管理人债权审查项目
EOF
```

### 问题5: 回滚操作失败

**症状**:
```json
{
  "success": false,
  "message": "目标轮次 2 必须小于当前轮次 2"
}
```

**原因**: 尝试回滚到当前轮次或更高轮次。

**解决**:
```bash
# 回滚只能回退到**过去**的轮次
# 例如：current_round=3时，只能回滚到1或2

# 查看当前轮次
python src/multi_round_controller.py show-history ...

# 回滚到正确的目标轮次（必须 < current_round）
python src/multi_round_controller.py rollback ... --target-round 1
```

---

## 附录A: 字段优先级速查表

| 优先级 | 字段数量 | 典型字段 | 触发模式 | 时间节省 |
|--------|----------|----------|----------|----------|
| **CRITICAL** | 5 | 破产日期、停止计息日、法律关系类型 | Full | 0% |
| **HIGH** | 6 | 生效判决、履行证据、担保类型 | Incremental | 60-75% |
| **MEDIUM** | 5 | 合同日期、付款期限、申报金额 | Incremental | 60-75% |
| **LOW** | 3 | 联系方式、项目描述、备注 | Partial | 85%+ |

**完整列表**: 见 `config/field_priorities.py`

---

## 附录B: 影响范围映射速查表

| 字段 | 受影响Stages | 受影响债权项 | 受影响章节 |
|------|--------------|--------------|------------|
| `bankruptcy_date` | 1,2,3 | ALL | ALL |
| `judgment_document` | 1,2,3 | ALL | 2,3,4,5 |
| `interest_rate_clause` | 2,3 | 利息、复利、逾期利息 | 3,4 |
| `creditor_contact` | 3 | - | 1 |

**完整映射**: 见 `config/impact_mappings.py`

---

## 附录C: 轮次目录结构

```
输出/第X批债权/[编号]-[债权人名称]/
│
├── .current_round.json              # 当前轮次指针
│   {
│     "current_round": 2,
│     "total_rounds": 2,
│     "latest_report_path": "round_2/最终报告/...",
│     "last_updated": "2025-11-12T14:30:00"
│   }
│
├── round_1/                         # 第一轮（基础轮）
│   ├── .round_metadata.json         # 轮次元数据
│   │   {
│   │     "round_number": 1,
│   │     "status": "completed",
│   │     "processing_mode": "full",
│   │     "created_at": "2025-11-01T10:00:00"
│   │   }
│   ├── 输入材料/
│   ├── 工作底稿/
│   │   ├── 事实核查报告_round1.md
│   │   └── 债权分析报告_round1.md
│   ├── 计算文件/
│   │   └── 利息计算_round1.xlsx
│   └── 最终报告/
│       └── GY2025_审查报告_round1_20251101.md
│
└── round_2/                         # 第二轮（补充轮）
    ├── .round_metadata.json
    │   {
    │     "round_number": 2,
    │     "status": "processing",
    │     "processing_mode": "incremental",
    │     "parent_round": 1,
    │     "trigger_reason": "补充生效法律文书"
    │   }
    ├── 输入材料/                    # ← 放置补充材料
    │   └── 新增判决书.pdf
    ├── 工作底稿/
    ├── 计算文件/
    └── 最终报告/
```

---

## 支持与反馈

**文档版本**: v3.0 MVP
**实施状态**: Week 2 完成 - Full模式已实现
**下一步**: Week 3 - Agent增量处理改造

**技术支持**:
- 技术设计文档: `MULTI_ROUND_TECHNICAL_DESIGN.md`
- 实施经验参考: `MULTI_ROUND_EXPERIENCE.md` (DPIA系统)
- 问题反馈: 项目Issue跟踪系统

**重要提醒**:
- ⚠️ 当前版本仅实现Full模式，Incremental和Partial模式将在Week 4-5实现
- ⚠️ Agent增量处理能力将在Week 3改造
- ⚠️ 回滚和历史功能基础框架已完成，高级功能将在Week 6完善

---

**最后更新**: 2025-11-12
**文档作者**: Multi-Round System Implementation Team
