# 多轮债权审查系统 - 用户操作手册

**版本**: v2.0
**最后更新**: 2025-11-12
**系统状态**: 生产就绪

---

## 目录

1. [系统概述](#系统概述)
2. [快速开始](#快速开始)
3. [核心概念](#核心概念)
4. [工作流程](#工作流程)
5. [CLI命令参考](#cli命令参考)
6. [功能详解](#功能详解)
7. [最佳实践](#最佳实践)
8. [故障排除](#故障排除)
9. [附录](#附录)

---

## 系统概述

### 什么是多轮债权审查系统？

多轮债权审查系统是一个智能化的债权审查管理工具，支持债权从首次处理到多次补充修订的完整生命周期管理。系统通过**增量处理技术**，在补充材料时可节省40-85%的处理时间，同时保持完整的审计追踪。

### 核心特性

**🚀 增量处理引擎**
- **Full模式**: 完整处理（首次审查或关键字段变更）
- **Incremental模式**: 章节级增量（补充证据材料，节省40-75%时间）
- **Partial模式**: 字段级增量（调整备注说明，节省85%+时间）

**📊 智能影响分析**
- 自动识别字段优先级（CRITICAL/HIGH/MEDIUM/LOW）
- 自动计算受影响的审查阶段和章节
- 自动推荐最优处理模式

**🔄 完整历史管理**
- 轮次隔离存储，互不干扰
- 安全回滚机制（数据保留用于审计）
- 完整变更日志（Changelog）自动记录
- 父子关系追溯

**⚡ 批量处理优化**
- 批量状态查询
- 批量轮次初始化
- 批量影响分析
- 选择性过滤处理

**📝 辅助工具**
- 自动生成补充材料清单
- 格式化历史查看
- Changelog摘要导出

### 技术架构

```
┌─────────────────────────────────────────────────────┐
│              MultiRoundController                   │
│          （多轮工作流总控制器）                       │
└───────────┬─────────────────────────────────────────┘
            │
            ├─► RoundManager (轮次管理器)
            │   ├─ 轮次初始化
            │   ├─ 状态管理
            │   ├─ 历史查看
            │   ├─ 回滚控制
            │   └─ Changelog管理
            │
            ├─► ImpactAnalyzer (影响分析器)
            │   ├─ 字段优先级识别
            │   ├─ 影响范围计算
            │   ├─ 处理模式推荐
            │   └─ 时间节省预估
            │
            └─► 配置系统
                ├─ field_priorities.py (字段优先级)
                └─ impact_mappings.py (影响映射表)
```

### 系统要求

- **Python**: 3.8+
- **操作系统**: Linux/macOS/Windows
- **磁盘空间**: 每个债权人约10-50MB（取决于材料量）
- **依赖**: 无外部依赖（纯Python标准库）

---

## 快速开始

### 安装

系统已经安装在项目目录中，无需额外安装步骤。

```bash
cd /root/debt_review_skills
```

### 第一次使用

**场景**: 您有一个新债权人需要审查

```bash
# 步骤1: 准备原始材料
# 将债权人材料放入: 输入/第1批债权/

# 步骤2: 初始化债权人环境
python src/multi_round_controller.py init-round \
  --batch 1 \
  --number 100 \
  --name "某某公司" \
  --round 1

# 系统会自动创建标准目录结构：
# 输出/第1批债权/100-某某公司/
#   ├── .current_round.json          (当前轮次追踪)
#   ├── .changelog.json              (变更日志)
#   ├── round_1/                     (第1轮处理)
#   │   ├── .round_metadata.json     (轮次元数据)
#   │   ├── 工作底稿/                 (技术报告)
#   │   ├── 最终报告/                 (客户交付)
#   │   └── 计算文件/                 (计算过程)
#   └── 并行处理prompts/             (审计追踪)

# 步骤3: 进行债权审查
# 使用三个Agent依次处理：
# - debt-fact-checker (事实核查)
# - debt-claim-analyzer (债权分析)
# - report-organizer (报告整理)

# 步骤4: 完成后标记状态
# (通常由Agent自动完成)
```

### 补充材料处理

**场景**: 债权人补充了新的判决文书

```bash
# 步骤1: 分析影响
python src/multi_round_controller.py analyze \
  --batch 1 \
  --number 100 \
  --name "某某公司" \
  --file "补充材料/100-某某公司_supplemental.json"

# 输出示例：
# 影响分析结果:
#   处理模式: incremental
#   受影响阶段: [1, 2, 3]
#   受影响章节: [1, 2, 3]
#   预计节省时间: 60%
#   字段更新: judgment_document

# 步骤2: 初始化新轮次
python src/multi_round_controller.py init-round \
  --batch 1 \
  --number 100 \
  --name "某某公司" \
  --round 2

# 系统会自动：
# - 创建round_2/目录
# - 继承round_1的上下文
# - 设置增量处理模式
# - 记录到Changelog

# 步骤3: 进行增量处理
# 使用三个Agent进行增量处理（自动跳过无关部分）

# 步骤4: 生成补充清单（可选）
python src/multi_round_controller.py generate-checklist \
  --batch 1 \
  --number 100 \
  --name "某某公司" \
  --round 2

# 生成: round_2_supplemental_checklist.md
```

### 查看历史

```bash
# 查看轮次历史
python src/multi_round_controller.py show-history \
  --batch 1 \
  --number 100 \
  --name "某某公司"

# 查看变更日志
python src/multi_round_controller.py show-changelog \
  --batch 1 \
  --number 100 \
  --name "某某公司"
```

---

## 核心概念

### 1. 轮次（Round）

**定义**: 一次完整的债权审查处理过程，从输入材料到输出最终报告。

**特征**:
- 每个轮次有独立的目录和元数据
- 轮次之间互不干扰，数据完全隔离
- 每个轮次有明确的父子关系（除Round 1外）
- 轮次有5种状态：initialized, processing, completed, failed, rolled_back

**目录结构**:
```
round_N/
├── .round_metadata.json      # 元数据（模式、状态、触发原因等）
├── 工作底稿/                  # 技术报告
│   ├── {债权人}_事实核查报告.md
│   └── {债权人}_债权分析报告.md
├── 最终报告/                  # 客户交付
│   └── GY2025_{债权人}_债权审查报告_{日期}.md
└── 计算文件/                  # 计算过程
    └── {债权人}_{类型}.xlsx
```

### 2. 处理模式（Processing Mode）

**Full模式（完整处理）**
- **触发条件**:
  - 首次处理（Round 1）
  - CRITICAL字段变更（破产日期、法律关系类型等）
  - 未知字段变更（保守策略）
- **处理范围**: 全部3个Stage，全部6个章节
- **时间节省**: 0%（基准）
- **适用场景**: 基础信息建立、关键信息变更

**Incremental模式（章节级增量）**
- **触发条件**:
  - HIGH字段变更（判决文书、担保方式等）
  - MEDIUM字段变更（付款期限、利率条款等）
- **处理范围**: 受影响的Stage和章节
- **时间节省**: 40-75%
- **适用场景**: 补充证据材料、合同条款变更

**Partial模式（字段级增量）**
- **触发条件**:
  - LOW字段变更（备注说明、联系方式等）
- **处理范围**: 特定字段所在的章节
- **时间节省**: 85%+
- **适用场景**: 微调备注、更新联系信息

### 3. 字段优先级

系统将所有配置字段分为4个优先级：

**CRITICAL（关键字段）** - 5个
- `bankruptcy_date` (破产受理日期)
- `interest_stop_date` (停止计息日期)
- `legal_relationship_type` (法律关系类型)
- `debt_nature` (债权性质)
- `statute_of_limitations_status` (诉讼时效状态)

**HIGH（高优先级）** - 7个
- `judgment_document` (生效法律文书)
- `guarantee_type` (担保方式)
- `principal_confirmation_evidence` (本金确认证据)
- 等

**MEDIUM（中优先级）** - 17个
- `payment_deadline` (付款期限)
- `interest_rate_clause` (利率约定)
- `liquidated_damages_clause` (违约金条款)
- 等

**LOW（低优先级）** - 9个
- `notes` (备注说明)
- `creditor_contact` (债权人联系方式)
- `agent_info` (代理人信息)
- 等

详细列表见: `config/field_priorities.py`

### 4. 影响分析

**目的**: 确定字段变更对审查流程的影响范围

**分析维度**:
1. **优先级识别**: 识别最高优先级字段
2. **Stage影响**: 确定受影响的审查阶段（Stage 1/2/3）
3. **章节影响**: 确定受影响的报告章节（1-6章）
4. **债权项影响**: 确定受影响的债权项（本金/利息/违约金等）
5. **模式推荐**: 推荐最优处理模式
6. **时间预估**: 预估可节省的处理时间

**保守策略**:
- 未知字段 → Full模式（确保准确性）
- MEDIUM字段 → Incremental而非Partial（降低风险）
- 混合优先级 → 采用最高优先级（就高原则）

### 5. Changelog（变更日志）

**文件**: `.changelog.json`

**内容**:
```json
{
  "creditor_info": {
    "batch_number": 1,
    "creditor_number": 100,
    "creditor_name": "某某公司"
  },
  "changelog": [
    {
      "round_number": 1,
      "timestamp": "2025-11-12T10:00:00",
      "action": "初始化",
      "processing_mode": "full",
      "trigger_reason": "首次处理",
      "status": "completed"
    },
    {
      "round_number": 2,
      "timestamp": "2025-11-12T14:30:00",
      "action": "完成",
      "processing_mode": "incremental",
      "trigger_reason": "补充判决文书",
      "fields_updated": ["judgment_document"],
      "impact_analysis": {
        "affected_stages": [1, 2, 3],
        "time_savings_percent": 60
      },
      "status": "completed"
    }
  ]
}
```

**用途**:
- 审计追踪
- 历史查看
- 问题排查
- 统计分析

---

## 工作流程

### 标准三阶段流程

```
┌──────────────────────────────────────────────────────┐
│  Stage 0: 环境初始化（自动）                          │
│  - 创建标准目录结构                                   │
│  - 生成配置文件                                       │
│  - 初始化Changelog                                   │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│  Stage 1: 事实核查（debt-fact-checker Agent）        │
│  - 提取申报信息                                       │
│  - 整理证据材料                                       │
│  - 建立法律关系                                       │
│  - 创建时间线                                         │
│  输出: {债权人}_事实核查报告.md                       │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│  Stage 2: 债权分析（debt-claim-analyzer Agent）      │
│  - 债权项金额分解                                     │
│  - 利息精确计算                                       │
│  - 诉讼时效判定                                       │
│  - 质量控制检查                                       │
│  输出: {债权人}_债权分析报告.md + 计算文件            │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│  Stage 3: 报告整理（report-organizer Agent）         │
│  - 整合技术报告                                       │
│  - 应用客户模板                                       │
│  - 标准化格式                                         │
│  - 生成文件清单                                       │
│  输出: GY2025_{债权人}_债权审查报告_{日期}.md        │
└──────────────────────────────────────────────────────┘
```

### 增量处理流程（Incremental/Partial）

**前提**: 已完成至少一轮Full处理

```
1. 准备补充材料
   └─ 创建 {编号}-{债权人}_supplemental.json

2. 影响分析
   └─ analyze命令 → 确定处理模式和影响范围

3. 初始化新轮次
   └─ init-round命令 → 创建round_N/目录

4. 增量处理
   ├─ Stage 1: 如果受影响 → 增量事实核查
   ├─ Stage 2: 如果受影响 → 增量债权分析
   └─ Stage 3: 章节级或字段级更新

5. 验证和交付
   └─ 检查历史、Changelog、补充清单
```

### 批量处理流程（多债权人）

**单批次多债权人场景**:

```bash
# 方案1: 串行处理（债权人数=1）
for 债权人 in 批次:
    初始化 → Stage1 → Stage2 → Stage3 → 完成

# 方案2: 阶段级并行（债权人数≥2，推荐）
初始化所有债权人（串行）
  ↓
Stage1: 并行处理所有债权人
  ↓ 质量检查点
Stage2: 并行处理所有债权人
  ↓ 质量检查点
Stage3: 并行处理所有债权人
  ↓ 最终验证
完成

# 预计时间节省: 75-80%
```

**批量操作命令**:
```bash
# 批量状态查询
python src/multi_round_controller.py batch-status --batch 1

# 批量初始化（全部债权人）
python src/multi_round_controller.py batch-init \
  --batch 1 --round 2

# 批量初始化（过滤）
python src/multi_round_controller.py batch-init \
  --batch 1 --round 2 --filter 100,102,105

# 批量影响分析
python src/multi_round_controller.py batch-analyze \
  --batch 1 --supplemental-dir "补充材料/"
```

---

## CLI命令参考

### 基础命令

#### `init-round` - 初始化新轮次

**用途**: 为债权人创建新的处理轮次

**语法**:
```bash
python src/multi_round_controller.py init-round \
  --batch <批次号> \
  --number <债权人编号> \
  --name <债权人名称> \
  --round <轮次号>
```

**参数**:
- `--batch`: 批次号（整数，必填）
- `--number`: 债权人编号（整数，必填）
- `--name`: 债权人名称（字符串，必填）
- `--round`: 轮次号（整数，必填）

**示例**:
```bash
# 初始化Round 1（首次处理）
python src/multi_round_controller.py init-round \
  --batch 1 --number 100 --name "测试公司" --round 1

# 初始化Round 2（补充处理）
python src/multi_round_controller.py init-round \
  --batch 1 --number 100 --name "测试公司" --round 2
```

**输出**:
```
✓ 初始化轮次 2: /root/debt_review_skills/输出/第1批债权/100-测试公司/round_2
{
  "success": true,
  "round_number": 2,
  "processing_mode": "incremental",
  "message": "轮次2初始化成功"
}
```

#### `analyze` - 分析补充材料影响

**用途**: 分析补充材料对处理流程的影响

**语法**:
```bash
python src/multi_round_controller.py analyze \
  --batch <批次号> \
  --number <债权人编号> \
  --name <债权人名称> \
  --file <补充材料文件>
```

**补充材料文件格式** (`supplemental.json`):
```json
{
  "judgment_document": "新的判决文书内容",
  "performance_evidence": "新的履行证据",
  "notes": "备注更新"
}
```

**示例**:
```bash
python src/multi_round_controller.py analyze \
  --batch 1 \
  --number 100 \
  --name "测试公司" \
  --file "补充材料/100-测试公司_supplemental.json"
```

**输出**:
```
影响分析结果:
  最高优先级: HIGH
  处理模式: incremental
  受影响阶段: [1, 2, 3]
  受影响章节: [1, 2, 3]
  受影响债权项: 本金, 利息, 违约金
  预计节省时间: 60%
  字段更新: judgment_document, performance_evidence
```

### 历史和状态命令

#### `show-history` - 显示轮次历史

**用途**: 查看债权人的完整处理历史

**语法**:
```bash
python src/multi_round_controller.py show-history \
  --batch <批次号> \
  --number <债权人编号> \
  --name <债权人名称>
```

**示例**:
```bash
python src/multi_round_controller.py show-history \
  --batch 1 --number 100 --name "测试公司"
```

**输出**:
```
================================================================================
轮次历史
================================================================================
当前轮次: Round 3
总轮次数: 3
--------------------------------------------------------------------------------

Round 1: completed
  处理模式: full
  创建时间: 2025-11-12T10:00:00
  触发原因: 首次处理

Round 2: completed
  处理模式: incremental
  创建时间: 2025-11-12T14:30:00
  父轮次: Round 1
  触发原因: 补充判决文书
  变更字段: judgment_document
  时间节省: 60%

Round 3: completed ← 当前
  处理模式: partial
  创建时间: 2025-11-12T16:00:00
  父轮次: Round 2
  触发原因: 调整备注
  变更字段: notes
  时间节省: 85%
```

#### `show-changelog` - 显示变更日志

**用途**: 查看Changelog的格式化摘要

**语法**:
```bash
python src/multi_round_controller.py show-changelog \
  --batch <批次号> \
  --number <债权人编号> \
  --name <债权人名称>
```

#### `generate-checklist` - 生成补充清单

**用途**: 根据影响分析生成补充材料清单

**语法**:
```bash
python src/multi_round_controller.py generate-checklist \
  --batch <批次号> \
  --number <债权人编号> \
  --name <债权人名称> \
  --round <轮次号>
```

**输出**: `round_N_supplemental_checklist.md`

**清单示例**:
```markdown
# 补充材料清单 - Round 2

**生成时间**: 2025-11-12 14:30:00
**触发原因**: 补充判决文书
**处理模式**: incremental

---

## 补充材料清单概览

本轮次需要补充 **2** 个字段的相关材料。

### 🟠 高优先级字段

#### 1. 生效法律文书

**字段名称**: `judgment_document`

**说明**: 对债权确认有直接影响的法律文书（判决、调解、仲裁等）

**所需材料**:
- [ ] 判决书/调解书/仲裁裁决书正本
- [ ] 生效证明文件
- [ ] 送达回证

---

### 🟡 中优先级字段

#### 1. 履行证据

**字段名称**: `performance_evidence`

**说明**: 证明合同履行情况的证据材料

**所需材料**:
- [ ] 发货单/送货单
- [ ] 签收凭证
- [ ] 履行确认函

---

## 处理建议

### 优先级说明

- **🔴 关键字段**: 影响所有债权项和章节，必须优先补充
- **🟠 高优先级**: 影响多个章节，建议尽快补充
- **🟡 中优先级**: 影响特定章节，根据重要性补充
- **🟢 低优先级**: 影响较小，可最后补充

### 下一步操作

1. 根据清单收集所需补充材料
2. 整理材料文件放入补充材料目录
3. 使用影响分析功能评估补充材料的影响范围
4. 初始化新轮次进行增量处理
```

### 回滚命令

#### `rollback` - 回滚到指定轮次

**用途**: 撤销后续轮次，恢复到指定轮次（数据保留用于审计）

**语法**:
```bash
python src/multi_round_controller.py rollback \
  --batch <批次号> \
  --number <债权人编号> \
  --name <债权人名称> \
  --target-round <目标轮次> \
  [--reason <回滚原因>]
```

**限制**:
- 目标轮次必须 < 当前轮次
- 目标轮次必须存在
- 目标轮次不能是已回滚状态

**示例**:
```bash
python src/multi_round_controller.py rollback \
  --batch 1 \
  --number 100 \
  --name "测试公司" \
  --target-round 2 \
  --reason "发现Round 3数据有误"
```

**效果**:
- 当前轮次变为Round 2
- Round 3及后续轮次标记为`rolled_back`
- 所有目录和文件保留（审计需求）
- Changelog记录回滚操作

### 批量命令

#### `batch-status` - 查询批次状态

**用途**: 查看批次内所有债权人的处理状态

**语法**:
```bash
python src/multi_round_controller.py batch-status --batch <批次号>
```

**示例**:
```bash
python src/multi_round_controller.py batch-status --batch 1
```

**输出**:
```
================================================================================
第1批债权状态
================================================================================
债权人数量: 5
--------------------------------------------------------------------------------

100-公司A
  当前轮次: Round 2
  总轮次数: 2
  轮次详情:
    Round 1: completed (full)
    Round 2: completed (incremental) ← 当前

101-公司B
  当前轮次: Round 1
  总轮次数: 1
  轮次详情:
    Round 1: completed (full) ← 当前

...
```

#### `batch-init` - 批量初始化轮次

**用途**: 为批次内所有（或部分）债权人初始化新轮次

**语法**:
```bash
python src/multi_round_controller.py batch-init \
  --batch <批次号> \
  --round <轮次号> \
  [--filter <债权人编号列表>]
```

**参数**:
- `--filter`: 可选，逗号分隔的债权人编号（如: `100,102,105`）

**示例**:
```bash
# 为所有债权人初始化Round 2
python src/multi_round_controller.py batch-init --batch 1 --round 2

# 仅为指定债权人初始化Round 2
python src/multi_round_controller.py batch-init \
  --batch 1 --round 2 --filter 100,102,105
```

**输出**:
```
================================================================================
批量初始化 Round 2 - 第1批债权
================================================================================
处理债权人数: 3
--------------------------------------------------------------------------------

处理: 100-公司A
  ✅ 初始化成功

处理: 102-公司C
  ✅ 初始化成功

处理: 105-公司F
  ✅ 初始化成功

================================================================================
批量初始化完成
  成功: 3
  失败: 0
================================================================================
```

#### `batch-analyze` - 批量影响分析

**用途**: 批量分析多个债权人的补充材料影响

**语法**:
```bash
python src/multi_round_controller.py batch-analyze \
  --batch <批次号> \
  --supplemental-dir <补充材料目录> \
  [--filter <债权人编号列表>]
```

**补充材料目录结构**:
```
补充材料/
├── 100-公司A_supplemental.json
├── 102-公司C_supplemental.json
└── 105-公司F_supplemental.json
```

**示例**:
```bash
python src/multi_round_controller.py batch-analyze \
  --batch 1 \
  --supplemental-dir "补充材料/"
```

---

## 功能详解

### 1. 影响分析算法

**目标**: 确定最优处理策略，最大化时间节省，最小化风险

**分析步骤**:

1. **字段识别**
   ```python
   输入: ["judgment_document", "notes"]
   识别: judgment_document → HIGH, notes → LOW
   最高优先级: HIGH
   ```

2. **优先级判定**
   ```python
   if 最高优先级 == CRITICAL:
       模式 = Full (0%节省)
   elif 最高优先级 == HIGH:
       模式 = Incremental (40-75%节省)
   elif 最高优先级 == MEDIUM:
       模式 = Incremental (60-75%节省)  # 保守策略
   else:  # LOW
       模式 = Partial (85%+节省)
   ```

3. **影响范围计算**
   ```python
   # 基于影响映射表
   judgment_document → 影响Stage [1,2,3], 章节[1,2,3]
   notes → 影响Stage [3], 章节[6]

   # 合并
   受影响Stage = [1,2,3]
   受影响章节 = [1,2,3,6]
   ```

4. **时间节省预估**
   ```python
   if 模式 == Full:
       节省 = 0%
   elif 模式 == Incremental:
       跳过Stage = 3 - len(受影响Stage)
       基础节省 = (跳过Stage / 3) * 100
       # 如果所有Stage都受影响，Stage内部增量也能节省
       if 基础节省 == 0:
           基础节省 = 50
       # 根据字段数量微调
       节省 = max(40, min(75, 基础节省 + 调整))
   else:  # Partial
       节省 = 85
   ```

**保守策略**:
- 未知字段 → 触发Full（确保准确性）
- MEDIUM字段 → 使用Incremental而非Partial（降低风险）
- 混合优先级 → 采用最高优先级（就高原则）

### 2. 轮次状态机

```
┌─────────────┐
│ initialized │ ─────┐
└─────────────┘      │
       │             │
       v             v
┌─────────────┐  ┌────────┐
│ processing  │  │ failed │
└─────────────┘  └────────┘
       │
       v
┌─────────────┐
│ completed   │ ──────┐
└─────────────┘       │
                      │ rollback
                      v
               ┌──────────────┐
               │ rolled_back  │
               └──────────────┘
```

**状态转换规则**:
- `initialized` → `processing`: 开始处理
- `processing` → `completed`: 处理成功
- `processing` → `failed`: 处理失败
- `completed` → `rolled_back`: 回滚操作
- `rolled_back`: 终态（不可恢复）

### 3. 回滚机制

**设计原则**: 安全回滚 + 完整审计

**回滚步骤**:
1. 验证目标轮次（必须存在、未回滚、小于当前轮次）
2. 标记后续轮次为`rolled_back`（不删除数据）
3. 更新当前轮次指针
4. 记录回滚操作到Changelog
5. 保留所有文件和目录（审计需求）

**回滚后**:
- 可以重新初始化新轮次
- 已回滚轮次仍可查看（`show-history --include-rolled-back`）
- Changelog完整记录回滚操作
- 所有文件保留在原位置

**示例**:
```bash
# 回滚前: Round 1, 2, 3 (当前)
# 回滚到Round 1

# 回滚后:
# - Round 1: completed (当前)
# - Round 2: rolled_back (保留数据)
# - Round 3: rolled_back (保留数据)

# 可以重新处理
init-round --round 4  # 从Round 1分支出Round 4
```

### 4. Changelog自动记录

**触发时机**:
1. `initialize_round()` → 记录"初始化"
2. `mark_round_status()` → 记录状态变更（"开始处理", "完成", "失败"）
3. `rollback_to_round()` → 记录"回滚（已作废）"

**记录内容**:
```json
{
  "round_number": 2,
  "timestamp": "2025-11-12T14:30:00.123456",
  "action": "完成",
  "processing_mode": "incremental",
  "trigger_reason": "补充判决文书",
  "fields_updated": ["judgment_document"],
  "impact_analysis": {
    "affected_stages": [1, 2, 3],
    "affected_sections": [1, 2, 3],
    "time_savings_percent": 60
  },
  "status": "completed"
}
```

**查看方式**:
- 原始JSON: 读取`.changelog.json`文件
- 格式化摘要: `show-changelog`命令
- 编程接口: `RoundManager.read_changelog()`

### 5. 补充清单生成

**生成逻辑**:
1. 读取轮次元数据中的`fields_updated`
2. 查询每个字段的优先级和所需材料
3. 按优先级分组（CRITICAL/HIGH/MEDIUM/LOW）
4. 生成Markdown格式清单
5. 添加处理建议和下一步操作

**清单结构**:
```markdown
# 补充材料清单 - Round N

## 补充材料清单概览
- 字段数量
- 处理模式
- 触发原因

## 🔴 关键字段（必须补充）
- 字段1
  - 说明
  - 所需材料（checklist）

## 🟠 高优先级字段
...

## 🟡 中优先级字段
...

## 🟢 低优先级字段
...

## 处理建议
- 优先级说明
- 下一步操作
```

**用途**:
- 指导用户收集补充材料
- 与客户沟通缺失材料
- 项目管理和进度追踪

---

## 最佳实践

### 1. 初次使用

**✅ 推荐做法**:
```bash
# 1. 先进行影响分析（即使是Round 1）
analyze --file "initial_materials.json"

# 2. 初始化Round 1
init-round --round 1

# 3. 按标准流程处理
Stage 1 → Stage 2 → Stage 3

# 4. 标记完成
mark-status --round 1 --status completed
```

**❌ 避免**:
- 跳过环境初始化直接处理
- Round 1使用Incremental/Partial模式
- 不记录处理状态

### 2. 补充材料处理

**✅ 推荐做法**:
```bash
# 1. 先准备补充材料文件
# supplemental.json: 只包含变更的字段

# 2. 影响分析
analyze --file "supplemental.json"
# 确认推荐的处理模式

# 3. 生成补充清单（可选）
generate-checklist --round N

# 4. 初始化新轮次
init-round --round N

# 5. 增量处理（Agent自动根据模式处理）

# 6. 验证
show-history  # 检查历史
show-changelog  # 检查Changelog
```

**❌ 避免**:
- 跳过影响分析直接初始化
- 补充材料包含所有字段（应只包含变更字段）
- 手动指定处理模式（应由系统推荐）

### 3. 批量处理

**✅ 推荐做法**:
```bash
# 场景: 5个债权人都需要补充判决文书

# 1. 准备所有补充材料
补充材料/
├── 100-公司A_supplemental.json
├── 101-公司B_supplemental.json
├── 102-公司C_supplemental.json
├── 103-公司D_supplemental.json
└── 104-公司E_supplemental.json

# 2. 批量影响分析
batch-analyze --batch 1 --supplemental-dir "补充材料/"

# 3. 批量初始化
batch-init --batch 1 --round 2

# 4. 阶段级并行处理（使用Task工具）
# Stage 1: 5个debt-fact-checker并行
# Stage 2: 5个debt-claim-analyzer并行
# Stage 3: 5个report-organizer并行

# 5. 批量验证
batch-status --batch 1
```

**预计效率**:
- 串行处理: 5 × 80分钟 = 400分钟
- 阶段级并行: 1 × 80分钟 + 初始化开销 ≈ 90分钟
- 时间节省: 77.5%

**❌ 避免**:
- 串行处理多个债权人（债权人数≥2时）
- 跨阶段并行（Stage依赖关系）
- 混用不同批次的债权人

### 4. 错误恢复

**场景1: Stage 2处理失败**
```bash
# 1. 检查错误日志
less 输出/第1批债权/100-公司A/round_2/processing.log

# 2. 修复问题后，标记失败
mark-status --round 2 --status failed

# 3. 重新初始化（Round 3）
init-round --round 3

# 4. 重新处理
```

**场景2: 发现前轮数据错误**
```bash
# 1. 回滚到正确的轮次
rollback --target-round 1 --reason "发现Round 2数据有误"

# 2. 修复数据

# 3. 重新处理（作为Round 4，而非Round 2）
init-round --round 4

# 4. 验证
show-history --include-rolled-back  # 查看完整历史
```

**场景3: 并行处理部分失败**
```bash
# 假设5个债权人中2个失败

# 1. 检查批量状态
batch-status --batch 1

# 2. 只处理失败的债权人
batch-init --batch 1 --round 2 --filter 102,104

# 3. 重新处理失败的债权人
```

### 5. 质量控制

**检查点1: 初始化后**
```bash
# 验证目录结构
ls -la 输出/第1批债权/100-公司A/round_N/

# 验证元数据
cat round_N/.round_metadata.json | jq '.'

# 验证Changelog
show-changelog
```

**检查点2: 每个Stage完成后**
```bash
# 验证输出文件存在
ls 工作底稿/  # Stage 1和2
ls 计算文件/  # Stage 2
ls 最终报告/  # Stage 3

# 验证文件大小（不为空）
du -sh round_N/*

# 验证状态更新
show-history
```

**检查点3: 完成后**
```bash
# 验证Changelog完整
show-changelog

# 验证历史记录
show-history

# 验证文件组织
tree 输出/第1批债权/100-公司A/

# 生成补充清单（如需要）
generate-checklist --round N
```

### 6. 性能优化

**优化1: 使用批量命令**
```bash
# ❌ 低效
for i in 100 101 102 103 104; do
    init-round --number $i --round 2
done

# ✅ 高效
batch-init --batch 1 --round 2 --filter 100,101,102,103,104
```

**优化2: 选择性处理**
```bash
# 场景: 10个债权人，只有3个需要补充

# ❌ 处理所有
batch-init --batch 1 --round 2

# ✅ 只处理需要的
batch-init --batch 1 --round 2 --filter 100,103,107
```

**优化3: 合理使用处理模式**
```bash
# ❌ 总是使用Full模式
# 浪费时间，没有利用增量优势

# ✅ 信任影响分析推荐
analyze → 推荐Incremental → 使用Incremental
```

---

## 故障排除

### 常见问题

#### Q1: "目标轮次X必须小于当前轮次Y"

**原因**: 尝试回滚到当前或未来轮次

**解决**:
```bash
# 检查当前轮次
show-history

# 回滚到更早的轮次
rollback --target-round <小于当前轮次的数字>
```

#### Q2: "轮次X不存在"

**原因**: 指定的轮次号不存在

**解决**:
```bash
# 检查已有轮次
show-history

# 初始化正确的轮次
# 如果当前是Round 2，新轮次应该是Round 3
init-round --round 3
```

#### Q3: ".round_metadata.json not found"

**原因**: 未正确初始化轮次环境

**解决**:
```bash
# 重新初始化
init-round --batch X --number Y --name "债权人" --round N
```

#### Q4: "目标轮次X已被回滚，无法回滚到已作废的轮次"

**原因**: 尝试回滚到已经标记为`rolled_back`的轮次

**解决**:
```bash
# 查看哪些轮次是活跃的
show-history --exclude-rolled-back

# 回滚到活跃轮次
rollback --target-round <活跃轮次>
```

#### Q5: "补充材料文件不存在"

**原因**: `batch-analyze`找不到对应的补充材料文件

**解决**:
```bash
# 检查文件命名格式
# 必须是: {编号:03d}-{债权人名称}_supplemental.json
# 示例: 100-某某公司_supplemental.json

# 检查文件是否存在
ls 补充材料/

# 检查目录路径
batch-analyze --supplemental-dir "完整路径/补充材料/"
```

### 诊断工具

#### 检查系统状态
```bash
# 检查批次状态
batch-status --batch 1

# 检查单个债权人状态
show-history --batch 1 --number 100 --name "公司A"

# 检查Changelog
show-changelog --batch 1 --number 100 --name "公司A"
```

#### 检查文件完整性
```bash
# 检查目录结构
tree 输出/第1批债权/100-公司A/

# 检查必需文件
ls -la round_N/.round_metadata.json
ls -la .current_round.json
ls -la .changelog.json

# 检查文件大小
du -sh round_N/*
```

#### 查看原始数据
```bash
# 查看元数据
cat round_N/.round_metadata.json | jq '.'

# 查看Changelog
cat .changelog.json | jq '.changelog'

# 查看当前轮次追踪
cat .current_round.json | jq '.'
```

### 紧急恢复

#### 场景1: Changelog损坏

```bash
# 1. 备份损坏文件
cp .changelog.json .changelog.json.bak

# 2. 手动重建（基于轮次元数据）
python -c "
from src.round_manager import RoundManager
from pathlib import Path

manager = RoundManager(Path('输出/第1批债权/100-公司A'))

# 重新扫描所有轮次
for i in range(1, 10):
    if manager.round_exists(i):
        manager.update_changelog(i, action='重建')
"

# 3. 验证
show-changelog
```

#### 场景2: 当前轮次追踪丢失

```bash
# 1. 手动重建
python -c "
from pathlib import Path
import json

base_path = Path('输出/第1批债权/100-公司A')

# 查找最大轮次号
rounds = sorted(base_path.glob('round_*'))
if rounds:
    max_round = max([int(r.name.split('_')[1]) for r in rounds])

    # 重建追踪文件
    data = {
        'current_round': max_round,
        'total_rounds': max_round,
        'latest_report_path': None,
        'last_updated': '2025-11-12T00:00:00'
    }

    with open(base_path / '.current_round.json', 'w') as f:
        json.dump(data, f, indent=2)

    print(f'重建成功: 当前轮次={max_round}')
"

# 2. 验证
show-history
```

---

## 附录

### A. 字段优先级完整列表

详见: `config/field_priorities.py`

**CRITICAL (5个)**:
1. bankruptcy_date - 破产受理日期
2. interest_stop_date - 停止计息日期
3. legal_relationship_type - 法律关系类型
4. debt_nature - 债权性质
5. statute_of_limitations_status - 诉讼时效状态

**HIGH (7个)**:
1. judgment_document - 生效法律文书
2. guarantee_type - 担保方式
3. principal_confirmation_evidence - 本金确认证据
4. contract_validity - 合同效力
5. performance_evidence - 履行证据
6. debtor_info - 债务人信息
7. guarantor_info - 担保人信息

**MEDIUM (17个)**:
1. payment_deadline - 付款期限
2. interest_rate_clause - 利率约定
3. liquidated_damages_clause - 违约金条款
4. penalty_interest_clause - 罚息条款
5. overdue_interest_clause - 逾期利息条款
6. compound_interest_clause - 复利条款
7. declared_principal - 申报本金
8. declared_interest - 申报利息
9. declared_liquidated_damages - 申报违约金
10. declared_penalty_interest - 申报罚息
11. declared_overdue_interest - 申报逾期利息
12. declared_compound_interest - 申报复利
13. guarantee_scope - 担保范围
14. guarantee_period - 担保期间
15. collateral_description - 抵押物描述
16. collateral_value - 抵押物价值
17. priority_claim_basis - 优先权依据

**LOW (9个)**:
1. notes - 备注说明
2. creditor_contact - 债权人联系方式
3. agent_info - 代理人信息
4. payment_account - 付款账户
5. dispute_status - 争议状态
6. attachment_list - 附件清单
7. submission_date - 提交日期
8. review_deadline - 审查期限
9. special_instructions - 特殊说明

### B. 影响映射表

详见: `config/impact_mappings.py`

**Stage影响**:
- Stage 1: 事实核查（法律关系、证据、时间线）
- Stage 2: 债权分析（金额、利息、时效）
- Stage 3: 报告整理（格式、审核、交付）

**章节影响**:
- 第1章: 债权人及代理人基本信息
- 第2章: 法律关系认定
- 第3章: 债权金额确认
- 第4章: 担保债权审查
- 第5章: 诉讼时效分析
- 第6章: 备注说明

**债权项影响**:
- 本金
- 利息
- 违约金
- 逾期利息
- 罚息
- 复利
- 担保债权
- 保证债权

### C. 处理模式对比

| 特征 | Full | Incremental | Partial |
|------|------|-------------|---------|
| **触发条件** | CRITICAL字段 | HIGH/MEDIUM字段 | LOW字段 |
| **处理范围** | 全部Stage和章节 | 受影响Stage和章节 | 特定字段所在章节 |
| **时间节省** | 0% (基准) | 40-75% | 85%+ |
| **适用场景** | 首次处理、关键变更 | 补充证据、合同变更 | 微调备注、更新联系方式 |
| **风险等级** | 最低 | 中等 | 最低（仅改备注） |
| **Agent负载** | 最高 | 中等 | 最低 |

### D. 时间节省预估公式

**Incremental模式**:
```python
总Stage数 = 3
受影响Stage数 = len(affected_stages)
跳过Stage数 = 总Stage数 - 受影响Stage数

基础节省 = (跳过Stage数 / 总Stage数) * 100

# 特殊情况：所有Stage都受影响但Stage内部增量
if 基础节省 == 0:
    基础节省 = 50  # Stage内部增量处理

# 根据字段数量微调
if 字段数 > 5:
    调整 = -10
elif 字段数 > 3:
    调整 = -5
else:
    调整 = 0

最终节省 = max(40, min(75, 基础节省 + 调整))
```

**Partial模式**:
```python
# 固定节省
最终节省 = 85
```

### E. 常用命令速查

```bash
# 初始化
init-round --batch 1 --number 100 --name "公司A" --round 1

# 影响分析
analyze --batch 1 --number 100 --name "公司A" --file "补充材料.json"

# 查看历史
show-history --batch 1 --number 100 --name "公司A"

# 查看Changelog
show-changelog --batch 1 --number 100 --name "公司A"

# 生成清单
generate-checklist --batch 1 --number 100 --name "公司A" --round 2

# 回滚
rollback --batch 1 --number 100 --name "公司A" --target-round 1 --reason "原因"

# 批量状态
batch-status --batch 1

# 批量初始化
batch-init --batch 1 --round 2 [--filter 100,101,102]

# 批量分析
batch-analyze --batch 1 --supplemental-dir "补充材料/"
```

### F. 文件清单

**债权人目录结构**:
```
输出/第X批债权/{编号}-{债权人名称}/
├── .current_round.json          # 当前轮次追踪
├── .changelog.json              # 变更日志
├── round_1/                     # 第1轮
│   ├── .round_metadata.json     # 轮次元数据
│   ├── 工作底稿/
│   │   ├── {债权人}_事实核查报告.md
│   │   └── {债权人}_债权分析报告.md
│   ├── 最终报告/
│   │   └── GY2025_{债权人}_债权审查报告_{日期}.md
│   └── 计算文件/
│       └── {债权人}_{类型}.xlsx 或 无需计算说明.txt
├── round_2/                     # 第2轮
│   └── ...
├── round_N_supplemental_checklist.md  # 补充清单（可选）
└── 并行处理prompts/             # 并行任务审计（可选）
    ├── stage1_creditor{编号}_{债权人}_prompt.txt
    ├── stage2_creditor{编号}_{债权人}_prompt.txt
    └── stage3_creditor{编号}_{债权人}_prompt.txt
```

### G. 系统限制

**轮次数量**: 无硬性限制，建议≤10轮（过多轮次影响可读性）

**批次大小**: 无硬性限制，建议每批≤50个债权人

**并行度**: 取决于系统资源，建议≤10个并行Agent

**文件大小**:
- 单个报告: ≤5MB
- 补充材料JSON: ≤1MB
- Changelog: 随轮次数增长，通常<100KB

**字段数量**: 38个预定义字段（可扩展）

### H. 版本历史

**v2.0** (2025-11-12)
- ✅ 完整三模式支持（Full/Incremental/Partial）
- ✅ Changelog自动记录
- ✅ 补充清单生成
- ✅ 批量处理优化
- ✅ 安全回滚机制
- ✅ 完整集成测试（12个场景）

**v1.0** (2025-10-29)
- ✅ 基础轮次管理
- ✅ Full和Incremental模式
- ✅ 影响分析器
- ✅ MVP测试场景

### I. 联系和支持

**项目位置**: `/root/debt_review_skills/`

**核心文件**:
- `src/multi_round_controller.py` - 主控制器
- `src/round_manager.py` - 轮次管理器
- `src/impact_analyzer.py` - 影响分析器
- `config/field_priorities.py` - 字段优先级
- `config/impact_mappings.py` - 影响映射表

**测试文件**:
- `tests/test_integration_complete.py` - 完整集成测试（12场景）
- `tests/test_week*` - 各周功能测试

**文档**:
- `MULTI_ROUND_USER_GUIDE.md` - 原系统用户指南
- `MULTI_ROUND_USER_MANUAL.md` - 本手册
- `INCREMENTAL_PROCESSING_GUIDE.md` - 增量处理指南
- `PARTIAL_PROCESSING_GUIDE.md` - Partial模式指南

---

**手册结束**

*本手册最后更新于2025-11-12，适用于多轮债权审查系统v2.0*
